<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomous Month-End Close - Interactive Prototype</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .card h3 {
            color: #667eea;
            margin: 20px 0 10px 0;
            font-size: 18px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .input-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-high-risk {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-medium-risk {
            background: #fed7aa;
            color: #92400e;
        }
        
        .status-low-risk {
            background: #d1fae5;
            color: #065f46;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        table tr:hover {
            background: #f9fafb;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #666;
            font-weight: 600;
        }
        
        .metric-value {
            color: #333;
            font-weight: 600;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: width 0.5s ease;
        }
        
        .risk-score {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        
        .risk-low { color: #10b981; }
        .risk-medium { color: #f59e0b; }
        .risk-high { color: #ef4444; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .approval-item {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .approval-item h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .approval-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        
        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        .data-entry-area {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .sample-data-btn {
            background: #8b5cf6;
            color: white;
        }
        
        .sample-data-btn:hover {
            background: #7c3aed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Autonomous Month-End Close</h1>
            <p>Interactive browser-based prototype for automated financial close process with reconciliation, accruals, and approval workflows</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('reconciliation')">üîç Reconciliation</button>
            <button class="tab" onclick="showTab('accruals')">üìä Accrual Postings</button>
            <button class="tab" onclick="showTab('statements')">üìà Financial Statements</button>
            <button class="tab" onclick="showTab('close')">üéØ Automated Close</button>
            <button class="tab" onclick="showTab('approval')">‚úÖ Approval Workflow</button>
        </div>
        
        <!-- Reconciliation Tab -->
        <div id="reconciliation" class="tab-content active">
            <div class="card">
                <h2>Autonomous Reconciliation</h2>
                <p style="color: #666; margin-bottom: 20px;">Automatically match GL transactions with bank statements and identify discrepancies</p>
                
                <div class="data-entry-area">
                    <h3>General Ledger Data</h3>
                    <textarea id="glData" placeholder="Paste CSV data or click 'Load Sample Data'&#10;Format: date,reference,description,amount"></textarea>
                    
                    <h3>Bank Statement Data</h3>
                    <textarea id="bankData" placeholder="Paste CSV data or click 'Load Sample Data'&#10;Format: date,reference,description,amount"></textarea>
                    
                    <button class="btn sample-data-btn" onclick="loadSampleReconciliationData()">Load Sample Data</button>
                    <button class="btn btn-primary" onclick="performReconciliation()">Run Reconciliation</button>
                    <button class="btn btn-secondary" onclick="clearReconciliationData()">Clear</button>
                </div>
                
                <div id="reconciliationResults" class="hidden">
                    <h3>Reconciliation Summary</h3>
                    <div id="reconciliationSummary"></div>
                    
                    <h3>Matched Transactions</h3>
                    <div id="matchedTransactions"></div>
                    
                    <h3>Unmatched GL Transactions</h3>
                    <div id="unmatchedGL"></div>
                    
                    <h3>Unmatched Bank Transactions</h3>
                    <div id="unmatchedBank"></div>
                    
                    <h3>Discrepancies</h3>
                    <div id="discrepancies"></div>
                </div>
            </div>
        </div>
        
        <!-- Accruals Tab -->
        <div id="accruals" class="tab-content">
            <div class="card">
                <h2>Intelligent Accrual Postings</h2>
                <p style="color: #666; margin-bottom: 20px;">Calculate and generate journal entries for interest, depreciation, and expense accruals</p>
                
                <div class="grid">
                    <div class="card" style="box-shadow: none; padding: 15px; background: #f9fafb;">
                        <h3>Interest Accrual</h3>
                        <div class="input-group">
                            <label>Principal Amount (¬£)</label>
                            <input type="number" id="interestPrincipal" value="100000" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Annual Rate (%)</label>
                            <input type="number" id="interestRate" value="5" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Months</label>
                            <input type="number" id="interestMonths" value="1" min="1">
                        </div>
                        <button class="btn btn-primary" onclick="calculateInterest()">Calculate</button>
                    </div>
                    
                    <div class="card" style="box-shadow: none; padding: 15px; background: #f9fafb;">
                        <h3>Depreciation Accrual</h3>
                        <div class="input-group">
                            <label>Asset Cost (¬£)</label>
                            <input type="number" id="assetCost" value="50000" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Salvage Value (¬£)</label>
                            <input type="number" id="salvageValue" value="5000" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Useful Life (Years)</label>
                            <input type="number" id="usefulLife" value="5" min="1">
                        </div>
                        <button class="btn btn-primary" onclick="calculateDepreciation()">Calculate</button>
                    </div>
                    
                    <div class="card" style="box-shadow: none; padding: 15px; background: #f9fafb;">
                        <h3>Expense Accrual</h3>
                        <div class="input-group">
                            <label>Expense Name</label>
                            <input type="text" id="expenseName" value="Insurance">
                        </div>
                        <div class="input-group">
                            <label>Annual Amount (¬£)</label>
                            <input type="number" id="annualAmount" value="12000" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Months</label>
                            <input type="number" id="expenseMonths" value="1" min="1">
                        </div>
                        <button class="btn btn-primary" onclick="calculateExpense()">Calculate</button>
                    </div>
                </div>
                
                <div id="accrualResults" class="hidden">
                    <h3>Generated Journal Entries</h3>
                    <div id="journalEntries"></div>
                    
                    <h3>Summary</h3>
                    <div id="accrualSummary"></div>
                </div>
            </div>
        </div>
        
        <!-- Financial Statements Tab -->
        <div id="statements" class="tab-content">
            <div class="card">
                <h2>Financial Statement Generation</h2>
                <p style="color: #666; margin-bottom: 20px;">Generate P&L, Balance Sheet, and Cash Flow statements from transaction data</p>
                
                <div class="data-entry-area">
                    <h3>Transaction Data</h3>
                    <textarea id="transactionData" placeholder="Paste CSV data or click 'Load Sample Data'&#10;Format: date,account,description,debit,credit"></textarea>
                    
                    <button class="btn sample-data-btn" onclick="loadSampleTransactions()">Load Sample Data</button>
                    <button class="btn btn-primary" onclick="generateStatements()">Generate Statements</button>
                    <button class="btn btn-secondary" onclick="clearTransactionData()">Clear</button>
                </div>
                
                <div id="statementResults" class="hidden">
                    <h3>Profit & Loss Statement</h3>
                    <div id="plStatement"></div>
                    
                    <h3>Balance Sheet</h3>
                    <div id="balanceSheet"></div>
                    
                    <h3>Summary</h3>
                    <div id="statementSummary"></div>
                </div>
            </div>
        </div>
        
        <!-- Automated Close Tab -->
        <div id="close" class="tab-content">
            <div class="card">
                <h2>Automated Close with Risk Scoring</h2>
                <p style="color: #666; margin-bottom: 20px;">Complete month-end close process with risk assessment</p>
                
                <div class="alert alert-warning">
                    ‚ö†Ô∏è Ensure you have completed Reconciliation, Accruals, and Statements tabs before running the automated close.
                </div>
                
                <button class="btn btn-primary" onclick="runAutomatedClose()">Start Automated Close</button>
                
                <div id="closeProgress" class="hidden">
                    <h3>Process Status</h3>
                    <div class="progress-bar">
                        <div id="closeProgressBar" class="progress-fill" style="width: 0%">0%</div>
                    </div>
                    
                    <div id="closeSteps"></div>
                    
                    <h3>Overall Risk Score</h3>
                    <div id="riskScore" class="risk-score">-</div>
                    <div id="riskAssessment"></div>
                </div>
            </div>
        </div>
        
        <!-- Approval Workflow Tab -->
        <div id="approval" class="tab-content">
            <div class="card">
                <h2>Human Approval Workflow</h2>
                <p style="color: #666; margin-bottom: 20px;">Review and approve each component of the month-end close</p>
                
                <div id="approvalItems">
                    <div class="approval-item">
                        <h4>Reconciliation <span id="reconApprovalStatus" class="status-badge status-pending">Pending</span></h4>
                        <p>Review GL vs Bank reconciliation results</p>
                        <div class="input-group">
                            <label>Comments:</label>
                            <textarea id="reconComments" placeholder="Add your review comments..."></textarea>
                        </div>
                        <div class="approval-actions">
                            <button class="btn btn-success" onclick="approveItem('reconciliation')">Approve</button>
                            <button class="btn btn-danger" onclick="rejectItem('reconciliation')">Reject</button>
                        </div>
                    </div>
                    
                    <div class="approval-item">
                        <h4>Accrual Postings <span id="accrualApprovalStatus" class="status-badge status-pending">Pending</span></h4>
                        <p>Review generated journal entries</p>
                        <div class="input-group">
                            <label>Comments:</label>
                            <textarea id="accrualComments" placeholder="Add your review comments..."></textarea>
                        </div>
                        <div class="approval-actions">
                            <button class="btn btn-success" onclick="approveItem('accruals')">Approve</button>
                            <button class="btn btn-danger" onclick="rejectItem('accruals')">Reject</button>
                        </div>
                    </div>
                    
                    <div class="approval-item">
                        <h4>Financial Statements <span id="statementApprovalStatus" class="status-badge status-pending">Pending</span></h4>
                        <p>Review P&L and Balance Sheet</p>
                        <div class="input-group">
                            <label>Comments:</label>
                            <textarea id="statementComments" placeholder="Add your review comments..."></textarea>
                        </div>
                        <div class="approval-actions">
                            <button class="btn btn-success" onclick="approveItem('statements')">Approve</button>
                            <button class="btn btn-danger" onclick="rejectItem('statements')">Reject</button>
                        </div>
                    </div>
                </div>
                
                <h3>Approval History</h3>
                <div id="approvalHistory"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        const state = {
            reconciliation: null,
            accruals: [],
            statements: null,
            approvals: {},
            approvalHistory: []
        };

        // Tab navigation
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Utility functions
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            
            return data;
        }

        function formatCurrency(amount) {
            return '¬£' + parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function safeFloat(value) {
            const parsed = parseFloat(value);
            return isNaN(parsed) ? 0 : parsed;
        }

        // Reconciliation functions
        function loadSampleReconciliationData() {
            document.getElementById('glData').value = `date,reference,description,amount
2024-12-01,REF001,Customer Payment - ABC Corp,15000.00
2024-12-05,REF002,Supplier Payment - XYZ Ltd,-5000.00
2024-12-10,REF003,Customer Payment - DEF Inc,8500.00
2024-12-15,REF004,Rent Payment,-3000.00
2024-12-20,REF005,Customer Payment - GHI Co,12000.00
2024-12-22,REF006,Utilities Payment,-500.00
2024-12-25,REF007,Sales - JKL Corp,6500.00
2024-12-28,REF008,Equipment Purchase,-8000.00
2024-12-30,REF009,Employee Salaries,-10000.00`;

            document.getElementById('bankData').value = `date,reference,description,amount
2024-12-01,REF001,ABC Corp deposit,15000.00
2024-12-05,REF002,Payment to XYZ Ltd,-5000.00
2024-12-10,REF003,DEF Inc payment,8500.00
2024-12-15,REF004,Rent - December,-3000.00
2024-12-20,REF005,GHI Co transfer,12000.00
2024-12-22,REF006,Utility bill payment,-500.00
2024-12-25,REF007,JKL Corp deposit,6500.00
2024-12-28,REF008,Equipment vendor,-8000.00
2024-12-31,REF010,Interest income,250.00`;
        }

        function clearReconciliationData() {
            document.getElementById('glData').value = '';
            document.getElementById('bankData').value = '';
            document.getElementById('reconciliationResults').classList.add('hidden');
        }

        function performReconciliation() {
            const glData = parseCSV(document.getElementById('glData').value);
            const bankData = parseCSV(document.getElementById('bankData').value);
            
            if (glData.length === 0 || bankData.length === 0) {
                alert('Please enter both GL and Bank data');
                return;
            }
            
            const matched = [];
            const unmatchedGL = [...glData];
            const unmatchedBank = [...bankData];
            const discrepancies = [];
            const tolerance = 0.01;
            
            glData.forEach(glTx => {
                const glAmount = safeFloat(glTx.amount);
                const glDate = glTx.date;
                const glDesc = (glTx.description || '').toLowerCase();
                const glRef = glTx.reference;
                
                let matchFound = false;
                
                for (let i = unmatchedBank.length - 1; i >= 0; i--) {
                    const bankTx = unmatchedBank[i];
                    const bankAmount = safeFloat(bankTx.amount);
                    const bankDate = bankTx.date;
                    const bankDesc = (bankTx.description || '').toLowerCase();
                    const bankRef = bankTx.reference;
                    
                    const amountMatch = Math.abs(glAmount - bankAmount) <= tolerance;
                    const dateMatch = glDate === bankDate;
                    const refMatch = (glRef && glRef === bankRef) || 
                                   (glDesc && bankDesc && glDesc.includes(bankDesc)) ||
                                   (bankDesc && glDesc && bankDesc.includes(glDesc));
                    
                    if (amountMatch && (dateMatch || refMatch)) {
                        matched.push({
                            gl: glTx,
                            bank: bankTx,
                            confidence: dateMatch && refMatch ? 'High' : 'Medium'
                        });
                        
                        const glIndex = unmatchedGL.findIndex(tx => 
                            tx.reference === glTx.reference && tx.amount === glTx.amount
                        );
                        if (glIndex >= 0) unmatchedGL.splice(glIndex, 1);
                        unmatchedBank.splice(i, 1);
                        matchFound = true;
                        break;
                    }
                }
                
                if (!matchFound && glAmount !== 0) {
                    bankData.forEach(bankTx => {
                        const bankAmount = safeFloat(bankTx.amount);
                        if (Math.abs(Math.abs(glAmount) - Math.abs(bankAmount)) < 100 && 
                            Math.abs(glAmount - bankAmount) > tolerance) {
                            discrepancies.push({
                                gl: glTx,
                                bank: bankTx,
                                difference: glAmount - bankAmount
                            });
                        }
                    });
                }
            });
            
            const totalGLAmount = glData.reduce((sum, tx) => sum + safeFloat(tx.amount), 0);
            const totalBankAmount = bankData.reduce((sum, tx) => sum + safeFloat(tx.amount), 0);
            const matchedAmount = matched.reduce((sum, m) => sum + safeFloat(m.gl.amount), 0);
            const reconPercentage = glData.length > 0 ? (matched.length / glData.length * 100).toFixed(2) : 0;
            
            state.reconciliation = {
                matched,
                unmatchedGL,
                unmatchedBank,
                discrepancies,
                summary: {
                    totalGL: glData.length,
                    totalBank: bankData.length,
                    matched: matched.length,
                    unmatchedGL: unmatchedGL.length,
                    unmatchedBank: unmatchedBank.length,
                    discrepancies: discrepancies.length,
                    totalGLAmount,
                    totalBankAmount,
                    matchedAmount,
                    reconPercentage
                }
            };
            
            displayReconciliationResults();
        }

        function displayReconciliationResults() {
            const { matched, unmatchedGL, unmatchedBank, discrepancies, summary } = state.reconciliation;
            
            document.getElementById('reconciliationSummary').innerHTML = `
                <div class="metric"><span class="metric-label">Total GL Transactions:</span><span class="metric-value">${summary.totalGL}</span></div>
                <div class="metric"><span class="metric-label">Total Bank Transactions:</span><span class="metric-value">${summary.totalBank}</span></div>
                <div class="metric"><span class="metric-label">Matched Transactions:</span><span class="metric-value">${summary.matched}</span></div>
                <div class="metric"><span class="metric-label">Unmatched GL:</span><span class="metric-value">${summary.unmatchedGL}</span></div>
                <div class="metric"><span class="metric-label">Unmatched Bank:</span><span class="metric-value">${summary.unmatchedBank}</span></div>
                <div class="metric"><span class="metric-label">Discrepancies:</span><span class="metric-value">${summary.discrepancies}</span></div>
                <div class="metric"><span class="metric-label">Reconciliation Rate:</span><span class="metric-value">${summary.reconPercentage}%</span></div>
                <div class="metric"><span class="metric-label">Total GL Amount:</span><span class="metric-value">${formatCurrency(summary.totalGLAmount)}</span></div>
                <div class="metric"><span class="metric-label">Total Bank Amount:</span><span class="metric-value">${formatCurrency(summary.totalBankAmount)}</span></div>
            `;
            
            document.getElementById('matchedTransactions').innerHTML = matched.length > 0 ? `
                <table>
                    <thead><tr><th>Date</th><th>Reference</th><th>Description</th><th>Amount</th><th>Confidence</th></tr></thead>
                    <tbody>${matched.map(m => `
                        <tr>
                            <td>${m.gl.date}</td>
                            <td>${m.gl.reference}</td>
                            <td>${m.gl.description}</td>
                            <td>${formatCurrency(m.gl.amount)}</td>
                            <td><span class="status-badge status-${m.confidence === 'High' ? 'low-risk' : 'medium-risk'}">${m.confidence}</span></td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>No matched transactions</p>';
            
            document.getElementById('unmatchedGL').innerHTML = unmatchedGL.length > 0 ? `
                <table>
                    <thead><tr><th>Date</th><th>Reference</th><th>Description</th><th>Amount</th></tr></thead>
                    <tbody>${unmatchedGL.map(tx => `
                        <tr>
                            <td>${tx.date}</td>
                            <td>${tx.reference}</td>
                            <td>${tx.description}</td>
                            <td>${formatCurrency(tx.amount)}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>No unmatched GL transactions</p>';
            
            document.getElementById('unmatchedBank').innerHTML = unmatchedBank.length > 0 ? `
                <table>
                    <thead><tr><th>Date</th><th>Reference</th><th>Description</th><th>Amount</th></tr></thead>
                    <tbody>${unmatchedBank.map(tx => `
                        <tr>
                            <td>${tx.date}</td>
                            <td>${tx.reference}</td>
                            <td>${tx.description}</td>
                            <td>${formatCurrency(tx.amount)}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>No unmatched bank transactions</p>';
            
            document.getElementById('discrepancies').innerHTML = discrepancies.length > 0 ? `
                <table>
                    <thead><tr><th>GL Ref</th><th>GL Amount</th><th>Bank Ref</th><th>Bank Amount</th><th>Difference</th></tr></thead>
                    <tbody>${discrepancies.map(d => `
                        <tr>
                            <td>${d.gl.reference}</td>
                            <td>${formatCurrency(d.gl.amount)}</td>
                            <td>${d.bank.reference}</td>
                            <td>${formatCurrency(d.bank.amount)}</td>
                            <td><span class="status-badge status-high-risk">${formatCurrency(d.difference)}</span></td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>No discrepancies found</p>';
            
            document.getElementById('reconciliationResults').classList.remove('hidden');
        }

        // Accrual functions
        function calculateInterest() {
            const principal = safeFloat(document.getElementById('interestPrincipal').value);
            const rate = safeFloat(document.getElementById('interestRate').value) / 100;
            const months = parseInt(document.getElementById('interestMonths').value);
            
            const monthlyRate = rate / 12;
            const amount = principal * monthlyRate * months;
            
            const accrual = {
                type: 'Interest Accrual',
                principal,
                rate: rate * 100,
                months,
                amount: amount.toFixed(2),
                debitAccount: '7200',
                creditAccount: '2300',
                date: new Date().toISOString().split('T')[0]
            };
            
            state.accruals.push(accrual);
            displayAccrualResults();
        }

        function calculateDepreciation() {
            const assetCost = safeFloat(document.getElementById('assetCost').value);
            const salvage = safeFloat(document.getElementById('salvageValue').value);
            const life = parseInt(document.getElementById('usefulLife').value);
            
            const depreciableAmount = assetCost - salvage;
            const annualDepreciation = depreciableAmount / life;
            const monthlyDepreciation = annualDepreciation / 12;
            
            const accrual = {
                type: 'Depreciation Accrual',
                assetCost,
                salvageValue: salvage,
                usefulLife: life,
                amount: monthlyDepreciation.toFixed(2),
                debitAccount: '7100',
                creditAccount: '1500',
                date: new Date().toISOString().split('T')[0]
            };
            
            state.accruals.push(accrual);
            displayAccrualResults();
        }

        function calculateExpense() {
            const name = document.getElementById('expenseName').value;
            const annual = safeFloat(document.getElementById('annualAmount').value);
            const months = parseInt(document.getElementById('expenseMonths').value);
            
            const monthlyAmount = annual / 12;
            const amount = monthlyAmount * months;
            
            const accrual = {
                type: `${name} Accrual`,
                name,
                annualAmount: annual,
                months,
                amount: amount.toFixed(2),
                debitAccount: '6100',
                creditAccount: '2000',
                date: new Date().toISOString().split('T')[0]
            };
            
            state.accruals.push(accrual);
            displayAccrualResults();
        }

        function displayAccrualResults() {
            if (state.accruals.length === 0) return;
            
            const totalDebits = state.accruals.reduce((sum, a) => sum + safeFloat(a.amount), 0);
            const totalCredits = totalDebits;
            const balanced = totalDebits === totalCredits;
            
            document.getElementById('journalEntries').innerHTML = `
                <table>
                    <thead><tr><th>Date</th><th>Type</th><th>Debit Account</th><th>Credit Account</th><th>Amount</th></tr></thead>
                    <tbody>${state.accruals.map(a => `
                        <tr>
                            <td>${a.date}</td>
                            <td>${a.type}</td>
                            <td>${a.debitAccount}</td>
                            <td>${a.creditAccount}</td>
                            <td>${formatCurrency(a.amount)}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            `;
            
            document.getElementById('accrualSummary').innerHTML = `
                <div class="metric"><span class="metric-label">Total Journal Entries:</span><span class="metric-value">${state.accruals.length}</span></div>
                <div class="metric"><span class="metric-label">Total Debits:</span><span class="metric-value">${formatCurrency(totalDebits)}</span></div>
                <div class="metric"><span class="metric-label">Total Credits:</span><span class="metric-value">${formatCurrency(totalCredits)}</span></div>
                <div class="metric"><span class="metric-label">Balanced:</span><span class="metric-value"><span class="status-badge ${balanced ? 'status-approved' : 'status-rejected'}">${balanced ? 'Yes' : 'No'}</span></span></div>
            `;
            
            document.getElementById('accrualResults').classList.remove('hidden');
        }

        // Financial Statements functions
        function loadSampleTransactions() {
            document.getElementById('transactionData').value = `date,account,description,debit,credit
2024-12-01,1000,Cash - Opening Balance,50000.00,0
2024-12-01,3000,Equity - Opening Balance,0,50000.00
2024-12-01,4100,Sales Revenue - ABC Corp,0,15000.00
2024-12-01,1200,Accounts Receivable - ABC,15000.00,0
2024-12-05,5000,Cost of Goods Sold,5000.00,0
2024-12-05,1300,Inventory,0,5000.00
2024-12-05,2000,Accounts Payable - XYZ,0,5000.00
2024-12-05,5000,COGS,5000.00,0
2024-12-10,4100,Sales Revenue - DEF Inc,0,8500.00
2024-12-10,1000,Cash,8500.00,0
2024-12-15,6000,Rent Expense,3000.00,0
2024-12-15,1000,Cash,0,3000.00
2024-12-20,4200,Service Revenue - GHI,0,12000.00
2024-12-20,1200,Accounts Receivable,12000.00,0
2024-12-22,6100,Utilities Expense,500.00,0
2024-12-22,1000,Cash,0,500.00
2024-12-25,4100,Sales Revenue - JKL,0,6500.00
2024-12-25,1000,Cash,6500.00,0
2024-12-28,1500,Equipment,8000.00,0
2024-12-28,1000,Cash,0,8000.00
2024-12-30,6200,Salaries Expense,10000.00,0
2024-12-30,1000,Cash,0,10000.00`;
        }

        function clearTransactionData() {
            document.getElementById('transactionData').value = '';
            document.getElementById('statementResults').classList.add('hidden');
        }

        function generateStatements() {
            const transactions = parseCSV(document.getElementById('transactionData').value);
            
            if (transactions.length === 0) {
                alert('Please enter transaction data');
                return;
            }
            
            const accounts = {};
            
            transactions.forEach(tx => {
                const account = tx.account;
                const debit = safeFloat(tx.debit);
                const credit = safeFloat(tx.credit);
                
                if (!accounts[account]) {
                    accounts[account] = { balance: 0, debits: 0, credits: 0, type: getAccountType(account) };
                }
                
                accounts[account].debits += debit;
                accounts[account].credits += credit;
                
                if (['Asset', 'Expense', 'COGS'].includes(accounts[account].type)) {
                    accounts[account].balance += debit - credit;
                } else {
                    accounts[account].balance += credit - debit;
                }
            });
            
            let revenue = 0, cogs = 0, expenses = 0;
            let assets = 0, liabilities = 0, equity = 0;
            
            const revenueDetails = [], cogsDetails = [], expenseDetails = [];
            const assetDetails = [], liabilityDetails = [], equityDetails = [];
            
            Object.entries(accounts).forEach(([account, data]) => {
                const balance = data.balance;
                
                if (data.type === 'Revenue') {
                    revenue += balance;
                    revenueDetails.push({ account, amount: balance });
                } else if (data.type === 'COGS') {
                    cogs += balance;
                    cogsDetails.push({ account, amount: balance });
                } else if (data.type === 'Expense') {
                    expenses += balance;
                    expenseDetails.push({ account, amount: balance });
                } else if (data.type === 'Asset') {
                    assets += balance;
                    assetDetails.push({ account, amount: balance });
                } else if (data.type === 'Liability') {
                    liabilities += balance;
                    liabilityDetails.push({ account, amount: balance });
                } else if (data.type === 'Equity') {
                    equity += balance;
                    equityDetails.push({ account, amount: balance });
                }
            });
            
            const grossProfit = revenue - cogs;
            const netIncome = grossProfit - expenses;
            const totalEquityWithIncome = equity + netIncome;
            const balanced = Math.abs(assets - (liabilities + totalEquityWithIncome)) < 0.01;
            
            state.statements = {
                pl: { revenue, cogs, expenses, grossProfit, netIncome, revenueDetails, cogsDetails, expenseDetails },
                bs: { assets, liabilities, equity, netIncome, totalEquityWithIncome, balanced, assetDetails, liabilityDetails, equityDetails },
                summary: { revenue, netIncome, assets, balanced }
            };
            
            displayStatementResults();
        }

        function getAccountType(account) {
            const firstChar = account.charAt(0);
            if (firstChar === '1') return 'Asset';
            if (firstChar === '2') return 'Liability';
            if (firstChar === '3') return 'Equity';
            if (firstChar === '4') return 'Revenue';
            if (firstChar === '5') return 'COGS';
            if (firstChar === '6' || firstChar === '7') return 'Expense';
            return 'Unknown';
        }

        function displayStatementResults() {
            const { pl, bs } = state.statements;
            
            document.getElementById('plStatement').innerHTML = `
                <table>
                    <thead><tr><th>Item</th><th>Amount</th></tr></thead>
                    <tbody>
                        <tr><td><strong>Revenue</strong></td><td><strong>${formatCurrency(pl.revenue)}</strong></td></tr>
                        <tr><td>Cost of Goods Sold</td><td>${formatCurrency(pl.cogs)}</td></tr>
                        <tr><td><strong>Gross Profit</strong></td><td><strong>${formatCurrency(pl.grossProfit)}</strong></td></tr>
                        <tr><td>Operating Expenses</td><td>${formatCurrency(pl.expenses)}</td></tr>
                        <tr><td><strong>Net Income</strong></td><td><strong>${formatCurrency(pl.netIncome)}</strong></td></tr>
                    </tbody>
                </table>
            `;
            
            document.getElementById('balanceSheet').innerHTML = `
                <table>
                    <thead><tr><th>Item</th><th>Amount</th></tr></thead>
                    <tbody>
                        <tr><td colspan="2"><strong>Assets</strong></td></tr>
                        <tr><td>Total Assets</td><td>${formatCurrency(bs.assets)}</td></tr>
                        <tr><td colspan="2"><strong>Liabilities</strong></td></tr>
                        <tr><td>Total Liabilities</td><td>${formatCurrency(bs.liabilities)}</td></tr>
                        <tr><td colspan="2"><strong>Equity</strong></td></tr>
                        <tr><td>Opening Equity</td><td>${formatCurrency(bs.equity)}</td></tr>
                        <tr><td>Net Income</td><td>${formatCurrency(bs.netIncome)}</td></tr>
                        <tr><td><strong>Total Equity</strong></td><td><strong>${formatCurrency(bs.totalEquityWithIncome)}</strong></td></tr>
                        <tr><td><strong>Total Liabilities & Equity</strong></td><td><strong>${formatCurrency(bs.liabilities + bs.totalEquityWithIncome)}</strong></td></tr>
                    </tbody>
                </table>
            `;
            
            document.getElementById('statementSummary').innerHTML = `
                <div class="metric"><span class="metric-label">Total Revenue:</span><span class="metric-value">${formatCurrency(pl.revenue)}</span></div>
                <div class="metric"><span class="metric-label">Net Income:</span><span class="metric-value">${formatCurrency(pl.netIncome)}</span></div>
                <div class="metric"><span class="metric-label">Total Assets:</span><span class="metric-value">${formatCurrency(bs.assets)}</span></div>
                <div class="metric"><span class="metric-label">Balance Sheet Balanced:</span><span class="metric-value"><span class="status-badge ${bs.balanced ? 'status-approved' : 'status-rejected'}">${bs.balanced ? 'Yes' : 'No'}</span></span></div>
            `;
            
            document.getElementById('statementResults').classList.remove('hidden');
        }

        // Automated Close functions
        function runAutomatedClose() {
            if (!state.reconciliation || state.accruals.length === 0 || !state.statements) {
                alert('Please complete Reconciliation, Accruals, and Statements tabs first');
                return;
            }
            
            document.getElementById('closeProgress').classList.remove('hidden');
            
            const steps = [
                { name: 'Reconciliation', status: 'completed', risk: calculateReconciliationRisk() },
                { name: 'Accrual Postings', status: 'completed', risk: calculateAccrualRisk() },
                { name: 'Financial Statements', status: 'completed', risk: calculateStatementRisk() },
                { name: 'Final Review', status: 'pending', risk: 'low' }
            ];
            
            let progress = 0;
            const totalSteps = steps.length;
            
            const interval = setInterval(() => {
                progress++;
                const percentage = (progress / totalSteps) * 100;
                document.getElementById('closeProgressBar').style.width = percentage + '%';
                document.getElementById('closeProgressBar').textContent = Math.round(percentage) + '%';
                
                if (progress >= totalSteps) {
                    clearInterval(interval);
                    steps[3].status = 'completed';
                    displayCloseSteps(steps);
                    displayRiskScore(steps);
                } else {
                    displayCloseSteps(steps);
                }
            }, 500);
        }

        function calculateReconciliationRisk() {
            const { summary } = state.reconciliation;
            if (summary.reconPercentage >= 95) return 'low';
            if (summary.reconPercentage >= 80) return 'medium';
            return 'high';
        }

        function calculateAccrualRisk() {
            const totalAmount = state.accruals.reduce((sum, a) => sum + safeFloat(a.amount), 0);
            if (totalAmount < 5000) return 'low';
            if (totalAmount < 10000) return 'medium';
            return 'high';
        }

        function calculateStatementRisk() {
            const { bs } = state.statements;
            return bs.balanced ? 'low' : 'high';
        }

        function displayCloseSteps(steps) {
            document.getElementById('closeSteps').innerHTML = `
                <table>
                    <thead><tr><th>Step</th><th>Status</th><th>Risk Level</th></tr></thead>
                    <tbody>${steps.map(step => `
                        <tr>
                            <td>${step.name}</td>
                            <td><span class="status-badge status-${step.status === 'completed' ? 'approved' : 'pending'}">${step.status.toUpperCase()}</span></td>
                            <td><span class="status-badge status-${step.risk}-risk">${step.risk.toUpperCase()}</span></td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            `;
        }

        function displayRiskScore(steps) {
            const riskScores = { low: 1, medium: 2, high: 3 };
            const totalRisk = steps.reduce((sum, step) => sum + riskScores[step.risk], 0);
            const avgRisk = totalRisk / steps.length;
            
            let overallRisk = 'low';
            let score = 95;
            
            if (avgRisk <= 1.3) {
                overallRisk = 'low';
                score = 95;
            } else if (avgRisk <= 2) {
                overallRisk = 'medium';
                score = 75;
            } else {
                overallRisk = 'high';
                score = 45;
            }
            
            document.getElementById('riskScore').innerHTML = `<span class="risk-${overallRisk}">${score}</span>`;
            document.getElementById('riskScore').className = `risk-score risk-${overallRisk}`;
            
            document.getElementById('riskAssessment').innerHTML = `
                <div class="alert alert-${overallRisk === 'low' ? 'success' : overallRisk === 'medium' ? 'warning' : 'danger'}">
                    <strong>Risk Assessment:</strong> ${overallRisk.toUpperCase()} RISK
                    <br><br>
                    ${overallRisk === 'low' ? '‚úÖ All checks passed. Safe to proceed with approval.' : 
                      overallRisk === 'medium' ? '‚ö†Ô∏è Some issues detected. Review required before approval.' : 
                      'üö® High risk detected. Immediate attention required.'}
                </div>
            `;
        }

        // Approval Workflow functions
        function approveItem(item) {
            const statusIdMap = {
                'reconciliation': 'reconApprovalStatus',
                'accruals': 'accrualApprovalStatus',
                'statements': 'statementApprovalStatus'
            };
            const commentsIdMap = {
                'reconciliation': 'reconComments',
                'accruals': 'accrualComments',
                'statements': 'statementComments'
            };
            
            const statusId = statusIdMap[item];
            const commentsId = commentsIdMap[item];
            
            const status = document.getElementById(statusId);
            if (status) {
                status.className = 'status-badge status-approved';
                status.textContent = 'Approved';
            }
            
            const comments = document.getElementById(commentsId).value;
            
            state.approvals[item] = 'approved';
            state.approvalHistory.push({
                item,
                action: 'approved',
                comments,
                timestamp: new Date().toISOString(),
                user: 'Current User'
            });
            
            updateApprovalHistory();
        }

        function rejectItem(item) {
            const statusIdMap = {
                'reconciliation': 'reconApprovalStatus',
                'accruals': 'accrualApprovalStatus',
                'statements': 'statementApprovalStatus'
            };
            const commentsIdMap = {
                'reconciliation': 'reconComments',
                'accruals': 'accrualComments',
                'statements': 'statementComments'
            };
            
            const statusId = statusIdMap[item];
            const commentsId = commentsIdMap[item];
            
            const status = document.getElementById(statusId);
            if (status) {
                status.className = 'status-badge status-rejected';
                status.textContent = 'Rejected';
            }
            
            const comments = document.getElementById(commentsId).value;
            
            state.approvals[item] = 'rejected';
            state.approvalHistory.push({
                item,
                action: 'rejected',
                comments,
                timestamp: new Date().toISOString(),
                user: 'Current User'
            });
            
            updateApprovalHistory();
        }

        function updateApprovalHistory() {
            const history = state.approvalHistory.reverse();
            
            document.getElementById('approvalHistory').innerHTML = history.length > 0 ? `
                <table>
                    <thead><tr><th>Item</th><th>Action</th><th>User</th><th>Timestamp</th><th>Comments</th></tr></thead>
                    <tbody>${history.map(h => `
                        <tr>
                            <td>${h.item}</td>
                            <td><span class="status-badge status-${h.action === 'approved' ? 'approved' : 'rejected'}">${h.action.toUpperCase()}</span></td>
                            <td>${h.user}</td>
                            <td>${new Date(h.timestamp).toLocaleString()}</td>
                            <td>${h.comments || '-'}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>No approval history yet</p>';
        }
    </script>
</body>
</html>
