<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Tax Calculator & Accounting Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        h1 {
            margin-bottom: 20px;
            color: #0056b3;
        }
        h2 {
            margin-top: 30px;
            margin-bottom: 15px;
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 5px;
        }
        h3 {
            color: #0056b3;
            margin-top: 20px;
        }
        form > div {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"], input[type="text"], input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #fff;
            cursor: pointer;
        }
        input[type="submit"], button {
            background: #0056b3;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        input[type="submit"]:hover, button:hover {
            background: #003f7f;
        }
        button.delete-btn {
            background: #dc3545;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        button.delete-btn:hover {
            background: #c82333;
        }
        button.edit-btn {
            background: #28a745;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        button.edit-btn:hover {
            background: #218838;
        }
        .results {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #f9f9f9;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .entry-form {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        table th, table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        table th {
            background-color: #0056b3;
            color: #fff;
            font-weight: bold;
        }
        table tr:hover {
            background-color: #f5f5f5;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .summary-card {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .summary-card.income {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        .summary-card.expense {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }
        .summary-card.profit {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
        }
        .summary-card h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .summary-card .amount {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }
        .no-entries {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        .year-selector-container {
            margin: 20px 0;
            padding: 15px;
            background: #e8f4f8;
            border-radius: 8px;
            border: 2px solid #0056b3;
        }
        .year-selector-container label {
            font-size: 1.1em;
            font-weight: bold;
            color: #0056b3;
            margin-right: 10px;
        }
        .year-selector-container select {
            font-size: 1em;
            padding: 10px;
            min-width: 150px;
        }
        .data-management-container {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            border: 2px solid #ffc107;
        }
        .data-management-container h2 {
            margin-top: 0;
            color: #856404;
            border-bottom: 2px solid #856404;
        }
        .data-management-container button {
            margin: 5px;
        }
        button.danger-btn {
            background: #dc3545;
        }
        button.danger-btn:hover {
            background: #c82333;
        }
        button.success-btn {
            background: #28a745;
        }
        button.success-btn:hover {
            background: #218838;
        }
        button.info-btn {
            background: #17a2b8;
        }
        button.info-btn:hover {
            background: #138496;
        }
        /* Advanced Tax Planning Styles */
        .advanced-tax-container {
            margin-top: 30px;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 8px;
            border: 2px solid #0056b3;
        }
        .advanced-tax-container h2 {
            margin-top: 0;
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
        }
        details {
            margin: 15px 0;
            padding: 15px;
            background: #fff;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        details[open] {
            border-color: #0056b3;
        }
        summary {
            font-weight: bold;
            font-size: 1.1em;
            color: #0056b3;
            cursor: pointer;
            padding: 10px;
            margin: -15px -15px 15px -15px;
            background: #f8f9fa;
            border-radius: 5px 5px 0 0;
            user-select: none;
        }
        summary:hover {
            background: #e9ecef;
        }
        details[open] summary {
            background: #0056b3;
            color: #fff;
        }
        .help-text {
            color: #666;
            font-size: 0.9em;
            font-style: italic;
            margin-top: 5px;
            display: block;
        }
        .warning-text {
            color: #dc3545;
            font-weight: bold;
            padding: 10px;
            background: #f8d7da;
            border: 1px solid #dc3545;
            border-radius: 4px;
            margin-top: 10px;
        }
        .info-text {
            color: #004085;
            padding: 10px;
            background: #cce5ff;
            border: 1px solid #b8daff;
            border-radius: 4px;
            margin-top: 10px;
        }
        .advanced-result {
            margin-top: 10px;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 5px;
            border-left: 4px solid #0056b3;
        }
        /* Phase 3: Export/Import Styles */
        .export-btn {
            background: #28a745;
            margin-bottom: 5px;
        }
        .export-btn:hover {
            background: #218838;
        }
        .import-btn {
            background: #ffc107;
            color: #000;
        }
        .import-btn:hover {
            background: #e0a800;
        }
        .date-range-filter {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .date-range-filter label {
            display: inline-block;
            margin-right: 10px;
            font-weight: normal;
        }
        .date-range-filter input[type="date"] {
            width: auto;
            display: inline-block;
            margin-right: 15px;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .modal-content h3 {
            margin-top: 0;
        }
        .column-mapping {
            margin: 15px 0;
        }
        .column-mapping-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
            gap: 10px;
        }
        .column-mapping-row label {
            flex: 1;
            font-weight: normal;
        }
        .column-mapping-row select {
            flex: 2;
        }
        .preview-table {
            margin: 15px 0;
            width: 100%;
            border-collapse: collapse;
        }
        .preview-table th,
        .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .preview-table th {
            background: #0056b3;
            color: #fff;
        }
        .preview-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        .error-row {
            background: #f8d7da !important;
        }
        .duplicate-row {
            background: #fff3cd !important;
        }
        .validation-summary {
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .validation-summary.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .validation-summary.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .validation-summary.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        @media print {
            body {
                background: #fff;
            }
            .container {
                max-width: 100%;
                box-shadow: none;
                margin: 0;
                padding: 20px;
            }
            /* Hide interactive elements */
            .section,
            button,
            input,
            select,
            .data-management-container,
            .year-selector-container,
            .advanced-tax-container,
            h1 {
                display: none !important;
            }
            /* Show only printable content */
            #printableReport {
                display: block !important;
            }
            .print-header {
                text-align: center;
                margin-bottom: 30px;
            }
            .print-header h1 {
                display: block !important;
                color: #000;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
            }
            .print-section {
                margin-bottom: 30px;
                page-break-inside: avoid;
            }
            .print-section h2 {
                color: #000;
                border-bottom: 1px solid #000;
            }
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin: 15px 0;
            }
            .print-table th,
            .print-table td {
                border: 1px solid #000;
                padding: 8px;
                text-align: left;
            }
            .print-table th {
                background: #e0e0e0;
                font-weight: bold;
            }
            .print-total {
                font-weight: bold;
                border-top: 2px solid #000;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>UK Tax Calculator & Accounting Manager</h1>

        <!-- Year Selector Section -->
        <div class="year-selector-container">
            <label for="yearSelector">Tax Year:</label>
            <select id="yearSelector" onchange="switchYear()">
                <option value="2026/27">2026/27 (Planning)</option>
                <option value="2025/26" selected>2025/26 (Current)</option>
                <option value="2024/25">2024/25</option>
                <option value="2023/24">2023/24</option>
                <option value="2022/23">2022/23</option>
                <option value="2021/22">2021/22</option>
            </select>
        </div>

        <!-- Income Tracking Section -->
        <div class="section">
            <h2>Income Tracking</h2>
            <div class="entry-form">
                <div>
                    <label for="incomeDate">Date:</label>
                    <input type="date" id="incomeDate">
                </div>
                <div>
                    <label for="incomeDescription">Description:</label>
                    <input type="text" id="incomeDescription" placeholder="e.g., Salary, Freelance Work">
                </div>
                <div>
                    <label for="incomeAmount">Amount (¬£):</label>
                    <input type="number" id="incomeAmount" placeholder="0.00" step="0.01">
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button type="button" onclick="addIncome()">Add Income</button>
                </div>
            </div>
            <div id="incomeList"></div>
        </div>

        <!-- Expense Tracking Section -->
        <div class="section">
            <h2>Expense Tracking</h2>
            <div class="entry-form">
                <div>
                    <label for="expenseDate">Date:</label>
                    <input type="date" id="expenseDate">
                </div>
                <div>
                    <label for="expenseDescription">Description:</label>
                    <input type="text" id="expenseDescription" placeholder="e.g., Office Supplies, Travel">
                </div>
                <div>
                    <label for="expenseAmount">Amount (¬£):</label>
                    <input type="number" id="expenseAmount" placeholder="0.00" step="0.01">
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button type="button" onclick="addExpense()">Add Expense</button>
                </div>
            </div>
            <div id="expenseList"></div>
        </div>

        <!-- Financial Summary Section -->
        <div class="section">
            <h2>Financial Summary</h2>
            <div class="summary-grid">
                <div class="summary-card income">
                    <h4>Total Income</h4>
                    <div class="amount" id="totalIncome">¬£0.00</div>
                </div>
                <div class="summary-card expense">
                    <h4>Total Expenses</h4>
                    <div class="amount" id="totalExpenses">¬£0.00</div>
                </div>
                <div class="summary-card profit">
                    <h4>Net Profit/Loss</h4>
                    <div class="amount" id="netProfit">¬£0.00</div>
                </div>
            </div>
        </div>

        <!-- Ledger Display Section -->
        <div class="section">
            <h2>Detailed Ledger</h2>
            <div id="ledgerDisplay">
                <p class="no-entries">No entries yet. Add income or expenses to see your ledger.</p>
            </div>
        </div>

        <!-- Tax Calculator Section -->
        <div class="section">
            <h2>Tax Calculator</h2>
            <form id="taxForm">
                <div>
                    <label for="category">Select Tax Category:</label>
                    <select id="category" name="category" required onchange="updateTaxFields()">
                        <option value="">-- Select a category --</option>
                        <option value="SoleTrader">Sole Trader</option>
                        <option value="Director">Director</option>
                        <option value="Employee">Employee</option>
                        <option value="Company">Company</option>
                        <option value="Landlords">Landlords</option>
                    </select>
                </div>
                <div>
                    <label for="allowances">Include Personal Allowance (¬£12,570)?</label>
                    <select id="allowances" name="allowances" required>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div>
                    <label for="blindPersonsAllowance">
                        Blind Person's Allowance (¬£3,130)
                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                            - Additional tax-free allowance if registered blind
                        </span>
                    </label>
                    <select id="blindPersonsAllowance" name="blindPersonsAllowance">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div>
                    <label for="marriageAllowance">
                        Marriage/Civil Partnership Allowance (¬£1,260 transfer)
                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                            - Transfer ¬£1,260 to spouse/partner (saves up to ¬£252 in tax)
                        </span>
                    </label>
                    <select id="marriageAllowance" name="marriageAllowance">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div>
                    <label for="tradingAllowance">
                        Trading Allowance (¬£1,000)
                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                            - Tax-free allowance for trading/self-employment income
                        </span>
                    </label>
                    <select id="tradingAllowance" name="tradingAllowance">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div>
                    <label for="propertyAllowance">
                        Property Allowance (¬£1,000)
                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                            - Tax-free allowance for property income
                        </span>
                    </label>
                    <select id="propertyAllowance" name="propertyAllowance">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                
                <!-- Category-Specific Tax Fields -->
                <div id="categorySpecificFields" style="display: none;">
                    <!-- VAT Section -->
                    <div id="vatSection" style="display: none; margin-top: 20px; padding: 15px; background: #e8f4f8; border-radius: 5px;">
                        <h3 style="margin-top: 0; color: #0056b3;">VAT Calculation</h3>
                        <div>
                            <label for="vatRegistered">VAT Registered?</label>
                            <select id="vatRegistered" name="vatRegistered" onchange="toggleVATFields()">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                        <div id="vatFields" style="display: none; margin-top: 10px;">
                            <div style="margin-bottom: 10px;">
                                <label for="vatRate">VAT Rate:</label>
                                <select id="vatRate" name="vatRate">
                                    <option value="0.20">Standard (20%)</option>
                                    <option value="0.05">Reduced (5%)</option>
                                    <option value="0.00">Zero (0%)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PAYE Section -->
                    <div id="payeSection" style="display: none; margin-top: 20px; padding: 15px; background: #f8e8f8; border-radius: 5px;">
                        <h3 style="margin-top: 0; color: #0056b3;">PAYE (Pay As You Earn)</h3>
                        <p style="margin: 0; color: #666; font-size: 0.95em;">
                            PAYE includes Income Tax and National Insurance deducted from salary
                        </p>
                    </div>
                    
                    <!-- Company Tax Section -->
                    <div id="companyTaxSection" style="display: none; margin-top: 20px; padding: 15px; background: #f8f8e8; border-radius: 5px;">
                        <h3 style="margin-top: 0; color: #0056b3;">Corporation Tax</h3>
                        <div>
                            <label for="companyTaxRate">Company Size:</label>
                            <select id="companyTaxRate" name="companyTaxRate">
                                <option value="0.19">Small Profits Rate (19%)</option>
                                <option value="0.25">Main Rate (25%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- CGT Section -->
                    <div id="cgtSection" style="display: none; margin-top: 20px; padding: 15px; background: #e8f8e8; border-radius: 5px;">
                        <h3 style="margin-top: 0; color: #0056b3;">Capital Gains Tax (CGT)</h3>
                        <div>
                            <label for="capitalGains">Capital Gains Amount (¬£):</label>
                            <input type="number" id="capitalGains" name="capitalGains" placeholder="0.00" step="0.01" value="0">
                        </div>
                        <div style="margin-top: 10px;">
                            <label for="cgtType">Asset Type:</label>
                            <select id="cgtType" name="cgtType">
                                <option value="property">Property (18%/28%)</option>
                                <option value="other">Other Assets (10%/20%)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <input type="submit" value="Calculate Tax">
            </form>
            <div class="results" id="results" style="display: none;">
                <h3>Tax Summary</h3>
                <p id="resultCategory"></p>
                <p id="resultIncome"></p>
                <p id="resultExpenses"></p>
                <p id="resultAllowances"></p>
                <p id="resultTaxableIncome"></p>
                <p id="resultTax"></p>
                <div id="resultVAT" style="display: none; margin-top: 15px; padding: 10px; background: #e8f4f8; border-radius: 5px;"></div>
                <div id="resultPAYE" style="display: none; margin-top: 15px; padding: 10px; background: #f8e8f8; border-radius: 5px;"></div>
                <div id="resultCompanyTax" style="display: none; margin-top: 15px; padding: 10px; background: #f8f8e8; border-radius: 5px;"></div>
                <div id="resultCGT" style="display: none; margin-top: 15px; padding: 10px; background: #e8f8e8; border-radius: 5px;"></div>
                
                <!-- Advanced Tax Results -->
                <div id="advancedTaxResults" style="display: none; margin-top: 20px; padding: 15px; background: #e8f4f8; border-radius: 5px; border: 2px solid #0056b3;">
                    <h3 style="margin-top: 0; color: #0056b3;">Advanced Tax Calculations</h3>
                    <div id="resultStudentLoan" style="display: none;" class="advanced-result"></div>
                    <div id="resultPension" style="display: none;" class="advanced-result"></div>
                    <div id="resultChildcare" style="display: none;" class="advanced-result"></div>
                    <div id="resultGiftAid" style="display: none;" class="advanced-result"></div>
                    <div id="resultDividend" style="display: none;" class="advanced-result"></div>
                    <div id="resultSavings" style="display: none;" class="advanced-result"></div>
                </div>
                
                <p id="resultTotalTax" style="font-weight: bold; font-size: 1.2em; margin-top: 15px; padding-top: 15px; border-top: 2px solid #0056b3;"></p>
            </div>
        </div>

        <!-- Advanced Tax Planning Section -->
        <div class="advanced-tax-container">
            <h2>Advanced Tax Planning</h2>
            <p style="color: #666; margin-bottom: 20px;">Configure additional tax calculations and reliefs. These settings will be saved per tax year.</p>

            <!-- Student Loan Repayments -->
            <details>
                <summary>üíº Student Loan Repayments</summary>
                <div>
                    <label for="studentLoanPlan">Student Loan Plan:</label>
                    <select id="studentLoanPlan" name="studentLoanPlan" onchange="updateStudentLoanInfo()">
                        <option value="none">None</option>
                        <option value="plan1">Plan 1 (¬£24,990 threshold @ 9%)</option>
                        <option value="plan2">Plan 2 (¬£27,295 threshold @ 9%)</option>
                        <option value="plan4">Plan 4 (¬£31,395 threshold @ 9%)</option>
                        <option value="plan5">Plan 5 (¬£25,000 threshold @ 9%)</option>
                        <option value="postgrad">Postgraduate Loan (¬£21,000 threshold @ 6%)</option>
                    </select>
                    <span class="help-text">Select your student loan repayment plan type</span>
                    <div id="studentLoanInfo" class="info-text" style="display: none;"></div>
                </div>
            </details>

            <!-- Pension Contributions -->
            <details>
                <summary>üè¶ Pension Contributions</summary>
                <div>
                    <label for="pensionContribType">Contribution Type:</label>
                    <select id="pensionContribType" name="pensionContribType">
                        <option value="none">None</option>
                        <option value="amount">Fixed Amount</option>
                        <option value="percent">Percentage of Salary</option>
                    </select>
                    <span class="help-text">Choose how pension contributions are calculated</span>
                </div>
                <div style="margin-top: 15px;">
                    <label for="employerPension">Employer Contribution (¬£ or %):</label>
                    <input type="number" id="employerPension" name="employerPension" placeholder="0" step="0.01" value="0">
                    <span class="help-text">Employer's pension contribution</span>
                </div>
                <div style="margin-top: 15px;">
                    <label for="employeePension">Employee Contribution (¬£ or %):</label>
                    <input type="number" id="employeePension" name="employeePension" placeholder="0" step="0.01" value="0">
                    <span class="help-text">Your pension contribution</span>
                </div>
                <div style="margin-top: 15px;">
                    <label for="pensionMethod">Employee Contribution Method:</label>
                    <select id="pensionMethod" name="pensionMethod">
                        <option value="relief">Relief at Source (20% automatic relief)</option>
                        <option value="sacrifice">Salary Sacrifice (pre-tax deduction)</option>
                    </select>
                    <span class="help-text">Salary sacrifice gives immediate tax relief; relief at source gives basic rate relief with higher rate claimed later</span>
                </div>
                <div id="pensionWarning" class="warning-text" style="display: none;"></div>
            </details>

            <!-- Childcare Tax Relief -->
            <details>
                <summary>üë∂ Childcare Tax Relief</summary>
                <div>
                    <label for="numChildren">Number of Children:</label>
                    <input type="number" id="numChildren" name="numChildren" placeholder="0" min="0" value="0">
                    <span class="help-text">Number of children eligible for Tax-Free Childcare (under 11, or under 17 if disabled)</span>
                </div>
                <div style="margin-top: 15px;">
                    <label for="numDisabledChildren">Number of Disabled Children:</label>
                    <input type="number" id="numDisabledChildren" name="numDisabledChildren" placeholder="0" min="0" value="0">
                    <span class="help-text">Disabled children get higher relief (¬£4,000 vs ¬£2,000)</span>
                </div>
                <div style="margin-top: 15px;">
                    <label for="childcareExpenses">Annual Childcare Expenses (¬£):</label>
                    <input type="number" id="childcareExpenses" name="childcareExpenses" placeholder="0" step="0.01" value="0">
                    <span class="help-text">Total annual childcare costs</span>
                </div>
                <div id="childcareInfo" class="info-text" style="display: none;"></div>
                <div id="childcareWarning" class="warning-text" style="display: none;"></div>
            </details>

            <!-- Gift Aid -->
            <details>
                <summary>üéÅ Gift Aid Calculator</summary>
                <div>
                    <label for="charitableDonations">Total Charitable Donations (¬£):</label>
                    <input type="number" id="charitableDonations" name="charitableDonations" placeholder="0" step="0.01" value="0">
                    <span class="help-text">Total amount donated to charity (after your tax deduction if applicable)</span>
                </div>
                <div class="info-text" style="margin-top: 15px;">
                    <strong>How Gift Aid works:</strong><br>
                    ‚Ä¢ Charity claims 25p for every ¬£1 you donate (25% on your donation)<br>
                    ‚Ä¢ Higher (40%) and additional (45%) rate taxpayers can claim extra relief<br>
                    ‚Ä¢ If you donate ¬£100, charity gets ¬£125, and you may get extra relief
                </div>
            </details>

            <!-- Dividend Income -->
            <details>
                <summary>üìä Dividend Income</summary>
                <div>
                    <label for="dividendIncome">Annual Dividend Income (¬£):</label>
                    <input type="number" id="dividendIncome" name="dividendIncome" placeholder="0" step="0.01" value="0">
                    <span class="help-text">Total dividend income from shares and investments</span>
                </div>
                <div class="info-text" style="margin-top: 15px;">
                    <strong>Dividend Tax 2025/26:</strong><br>
                    ‚Ä¢ Dividend Allowance: ¬£500 (tax-free)<br>
                    ‚Ä¢ Basic rate (up to ¬£50,270): 8.75%<br>
                    ‚Ä¢ Higher rate (¬£50,271-¬£125,140): 33.75%<br>
                    ‚Ä¢ Additional rate (over ¬£125,140): 39.35%<br>
                    Tax rate depends on your total taxable income band.
                </div>
            </details>

            <!-- Savings Interest -->
            <details>
                <summary>üí∞ Savings Interest</summary>
                <div>
                    <label for="savingsInterest">Annual Savings Interest (¬£):</label>
                    <input type="number" id="savingsInterest" name="savingsInterest" placeholder="0" step="0.01" value="0">
                    <span class="help-text">Total interest from bank accounts, savings accounts, and bonds</span>
                </div>
                <div class="info-text" style="margin-top: 15px;">
                    <strong>Personal Savings Allowance 2025/26:</strong><br>
                    ‚Ä¢ Basic rate taxpayers: ¬£1,000 tax-free<br>
                    ‚Ä¢ Higher rate taxpayers: ¬£500 tax-free<br>
                    ‚Ä¢ Additional rate taxpayers: ¬£0 tax-free<br>
                    ‚Ä¢ Starting Rate for Savings: ¬£5,000 @ 0% (if income under ¬£17,570)<br>
                    Tax rate on interest above allowance matches your income tax band.
                </div>
            </details>
        </div>

        <!-- Data Management Section -->
        <div class="data-management-container">
            <h2>Data Management</h2>
            <p>Manage your tax year data with backup, restore, and export options.</p>
            
            <!-- Date Range Filter -->
            <div class="date-range-filter">
                <h3 style="margin-top: 0;">Date Range Filter (for exports)</h3>
                <label for="exportDateFrom">From:</label>
                <input type="date" id="exportDateFrom">
                <label for="exportDateTo">To:</label>
                <input type="date" id="exportDateTo">
                <button type="button" onclick="clearDateRange()">All Time</button>
            </div>

            <!-- Export Options -->
            <div style="margin: 20px 0;">
                <h3>Export Options</h3>
                <button type="button" class="export-btn" onclick="exportToCSV('full')">üìã Export Full Ledger (CSV)</button>
                <button type="button" class="export-btn" onclick="exportToCSV('income')">üìã Export Income Summary (CSV)</button>
                <button type="button" class="export-btn" onclick="exportToCSV('expenses')">üìã Export Expenses Summary (CSV)</button>
                <button type="button" class="export-btn" onclick="exportToCSV('tax')">üìã Export Tax Computation (CSV)</button>
                <button type="button" class="export-btn" onclick="exportToCSV('annual')">üìã Export Annual Summary (CSV)</button>
                <button type="button" class="export-btn" onclick="exportToExcel()">üìä Export to Excel (Enhanced CSV)</button>
                <button type="button" class="export-btn" onclick="exportToPDF()">üìÑ Export to PDF</button>
            </div>

            <!-- Import Options -->
            <div style="margin: 20px 0;">
                <h3>Import Options</h3>
                <button type="button" class="import-btn" onclick="document.getElementById('csvImportFileInput').click()">üì§ Import from CSV</button>
                <input type="file" id="csvImportFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
            </div>

            <!-- Backup/Restore -->
            <div style="margin: 20px 0;">
                <h3>Backup & Restore</h3>
                <button type="button" class="success-btn" onclick="exportData()">üíæ Backup Data (Download JSON)</button>
                <button type="button" class="info-btn" onclick="document.getElementById('importFileInput').click()">üìÇ Load Backup (JSON)</button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importData(event)">
                <button type="button" class="danger-btn" onclick="clearCurrentYearData()">üóëÔ∏è Clear Current Year Data</button>
            </div>
        </div>

        <!-- Hidden printable div for PDF export -->
        <div id="printableReport" style="display: none;"></div>

        <!-- CSV Import Modal -->
        <div id="csvImportModal" class="modal-overlay">
            <div class="modal-content">
                <h3>Import CSV Data</h3>
                <div id="csvImportContent"></div>
                <div style="margin-top: 20px;">
                    <button type="button" onclick="closeImportModal()">Cancel</button>
                    <button type="button" class="success-btn" onclick="confirmImport()" id="confirmImportBtn" style="display: none;">Confirm Import</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Constants for 2025/26 Tax Year
        const PERSONAL_ALLOWANCE = 12570; // UK Personal allowance threshold
        const BLIND_PERSONS_ALLOWANCE = 3130; // Blind Person's Allowance 2025/26
        const MARRIAGE_ALLOWANCE_TRANSFER = 1260; // Marriage/Civil Partnership Allowance transfer amount
        const MARRIAGE_ALLOWANCE_SAVINGS = 252; // Maximum tax savings from Marriage Allowance (20% of ¬£1,260)
        const TRADING_ALLOWANCE = 1000; // Trading Allowance 2025/26
        const PROPERTY_ALLOWANCE = 1000; // Property Allowance 2025/26
        const CGT_ANNUAL_EXEMPT_AMOUNT = 3000; // CGT Annual Exempt Amount 2025/26
        const NI_PRIMARY_THRESHOLD = 12570; // National Insurance Primary Threshold 2025/26
        const NI_RATE = 0.12; // National Insurance rate for employees
        const SMALL_COMPANY_TAX_RATE = 0.19; // Small Profits Rate for Corporation Tax
        const MAIN_COMPANY_TAX_RATE = 0.25; // Main Rate for Corporation Tax

        // Phase 2: Advanced Tax Planning Constants (2025/26)
        
        // Student Loans 2025/26
        const STUDENT_LOAN_THRESHOLDS = {
            none: { threshold: 0, rate: 0, name: 'None' },
            plan1: { threshold: 24990, rate: 0.09, name: 'Plan 1' },
            plan2: { threshold: 27295, rate: 0.09, name: 'Plan 2' },
            plan4: { threshold: 31395, rate: 0.09, name: 'Plan 4' },
            plan5: { threshold: 25000, rate: 0.09, name: 'Plan 5' },
            postgrad: { threshold: 21000, rate: 0.06, name: 'Postgraduate Loan' }
        };

        // Pension 2025/26
        const PENSION_ANNUAL_ALLOWANCE = 60000;
        const PENSION_TAPER_THRESHOLD = 260000;
        const TAX_RELIEF_RATES = {
            basic: 0.20,
            higher: 0.40,
            additional: 0.45
        };

        // Childcare 2025/26
        const CHILDCARE_TAX_FREE = { 
            standard: 2000, 
            disabled: 4000 
        };
        const CHILDCARE_INCOME_LIMIT = 100000;
        const CHILDCARE_GOVERNMENT_CONTRIBUTION = 0.25; // 25% (¬£20 for every ¬£80 paid)

        // Gift Aid
        const GIFT_AID_RATE = 0.25; // 25% enhancement

        // Dividend 2025/26
        const DIVIDEND_ALLOWANCE = 500;
        const DIVIDEND_RATES = { 
            basic: 0.0875,      // 8.75%
            higher: 0.3375,     // 33.75%
            additional: 0.3935  // 39.35%
        };

        // Savings 2025/26
        const SAVINGS_ALLOWANCES = { 
            basic: 1000, 
            higher: 500, 
            additional: 0 
        };
        const SAVINGS_STARTING_RATE = 5000;
        const SAVINGS_STARTING_THRESHOLD = 17570;

        // Category configuration mapping
        const CATEGORY_CONFIG = {
            SoleTrader: {
                name: 'Sole Trader',
                taxes: ['incomeTax', 'vat'],
                allowances: ['personal', 'trading'],
                description: 'Self-employed individual trading on their own'
            },
            Director: {
                name: 'Director',
                taxes: ['incomeTax', 'paye', 'companyTax'],
                allowances: ['personal'],
                description: 'Company director with PAYE income'
            },
            Employee: {
                name: 'Employee',
                taxes: ['incomeTax', 'paye'],
                allowances: ['personal'],
                description: 'Employed individual with PAYE'
            },
            Company: {
                name: 'Company',
                taxes: ['companyTax', 'vat'],
                allowances: [],
                description: 'Limited company or corporation'
            },
            Landlords: {
                name: 'Landlords',
                taxes: ['incomeTax', 'cgt'],
                allowances: ['personal', 'property'],
                description: 'Property rental income and capital gains'
            }
        };

        // Update tax fields based on selected category
        function updateTaxFields() {
            const category = document.getElementById('category').value;
            const categoryFields = document.getElementById('categorySpecificFields');
            const vatSection = document.getElementById('vatSection');
            const payeSection = document.getElementById('payeSection');
            const companyTaxSection = document.getElementById('companyTaxSection');
            const cgtSection = document.getElementById('cgtSection');

            // Hide all category-specific sections initially
            categoryFields.style.display = 'none';
            vatSection.style.display = 'none';
            payeSection.style.display = 'none';
            companyTaxSection.style.display = 'none';
            cgtSection.style.display = 'none';

            if (!category) return;

            // Show category-specific fields
            categoryFields.style.display = 'block';
            const config = CATEGORY_CONFIG[category];
            
            if (config.taxes.includes('vat')) {
                vatSection.style.display = 'block';
            }
            if (config.taxes.includes('paye')) {
                payeSection.style.display = 'block';
            }
            if (config.taxes.includes('companyTax')) {
                companyTaxSection.style.display = 'block';
            }
            if (config.taxes.includes('cgt')) {
                cgtSection.style.display = 'block';
            }

            // Update allowance field visibility
            updateAllowanceFieldsForCategory(category);
        }

        // Update allowance fields based on category
        function updateAllowanceFieldsForCategory(category) {
            if (!CATEGORY_CONFIG[category]) return; // Safety check
            
            const config = CATEGORY_CONFIG[category];
            const tradingAllowanceDiv = document.getElementById('tradingAllowance').parentElement;
            const propertyAllowanceDiv = document.getElementById('propertyAllowance').parentElement;
            const personalAllowanceDiv = document.getElementById('allowances').parentElement;

            // Show/hide allowances based on category
            if (category === 'Company') {
                personalAllowanceDiv.style.display = 'none';
            } else {
                personalAllowanceDiv.style.display = 'block';
            }

            if (config.allowances.includes('trading')) {
                tradingAllowanceDiv.style.display = 'block';
            } else {
                tradingAllowanceDiv.style.display = 'none';
            }

            if (config.allowances.includes('property')) {
                propertyAllowanceDiv.style.display = 'block';
            } else {
                propertyAllowanceDiv.style.display = 'none';
            }
        }

        // Toggle VAT fields
        function toggleVATFields() {
            const vatRegistered = document.getElementById('vatRegistered').value === 'yes';
            document.getElementById('vatFields').style.display = vatRegistered ? 'block' : 'none';
        }

        // Data storage - Multi-year structure
        const STORAGE_KEY = 'ukTaxCalculatorData';
        const DATA_VERSION = '2.0';
        
        let currentYear = '2025/26';
        let incomeEntries = [];
        let expenseEntries = [];
        let entryIdCounter = 0;

        // Initialize data structure
        function initializeDataStructure() {
            return {
                version: DATA_VERSION,
                currentYear: currentYear,
                businessProfile: {
                    businessName: '',
                    tradingName: '',
                    address: '',
                    vatNumber: '',
                    companyNumber: ''
                },
                taxYears: {
                    '2026/27': { income: [], expenses: [], taxCalculations: {}, entryIdCounter: 0 },
                    '2025/26': { income: [], expenses: [], taxCalculations: {}, entryIdCounter: 0 },
                    '2024/25': { income: [], expenses: [], taxCalculations: {}, entryIdCounter: 0 },
                    '2023/24': { income: [], expenses: [], taxCalculations: {}, entryIdCounter: 0 },
                    '2022/23': { income: [], expenses: [], taxCalculations: {}, entryIdCounter: 0 },
                    '2021/22': { income: [], expenses: [], taxCalculations: {}, entryIdCounter: 0 }
                },
                settings: {
                    dateFormat: 'DD/MM/YYYY',
                    currencyFormat: 'GBP'
                }
            };
        }

        // Save data to localStorage
        function saveToLocalStorage() {
            try {
                const data = loadFromLocalStorage() || initializeDataStructure();
                
                // Update current year data
                data.currentYear = currentYear;
                data.taxYears[currentYear] = {
                    income: incomeEntries,
                    expenses: expenseEntries,
                    taxCalculations: data.taxYears[currentYear]?.taxCalculations || {},
                    entryIdCounter: entryIdCounter
                };
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                alert('Failed to save data. Your browser storage may be full.');
            }
        }

        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) return null;
                
                const data = JSON.parse(stored);
                
                // Migrate old data format if needed
                if (!data.version || data.version !== DATA_VERSION) {
                    return migrateOldData(data);
                }
                
                return data;
            } catch (e) {
                console.error('Error loading from localStorage:', e);
                return null;
            }
        }

        // Migrate old data format to new structure
        function migrateOldData(oldData) {
            const newData = initializeDataStructure();
            
            // If old data exists in array format, it's from a pre-1.0 version
            // This format predates the current implementation and cannot be reliably migrated
            // Initialize with empty structure instead
            if (Array.isArray(oldData)) {
                return newData;
            }
            
            // If data exists without version, assume it's from version 1.0 (current year only)
            // Migrate this data to the 2025/26 tax year in the new multi-year structure
            if (oldData && !oldData.version) {
                if (oldData.income || oldData.expenses) {
                    newData.taxYears['2025/26'].income = oldData.income || [];
                    newData.taxYears['2025/26'].expenses = oldData.expenses || [];
                }
            }
            
            return newData;
        }

        // Load data for specific year
        function loadYearData(year) {
            const data = loadFromLocalStorage();
            if (!data || !data.taxYears[year]) {
                incomeEntries = [];
                expenseEntries = [];
                entryIdCounter = 0;
                return;
            }
            
            const yearData = data.taxYears[year];
            incomeEntries = yearData.income || [];
            expenseEntries = yearData.expenses || [];
            entryIdCounter = yearData.entryIdCounter || 0;
            
            // Migration: Add dates to entries that don't have them
            const today = new Date().toISOString().split('T')[0];
            incomeEntries.forEach(entry => {
                if (!entry.date) {
                    entry.date = today;
                }
            });
            expenseEntries.forEach(entry => {
                if (!entry.date) {
                    entry.date = today;
                }
            });
        }

        // Switch to different year
        function switchYear() {
            const yearSelector = document.getElementById('yearSelector');
            
            // Save advanced tax settings before switching
            saveAdvancedTaxSettings();
            
            currentYear = yearSelector.value;
            
            // Save current data before switching
            saveToLocalStorage();
            
            // Load new year data
            loadYearData(currentYear);
            
            // Load advanced tax settings for new year
            loadAdvancedTaxSettings();
            
            // Refresh all displays (income list, expense list, summary, and ledger)
            refreshAllDisplays();
        }

        // Clear current year data
        function clearCurrentYearData() {
            if (!confirm(`Are you sure you want to clear ALL data for ${currentYear}? This cannot be undone!`)) {
                return;
            }
            
            incomeEntries = [];
            expenseEntries = [];
            entryIdCounter = 0;
            
            saveToLocalStorage();
            refreshAllDisplays();
            
            alert(`All data for ${currentYear} has been cleared.`);
        }

        // Export data to JSON file
        function exportData() {
            const data = loadFromLocalStorage() || initializeDataStructure();
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `uk-tax-calculator-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Data exported successfully!');
        }

        // Import data from JSON file
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.version || !importedData.taxYears) {
                        throw new Error('Invalid data format');
                    }
                    
                    if (confirm('This will replace ALL existing data. Continue?')) {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData));
                        currentYear = importedData.currentYear || '2025/26';
                        document.getElementById('yearSelector').value = currentYear;
                        loadYearData(currentYear);
                        refreshAllDisplays();
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // ============ Phase 3: Export/Import Functions ============

        // Helper function to format date for display
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Helper function to download files
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Clear date range filter
        function clearDateRange() {
            document.getElementById('exportDateFrom').value = '';
            document.getElementById('exportDateTo').value = '';
        }

        // Filter entries by date range
        function filterEntriesByDateRange(entries, dateFrom, dateTo) {
            if (!dateFrom && !dateTo) return entries;
            
            return entries.filter(entry => {
                if (!entry.date) return false;
                const entryDate = new Date(entry.date);
                if (dateFrom && entryDate < new Date(dateFrom)) return false;
                if (dateTo && entryDate > new Date(dateTo)) return false;
                return true;
            });
        }

        // Export to CSV
        function exportToCSV(dataType) {
            const dateFrom = document.getElementById('exportDateFrom').value;
            const dateTo = document.getElementById('exportDateTo').value;
            
            let csv = '';
            let filename = '';
            
            const filteredIncome = filterEntriesByDateRange(incomeEntries, dateFrom, dateTo);
            const filteredExpenses = filterEntriesByDateRange(expenseEntries, dateFrom, dateTo);
            
            switch (dataType) {
                case 'full':
                    csv = generateFullLedgerCSV(filteredIncome, filteredExpenses);
                    filename = `ledger-full-${currentYear}.csv`;
                    break;
                case 'income':
                    csv = generateIncomeCSV(filteredIncome);
                    filename = `ledger-income-${currentYear}.csv`;
                    break;
                case 'expenses':
                    csv = generateExpensesCSV(filteredExpenses);
                    filename = `ledger-expenses-${currentYear}.csv`;
                    break;
                case 'tax':
                    csv = generateTaxComputationCSV();
                    filename = `tax-computation-${currentYear}.csv`;
                    break;
                case 'annual':
                    csv = generateAnnualSummaryCSV(filteredIncome, filteredExpenses);
                    filename = `annual-summary-${currentYear}.csv`;
                    break;
            }
            
            downloadFile(csv, filename, 'text/csv;charset=utf-8;');
            alert(`Exported ${dataType} data to ${filename}`);
        }

        // Generate full ledger CSV
        function generateFullLedgerCSV(income, expenses) {
            let csv = 'Date,Type,Description,Amount,Category\n';
            
            const allEntries = [...income, ...expenses].sort((a, b) => {
                if (a.date && b.date) return new Date(a.date) - new Date(b.date);
                return a.id - b.id;
            });
            
            allEntries.forEach(entry => {
                const date = entry.date || '';
                const type = entry.type === 'income' ? 'Income' : 'Expense';
                const description = `"${entry.description.replace(/"/g, '""')}"`;
                const amount = entry.amount.toFixed(2);
                const category = entry.category || (entry.type === 'income' ? 'Trading Income' : 'Business Expense');
                csv += `${date},${type},${description},${amount},${category}\n`;
            });
            
            return csv;
        }

        // Generate income CSV
        function generateIncomeCSV(income) {
            let csv = 'Date,Description,Amount,Category\n';
            
            income.forEach(entry => {
                const date = entry.date || '';
                const description = `"${entry.description.replace(/"/g, '""')}"`;
                const amount = entry.amount.toFixed(2);
                const category = entry.category || 'Trading Income';
                csv += `${date},${description},${amount},${category}\n`;
            });
            
            // Add total
            const total = income.reduce((sum, entry) => sum + entry.amount, 0);
            csv += `\nTotal Income,,${total.toFixed(2)}\n`;
            
            return csv;
        }

        // Generate expenses CSV
        function generateExpensesCSV(expenses) {
            let csv = 'Date,Description,Amount,Category\n';
            
            expenses.forEach(entry => {
                const date = entry.date || '';
                const description = `"${entry.description.replace(/"/g, '""')}"`;
                const amount = entry.amount.toFixed(2);
                const category = entry.category || 'Business Expense';
                csv += `${date},${description},${amount},${category}\n`;
            });
            
            // Add total
            const total = expenses.reduce((sum, entry) => sum + entry.amount, 0);
            csv += `\nTotal Expenses,,${total.toFixed(2)}\n`;
            
            return csv;
        }

        // Generate tax computation CSV
        function generateTaxComputationCSV() {
            const totalIncome = incomeEntries.reduce((sum, entry) => sum + entry.amount, 0);
            const totalExpenses = expenseEntries.reduce((sum, entry) => sum + entry.amount, 0);
            const netProfit = totalIncome - totalExpenses;
            
            let csv = 'Item,Amount\n';
            csv += `Gross Income,${totalIncome.toFixed(2)}\n`;
            csv += `Total Expenses,${totalExpenses.toFixed(2)}\n`;
            csv += `Net Profit,${netProfit.toFixed(2)}\n`;
            csv += '\n';
            
            // Get tax calculation if available
            const data = loadFromLocalStorage();
            if (data && data.taxYears[currentYear]?.taxCalculations) {
                const taxCalc = data.taxYears[currentYear].taxCalculations;
                if (taxCalc.incomeTax !== undefined) {
                    csv += `Income Tax,${taxCalc.incomeTax.toFixed(2)}\n`;
                }
                if (taxCalc.nationalInsurance !== undefined) {
                    csv += `National Insurance,${taxCalc.nationalInsurance.toFixed(2)}\n`;
                }
                if (taxCalc.totalTax !== undefined) {
                    csv += `Total Tax Due,${taxCalc.totalTax.toFixed(2)}\n`;
                }
            }
            
            return csv;
        }

        // Generate annual summary CSV
        function generateAnnualSummaryCSV(income, expenses) {
            const totalIncome = income.reduce((sum, entry) => sum + entry.amount, 0);
            const totalExpenses = expenses.reduce((sum, entry) => sum + entry.amount, 0);
            const netProfit = totalIncome - totalExpenses;
            
            let csv = `Annual Summary for Tax Year ${currentYear}\n\n`;
            csv += 'Category,Amount\n';
            csv += `Total Income,${totalIncome.toFixed(2)}\n`;
            csv += `Total Expenses,${totalExpenses.toFixed(2)}\n`;
            csv += `Net Profit/Loss,${netProfit.toFixed(2)}\n`;
            csv += '\n';
            csv += `Number of Income Entries,${income.length}\n`;
            csv += `Number of Expense Entries,${expenses.length}\n`;
            csv += `Total Transactions,${income.length + expenses.length}\n`;
            
            return csv;
        }

        // Export to Excel (enhanced CSV)
        function exportToExcel() {
            const dateFrom = document.getElementById('exportDateFrom').value;
            const dateTo = document.getElementById('exportDateTo').value;
            
            const filteredIncome = filterEntriesByDateRange(incomeEntries, dateFrom, dateTo);
            const filteredExpenses = filterEntriesByDateRange(expenseEntries, dateFrom, dateTo);
            
            const totalIncome = filteredIncome.reduce((sum, entry) => sum + entry.amount, 0);
            const totalExpenses = filteredExpenses.reduce((sum, entry) => sum + entry.amount, 0);
            const netProfit = totalIncome - totalExpenses;
            
            let csv = `UK Tax Calculator Report - ${currentYear}\n`;
            csv += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            // Income Section
            csv += '=== INCOME ===\n';
            csv += 'Date,Description,Amount\n';
            filteredIncome.forEach(entry => {
                const date = entry.date || '';
                const description = `"${entry.description.replace(/"/g, '""')}"`;
                csv += `${date},${description},${entry.amount.toFixed(2)}\n`;
            });
            csv += `,,=SUM(C:C)\n`;
            csv += `Total Income,,${totalIncome.toFixed(2)}\n\n`;
            
            // Expenses Section
            csv += '=== EXPENSES ===\n';
            csv += 'Date,Description,Amount\n';
            filteredExpenses.forEach(entry => {
                const date = entry.date || '';
                const description = `"${entry.description.replace(/"/g, '""')}"`;
                csv += `${date},${description},${entry.amount.toFixed(2)}\n`;
            });
            csv += `,,=SUM(C:C)\n`;
            csv += `Total Expenses,,${totalExpenses.toFixed(2)}\n\n`;
            
            // Summary Section
            csv += '=== FINANCIAL SUMMARY ===\n';
            csv += 'Item,Amount\n';
            csv += `Total Income,${totalIncome.toFixed(2)}\n`;
            csv += `Total Expenses,${totalExpenses.toFixed(2)}\n`;
            csv += `Net Profit/Loss,${netProfit.toFixed(2)}\n`;
            
            downloadFile(csv, `tax-report-excel-${currentYear}.csv`, 'text/csv;charset=utf-8;');
            alert('Excel-compatible CSV exported successfully!');
        }

        // Export to PDF (using print dialog)
        function exportToPDF() {
            const dateFrom = document.getElementById('exportDateFrom').value;
            const dateTo = document.getElementById('exportDateTo').value;
            
            const filteredIncome = filterEntriesByDateRange(incomeEntries, dateFrom, dateTo);
            const filteredExpenses = filterEntriesByDateRange(expenseEntries, dateFrom, dateTo);
            
            const totalIncome = filteredIncome.reduce((sum, entry) => sum + entry.amount, 0);
            const totalExpenses = filteredExpenses.reduce((sum, entry) => sum + entry.amount, 0);
            const netProfit = totalIncome - totalExpenses;
            
            // Build printable HTML
            let html = `
                <div class="print-header">
                    <h1>UK Tax Calculator & Accounting Manager</h1>
                    <h2>Tax Year: ${currentYear}</h2>
                    <p>Generated: ${new Date().toLocaleDateString('en-GB')}</p>
                    ${dateFrom || dateTo ? `<p>Date Range: ${dateFrom || 'Start'} to ${dateTo || 'End'}</p>` : '<p>Period: All Time</p>'}
                </div>
                
                <div class="print-section">
                    <h2>Income Entries</h2>
                    <table class="print-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredIncome.map(entry => `
                                <tr>
                                    <td>${formatDate(entry.date)}</td>
                                    <td>${escapeHtml(entry.description)}</td>
                                    <td>¬£${entry.amount.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                            <tr class="print-total">
                                <td colspan="2"><strong>Total Income</strong></td>
                                <td><strong>¬£${totalIncome.toFixed(2)}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="print-section">
                    <h2>Expense Entries</h2>
                    <table class="print-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredExpenses.map(entry => `
                                <tr>
                                    <td>${formatDate(entry.date)}</td>
                                    <td>${escapeHtml(entry.description)}</td>
                                    <td>¬£${entry.amount.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                            <tr class="print-total">
                                <td colspan="2"><strong>Total Expenses</strong></td>
                                <td><strong>¬£${totalExpenses.toFixed(2)}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="print-section">
                    <h2>Financial Summary</h2>
                    <table class="print-table">
                        <tbody>
                            <tr>
                                <td><strong>Total Income</strong></td>
                                <td>¬£${totalIncome.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td><strong>Total Expenses</strong></td>
                                <td>¬£${totalExpenses.toFixed(2)}</td>
                            </tr>
                            <tr class="print-total">
                                <td><strong>Net Profit/Loss</strong></td>
                                <td><strong>¬£${netProfit.toFixed(2)}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            // Insert into printable div
            document.getElementById('printableReport').innerHTML = html;
            
            // Trigger print dialog
            window.print();
        }

        // CSV Import handlers
        let pendingImportData = null;

        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const parsed = parseCSV(csvText);
                    
                    if (parsed.length === 0) {
                        alert('CSV file is empty or invalid.');
                        return;
                    }
                    
                    showColumnMappingUI(parsed);
                } catch (error) {
                    alert('Error reading CSV file: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Simple CSV parser
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const rows = [];
            
            for (let line of lines) {
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                row.push(current.trim());
                rows.push(row);
            }
            
            return rows;
        }

        // Show column mapping UI
        function showColumnMappingUI(csvData) {
            const headers = csvData[0];
            const dataRows = csvData.slice(1, Math.min(6, csvData.length)); // Show first 5 data rows
            
            let html = '<h4>Step 1: Map CSV Columns</h4>';
            html += '<p>Please map your CSV columns to the required fields:</p>';
            html += '<div class="column-mapping">';
            
            headers.forEach((header, index) => {
                html += `
                    <div class="column-mapping-row">
                        <label>Column "${escapeHtml(header)}":</label>
                        <select id="mapping_${index}">
                            <option value="">-- Ignore --</option>
                            <option value="date" ${header.toLowerCase().includes('date') ? 'selected' : ''}>Date</option>
                            <option value="description" ${header.toLowerCase().includes('description') || header.toLowerCase().includes('detail') ? 'selected' : ''}>Description</option>
                            <option value="amount" ${header.toLowerCase().includes('amount') || header.toLowerCase().includes('value') ? 'selected' : ''}>Amount</option>
                            <option value="type" ${header.toLowerCase().includes('type') || header.toLowerCase().includes('category') ? 'selected' : ''}>Type (Income/Expense)</option>
                        </select>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<h4>Step 2: Preview Data</h4>';
            html += '<p>First 5 rows from your CSV:</p>';
            html += '<table class="preview-table"><thead><tr>';
            
            headers.forEach(header => {
                html += `<th>${escapeHtml(header)}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            dataRows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    html += `<td>${escapeHtml(cell)}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += '<button type="button" class="success-btn" onclick="processCSVImport()">Process Import</button>';
            
            document.getElementById('csvImportContent').innerHTML = html;
            document.getElementById('csvImportModal').classList.add('active');
            
            // Store data for processing
            pendingImportData = csvData;
        }

        // Process CSV import after column mapping
        function processCSVImport() {
            if (!pendingImportData) return;
            
            const headers = pendingImportData[0];
            const dataRows = pendingImportData.slice(1);
            
            // Get column mappings
            const mapping = {};
            headers.forEach((header, index) => {
                const selectedField = document.getElementById(`mapping_${index}`).value;
                if (selectedField) {
                    mapping[selectedField] = index;
                }
            });
            
            // Validate required fields
            if (mapping.description === undefined || mapping.amount === undefined) {
                alert('Description and Amount columns are required. Please map them.');
                return;
            }
            
            // Parse and validate data
            const validEntries = [];
            const errors = [];
            const duplicates = [];
            
            dataRows.forEach((row, rowIndex) => {
                if (row.length === 0 || row.every(cell => !cell.trim())) return; // Skip empty rows
                
                try {
                    const entry = {
                        date: mapping.date !== undefined ? row[mapping.date] : new Date().toISOString().split('T')[0],
                        description: row[mapping.description]?.trim() || '',
                        amount: parseFloat(row[mapping.amount]?.replace(/[¬£,]/g, '') || '0'),
                        type: 'income' // default
                    };
                    
                    // Determine type
                    if (mapping.type !== undefined) {
                        const typeValue = row[mapping.type]?.toLowerCase() || '';
                        if (typeValue.includes('expense') || typeValue.includes('cost') || typeValue.includes('payment')) {
                            entry.type = 'expense';
                        } else {
                            entry.type = 'income';
                        }
                    }
                    
                    // Validate
                    if (!entry.description) {
                        errors.push(`Row ${rowIndex + 2}: Description is required`);
                        return;
                    }
                    if (isNaN(entry.amount) || entry.amount <= 0) {
                        errors.push(`Row ${rowIndex + 2}: Invalid amount "${row[mapping.amount]}"`);
                        return;
                    }
                    
                    // Check for duplicates
                    const existingEntries = entry.type === 'income' ? incomeEntries : expenseEntries;
                    const isDuplicate = existingEntries.some(e => 
                        e.description === entry.description && 
                        Math.abs(e.amount - entry.amount) < 0.01 &&
                        (!e.date || !entry.date || e.date === entry.date)
                    );
                    
                    if (isDuplicate) {
                        duplicates.push(entry);
                    } else {
                        validEntries.push(entry);
                    }
                } catch (error) {
                    errors.push(`Row ${rowIndex + 2}: ${error.message}`);
                }
            });
            
            // Show validation summary
            showImportValidationSummary(validEntries, duplicates, errors);
        }

        // Show import validation summary
        function showImportValidationSummary(validEntries, duplicates, errors) {
            let html = '<h4>Import Validation Summary</h4>';
            
            if (errors.length > 0) {
                html += '<div class="validation-summary error">';
                html += `<strong>Errors Found (${errors.length}):</strong><ul>`;
                errors.forEach(error => {
                    html += `<li>${escapeHtml(error)}</li>`;
                });
                html += '</ul></div>';
            }
            
            if (duplicates.length > 0) {
                html += '<div class="validation-summary warning">';
                html += `<strong>Duplicates Detected (${duplicates.length}):</strong><ul>`;
                duplicates.forEach(entry => {
                    html += `<li>${escapeHtml(entry.description)} - ¬£${entry.amount.toFixed(2)}</li>`;
                });
                html += '</ul><p>Duplicates will be skipped.</p></div>';
            }
            
            if (validEntries.length > 0) {
                html += '<div class="validation-summary success">';
                html += `<strong>Ready to Import (${validEntries.length} entries):</strong>`;
                html += `<ul><li>Income entries: ${validEntries.filter(e => e.type === 'income').length}</li>`;
                html += `<li>Expense entries: ${validEntries.filter(e => e.type === 'expense').length}</li></ul>`;
                html += '</div>';
            }
            
            if (validEntries.length === 0) {
                html += '<p>No valid entries to import.</p>';
            } else {
                html += '<button type="button" class="success-btn" onclick="confirmImport()">Confirm & Import</button>';
            }
            
            document.getElementById('csvImportContent').innerHTML = html;
            
            // Store valid entries for final import
            pendingImportData = validEntries;
        }

        // Confirm and execute import
        function confirmImport() {
            if (!pendingImportData || pendingImportData.length === 0) return;
            
            let incomeCount = 0;
            let expenseCount = 0;
            
            pendingImportData.forEach(entry => {
                entry.id = entryIdCounter++;
                
                if (entry.type === 'income') {
                    incomeEntries.push(entry);
                    incomeCount++;
                } else {
                    expenseEntries.push(entry);
                    expenseCount++;
                }
            });
            
            saveToLocalStorage();
            refreshAllDisplays();
            closeImportModal();
            
            alert(`Import successful!\n${incomeCount} income entries and ${expenseCount} expense entries added.`);
        }

        // Close import modal
        function closeImportModal() {
            document.getElementById('csvImportModal').classList.remove('active');
            pendingImportData = null;
        }

        // ============ End Phase 3 Functions ============

        // Initialize on page load
        function initializeApp() {
            const data = loadFromLocalStorage();
            if (data) {
                currentYear = data.currentYear || '2025/26';
                document.getElementById('yearSelector').value = currentYear;
                loadYearData(currentYear);
            } else {
                // First time initialization
                saveToLocalStorage();
            }
            // Load advanced tax settings for current year
            loadAdvancedTaxSettings();
            refreshAllDisplays();
        }

        // Helper function to escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add income entry
        function addIncome() {
            const date = document.getElementById('incomeDate').value;
            const description = document.getElementById('incomeDescription').value.trim();
            const amount = parseFloat(document.getElementById('incomeAmount').value);

            if (!date) {
                alert('Please select a date.');
                return;
            }

            if (!description || !amount || amount <= 0) {
                alert('Please enter a valid description and amount for income.');
                return;
            }

            const entry = {
                id: entryIdCounter++,
                date: date,
                description: description,
                amount: amount,
                type: 'income'
            };

            incomeEntries.push(entry);
            document.getElementById('incomeDate').value = '';
            document.getElementById('incomeDescription').value = '';
            document.getElementById('incomeAmount').value = '';
            
            saveToLocalStorage();
            refreshAllDisplays();
        }

        // Add expense entry
        function addExpense() {
            const date = document.getElementById('expenseDate').value;
            const description = document.getElementById('expenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);

            if (!date) {
                alert('Please select a date.');
                return;
            }

            if (!description || !amount || amount <= 0) {
                alert('Please enter a valid description and amount for expense.');
                return;
            }

            const entry = {
                id: entryIdCounter++,
                date: date,
                description: description,
                amount: amount,
                type: 'expense'
            };

            expenseEntries.push(entry);
            document.getElementById('expenseDate').value = '';
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            
            saveToLocalStorage();
            refreshAllDisplays();
        }

        // Delete entry
        function deleteEntry(id, type) {
            if (confirm('Are you sure you want to delete this entry?')) {
                if (type === 'income') {
                    incomeEntries = incomeEntries.filter(entry => entry.id !== id);
                } else {
                    expenseEntries = expenseEntries.filter(entry => entry.id !== id);
                }
                saveToLocalStorage();
                refreshAllDisplays();
            }
        }

        // Edit entry
        function editEntry(id, type) {
            let entry;
            if (type === 'income') {
                entry = incomeEntries.find(e => e.id === id);
            } else {
                entry = expenseEntries.find(e => e.id === id);
            }

            if (!entry) return;

            const newDescription = prompt('Enter new description:', entry.description);
            if (newDescription === null) return;

            const newAmount = prompt('Enter new amount:', entry.amount);
            if (newAmount === null) return;

            const parsedAmount = parseFloat(newAmount);
            if (!newDescription.trim() || isNaN(parsedAmount) || parsedAmount <= 0) {
                alert('Invalid input. Entry not updated.');
                return;
            }

            entry.description = newDescription.trim();
            entry.amount = parsedAmount;
            saveToLocalStorage();
            refreshAllDisplays();
        }

        // Refresh all displays (income list, expense list, summary, and ledger)
        function refreshAllDisplays() {
            updateIncomeList();
            updateExpenseList();
            updateSummary();
            updateLedger();
        }

        // Update income list
        function updateIncomeList() {
            const container = document.getElementById('incomeList');
            
            if (incomeEntries.length === 0) {
                container.innerHTML = '<p class="no-entries">No income entries yet.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead><tbody>';
            incomeEntries.forEach(entry => {
                const displayDate = entry.date ? formatDate(entry.date) : 'N/A';
                html += `
                    <tr>
                        <td>${displayDate}</td>
                        <td>${escapeHtml(entry.description)}</td>
                        <td>¬£${entry.amount.toFixed(2)}</td>
                        <td>
                            <button class="edit-btn" onclick="editEntry(${entry.id}, 'income')">Edit</button>
                            <button class="delete-btn" onclick="deleteEntry(${entry.id}, 'income')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Update expense list
        function updateExpenseList() {
            const container = document.getElementById('expenseList');
            
            if (expenseEntries.length === 0) {
                container.innerHTML = '<p class="no-entries">No expense entries yet.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead><tbody>';
            expenseEntries.forEach(entry => {
                const displayDate = entry.date ? formatDate(entry.date) : 'N/A';
                html += `
                    <tr>
                        <td>${displayDate}</td>
                        <td>${escapeHtml(entry.description)}</td>
                        <td>¬£${entry.amount.toFixed(2)}</td>
                        <td>
                            <button class="edit-btn" onclick="editEntry(${entry.id}, 'expense')">Edit</button>
                            <button class="delete-btn" onclick="deleteEntry(${entry.id}, 'expense')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Update financial summary
        function updateSummary() {
            const totalIncome = incomeEntries.reduce((sum, entry) => sum + entry.amount, 0);
            const totalExpenses = expenseEntries.reduce((sum, entry) => sum + entry.amount, 0);
            const netProfit = totalIncome - totalExpenses;

            document.getElementById('totalIncome').textContent = `¬£${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `¬£${totalExpenses.toFixed(2)}`;
            document.getElementById('netProfit').textContent = `¬£${netProfit.toFixed(2)}`;
        }

        // Update ledger display
        function updateLedger() {
            const container = document.getElementById('ledgerDisplay');
            const allEntries = [...incomeEntries, ...expenseEntries].sort((a, b) => {
                // Sort by date, then by id
                if (a.date && b.date) {
                    const dateCompare = new Date(a.date) - new Date(b.date);
                    if (dateCompare !== 0) return dateCompare;
                }
                return a.id - b.id;
            });

            if (allEntries.length === 0) {
                container.innerHTML = '<p class="no-entries">No entries yet. Add income or expenses to see your ledger.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead><tbody>';
            allEntries.forEach(entry => {
                const typeLabel = entry.type === 'income' ? 'Income' : 'Expense';
                const displayDate = entry.date ? formatDate(entry.date) : 'N/A';
                html += `
                    <tr>
                        <td>${displayDate}</td>
                        <td><strong>${typeLabel}</strong></td>
                        <td>${escapeHtml(entry.description)}</td>
                        <td>¬£${entry.amount.toFixed(2)}</td>
                        <td>
                            <button class="edit-btn" onclick="editEntry(${entry.id}, '${entry.type}')">Edit</button>
                            <button class="delete-btn" onclick="deleteEntry(${entry.id}, '${entry.type}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ============ Phase 2: Advanced Tax Calculation Functions ============

        // Update student loan info display
        function updateStudentLoanInfo() {
            const plan = document.getElementById('studentLoanPlan').value;
            const infoDiv = document.getElementById('studentLoanInfo');
            
            if (plan === 'none') {
                infoDiv.style.display = 'none';
                return;
            }
            
            const planInfo = STUDENT_LOAN_THRESHOLDS[plan];
            infoDiv.style.display = 'block';
            infoDiv.innerHTML = `<strong>${planInfo.name}:</strong> You'll repay ${(planInfo.rate * 100).toFixed(0)}% of income above ¬£${planInfo.threshold.toLocaleString()} per year.`;
        }

        // Calculate student loan repayment
        function calculateStudentLoan(income, plan) {
            if (plan === 'none' || !STUDENT_LOAN_THRESHOLDS[plan]) {
                return { annual: 0, monthly: 0, threshold: 0, rate: 0, planName: 'None' };
            }
            
            const planInfo = STUDENT_LOAN_THRESHOLDS[plan];
            const repayableIncome = Math.max(0, income - planInfo.threshold);
            const annualRepayment = repayableIncome * planInfo.rate;
            const monthlyRepayment = annualRepayment / 12;
            
            return {
                annual: annualRepayment,
                monthly: monthlyRepayment,
                threshold: planInfo.threshold,
                rate: planInfo.rate,
                planName: planInfo.name
            };
        }

        // Calculate pension contributions and tax relief
        function calculatePension(income, employerAmount, employeeAmount, contribType, method) {
            if (contribType === 'none') {
                return {
                    employerContribution: 0,
                    employeeContribution: 0,
                    totalContribution: 0,
                    basicRateRelief: 0,
                    higherRateRelief: 0,
                    additionalRateRelief: 0,
                    totalRelief: 0,
                    exceedsAllowance: false,
                    method: method
                };
            }

            let employerContrib = 0;
            let employeeContrib = 0;

            // Calculate actual contributions
            if (contribType === 'percent') {
                employerContrib = income * (employerAmount / 100);
                employeeContrib = income * (employeeAmount / 100);
            } else {
                employerContrib = employerAmount;
                employeeContrib = employeeAmount;
            }

            const totalContrib = employerContrib + employeeContrib;
            
            // Calculate tax relief based on method
            let basicRateRelief = 0;
            let higherRateRelief = 0;
            let additionalRateRelief = 0;

            // For both methods, calculate potential relief
            // Relief at source: charity gets 20% automatically
            // Salary sacrifice: full tax relief at marginal rate
            
            if (method === 'relief') {
                // Relief at source - basic rate automatic
                basicRateRelief = employeeContrib * TAX_RELIEF_RATES.basic;
                
                // Higher and additional rate relief needs to be claimed
                // Determine tax band based on income
                if (income > 125140) {
                    additionalRateRelief = employeeContrib * (TAX_RELIEF_RATES.additional - TAX_RELIEF_RATES.basic);
                } else if (income > 50270) {
                    higherRateRelief = employeeContrib * (TAX_RELIEF_RATES.higher - TAX_RELIEF_RATES.basic);
                }
            } else if (method === 'sacrifice') {
                // Salary sacrifice - immediate relief at marginal rate
                if (income > 125140) {
                    basicRateRelief = employeeContrib * TAX_RELIEF_RATES.additional;
                } else if (income > 50270) {
                    basicRateRelief = employeeContrib * TAX_RELIEF_RATES.higher;
                } else {
                    basicRateRelief = employeeContrib * TAX_RELIEF_RATES.basic;
                }
            }

            const totalRelief = basicRateRelief + higherRateRelief + additionalRateRelief;
            const exceedsAllowance = totalContrib > PENSION_ANNUAL_ALLOWANCE;

            return {
                employerContribution: employerContrib,
                employeeContribution: employeeContrib,
                totalContribution: totalContrib,
                basicRateRelief: basicRateRelief,
                higherRateRelief: higherRateRelief,
                additionalRateRelief: additionalRateRelief,
                totalRelief: totalRelief,
                exceedsAllowance: exceedsAllowance,
                method: method
            };
        }

        // Calculate childcare tax relief
        function calculateChildcare(numChildren, numDisabledChildren, expenses, income) {
            if (numChildren === 0 && numDisabledChildren === 0) {
                return {
                    maxRelief: 0,
                    actualRelief: 0,
                    governmentContribution: 0,
                    parentContribution: 0,
                    exceedsLimit: false
                };
            }

            const standardChildren = Math.max(0, numChildren - numDisabledChildren);
            const maxReliefStandard = standardChildren * CHILDCARE_TAX_FREE.standard;
            const maxReliefDisabled = numDisabledChildren * CHILDCARE_TAX_FREE.disabled;
            const maxRelief = maxReliefStandard + maxReliefDisabled;

            // Calculate government contribution (25% of parent's payment)
            // For every ¬£80 parent pays, government adds ¬£20 (total ¬£100)
            const parentContribution = Math.min(expenses * 0.8, maxRelief * 0.8); // Parent pays 80%
            const governmentContribution = parentContribution * 0.25; // Gov adds 25% of parent payment
            const actualRelief = governmentContribution;

            const exceedsLimit = income > CHILDCARE_INCOME_LIMIT;

            return {
                maxRelief: maxRelief,
                actualRelief: actualRelief,
                governmentContribution: governmentContribution,
                parentContribution: parentContribution,
                exceedsLimit: exceedsLimit
            };
        }

        // Calculate Gift Aid
        function calculateGiftAid(donations, income) {
            if (donations === 0) {
                return {
                    charityGets: 0,
                    giftAidAmount: 0,
                    higherRateRelief: 0,
                    additionalRateRelief: 0,
                    totalTaxpayerRelief: 0
                };
            }

            // Charity claims 25% on top of donation
            const giftAidAmount = donations * GIFT_AID_RATE;
            const charityGets = donations + giftAidAmount;

            // Higher/Additional rate taxpayers can claim extra relief
            let higherRateRelief = 0;
            let additionalRateRelief = 0;

            if (income > 125140) {
                // Additional rate: 45% - 20% = 25% extra relief
                additionalRateRelief = donations * 0.25;
            } else if (income > 50270) {
                // Higher rate: 40% - 20% = 20% extra relief
                higherRateRelief = donations * 0.20;
            }

            const totalTaxpayerRelief = higherRateRelief + additionalRateRelief;

            return {
                charityGets: charityGets,
                giftAidAmount: giftAidAmount,
                higherRateRelief: higherRateRelief,
                additionalRateRelief: additionalRateRelief,
                totalTaxpayerRelief: totalTaxpayerRelief
            };
        }

        // Calculate dividend tax
        function calculateDividendTax(dividendIncome, taxableIncome) {
            if (dividendIncome === 0) {
                return {
                    dividendTax: 0,
                    taxableDividends: 0,
                    allowanceUsed: 0,
                    taxBand: 'none',
                    strategy: ''
                };
            }

            // Dividend allowance
            const allowanceUsed = Math.min(dividendIncome, DIVIDEND_ALLOWANCE);
            const taxableDividends = Math.max(0, dividendIncome - DIVIDEND_ALLOWANCE);

            // Determine tax band based on total taxable income (excluding dividends)
            let dividendTax = 0;
            let taxBand = 'basic';
            let remainingDividends = taxableDividends;
            let totalIncome = taxableIncome;

            // Additional rate (over ¬£125,140)
            if (totalIncome + remainingDividends > 125140) {
                const additionalAmount = Math.min(remainingDividends, totalIncome + remainingDividends - 125140);
                dividendTax += additionalAmount * DIVIDEND_RATES.additional;
                remainingDividends -= additionalAmount;
                totalIncome = 125140;
                taxBand = 'additional';
            }

            // Higher rate (¬£50,270 to ¬£125,140)
            if (remainingDividends > 0 && totalIncome + remainingDividends > 50270) {
                const higherAmount = Math.min(remainingDividends, totalIncome + remainingDividends - 50270);
                dividendTax += higherAmount * DIVIDEND_RATES.higher;
                remainingDividends -= higherAmount;
                if (taxBand === 'basic') taxBand = 'higher';
            }

            // Basic rate (up to ¬£50,270)
            if (remainingDividends > 0) {
                dividendTax += remainingDividends * DIVIDEND_RATES.basic;
            }

            // Strategy suggestion
            let strategy = '';
            if (taxBand === 'basic' && dividendIncome > DIVIDEND_ALLOWANCE) {
                strategy = 'You\'re in the basic rate band. Dividend tax is 8.75% above the ¬£500 allowance.';
            } else if (taxBand === 'higher') {
                strategy = 'Consider timing of dividend distributions to optimize tax. Higher rate is 33.75%.';
            } else if (taxBand === 'additional') {
                strategy = 'At 39.35% dividend tax, consider retaining profits in company or using salary instead.';
            }

            return {
                dividendTax: dividendTax,
                taxableDividends: taxableDividends,
                allowanceUsed: allowanceUsed,
                taxBand: taxBand,
                strategy: strategy
            };
        }

        // Calculate savings interest tax
        function calculateSavingsTax(savingsInterest, taxableIncome, grossIncome) {
            if (savingsInterest === 0) {
                return {
                    savingsTax: 0,
                    taxableSavings: 0,
                    allowanceUsed: 0,
                    startingRateUsed: 0,
                    taxBand: 'none'
                };
            }

            let savingsTax = 0;
            let remainingSavings = savingsInterest;
            let taxBand = 'basic';

            // Determine Personal Savings Allowance based on tax band
            let savingsAllowance = 0;
            if (taxableIncome > 125140) {
                savingsAllowance = SAVINGS_ALLOWANCES.additional; // ¬£0
                taxBand = 'additional';
            } else if (taxableIncome > 50270) {
                savingsAllowance = SAVINGS_ALLOWANCES.higher; // ¬£500
                taxBand = 'higher';
            } else {
                savingsAllowance = SAVINGS_ALLOWANCES.basic; // ¬£1,000
                taxBand = 'basic';
            }

            // Starting Rate for Savings (if income under ¬£17,570)
            let startingRateUsed = 0;
            if (grossIncome < SAVINGS_STARTING_THRESHOLD) {
                const availableStartingRate = Math.min(
                    SAVINGS_STARTING_RATE,
                    SAVINGS_STARTING_THRESHOLD - grossIncome
                );
                startingRateUsed = Math.min(remainingSavings, availableStartingRate);
                remainingSavings -= startingRateUsed;
            }

            // Apply Personal Savings Allowance
            const allowanceUsed = Math.min(remainingSavings, savingsAllowance);
            remainingSavings -= allowanceUsed;

            // Tax on remaining savings at income tax rate
            if (remainingSavings > 0) {
                if (taxableIncome > 125140) {
                    savingsTax = remainingSavings * 0.45;
                } else if (taxableIncome > 50270) {
                    savingsTax = remainingSavings * 0.40;
                } else {
                    savingsTax = remainingSavings * 0.20;
                }
            }

            const taxableSavings = remainingSavings;

            return {
                savingsTax: savingsTax,
                taxableSavings: taxableSavings,
                allowanceUsed: allowanceUsed,
                startingRateUsed: startingRateUsed,
                taxBand: taxBand
            };
        }

        // ============ End Phase 2 Functions ============

        // Save advanced tax form values to localStorage
        function saveAdvancedTaxSettings() {
            const advancedSettings = {
                studentLoanPlan: document.getElementById('studentLoanPlan').value,
                pensionContribType: document.getElementById('pensionContribType').value,
                employerPension: document.getElementById('employerPension').value,
                employeePension: document.getElementById('employeePension').value,
                pensionMethod: document.getElementById('pensionMethod').value,
                numChildren: document.getElementById('numChildren').value,
                numDisabledChildren: document.getElementById('numDisabledChildren').value,
                childcareExpenses: document.getElementById('childcareExpenses').value,
                charitableDonations: document.getElementById('charitableDonations').value,
                dividendIncome: document.getElementById('dividendIncome').value,
                savingsInterest: document.getElementById('savingsInterest').value
            };

            try {
                const data = loadFromLocalStorage() || initializeDataStructure();
                if (!data.taxYears[currentYear]) {
                    data.taxYears[currentYear] = { income: [], expenses: [], taxCalculations: {}, entryIdCounter: 0 };
                }
                data.taxYears[currentYear].advancedTax = advancedSettings;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error('Error saving advanced tax settings:', e);
            }
        }

        // Load advanced tax form values from localStorage
        function loadAdvancedTaxSettings() {
            try {
                const data = loadFromLocalStorage();
                if (!data || !data.taxYears[currentYear] || !data.taxYears[currentYear].advancedTax) {
                    // Set defaults
                    document.getElementById('studentLoanPlan').value = 'none';
                    document.getElementById('pensionContribType').value = 'none';
                    document.getElementById('employerPension').value = '0';
                    document.getElementById('employeePension').value = '0';
                    document.getElementById('pensionMethod').value = 'relief';
                    document.getElementById('numChildren').value = '0';
                    document.getElementById('numDisabledChildren').value = '0';
                    document.getElementById('childcareExpenses').value = '0';
                    document.getElementById('charitableDonations').value = '0';
                    document.getElementById('dividendIncome').value = '0';
                    document.getElementById('savingsInterest').value = '0';
                    return;
                }

                const settings = data.taxYears[currentYear].advancedTax;
                document.getElementById('studentLoanPlan').value = settings.studentLoanPlan || 'none';
                document.getElementById('pensionContribType').value = settings.pensionContribType || 'none';
                document.getElementById('employerPension').value = settings.employerPension || '0';
                document.getElementById('employeePension').value = settings.employeePension || '0';
                document.getElementById('pensionMethod').value = settings.pensionMethod || 'relief';
                document.getElementById('numChildren').value = settings.numChildren || '0';
                document.getElementById('numDisabledChildren').value = settings.numDisabledChildren || '0';
                document.getElementById('childcareExpenses').value = settings.childcareExpenses || '0';
                document.getElementById('charitableDonations').value = settings.charitableDonations || '0';
                document.getElementById('dividendIncome').value = settings.dividendIncome || '0';
                document.getElementById('savingsInterest').value = settings.savingsInterest || '0';

                // Update UI elements that depend on loaded values
                updateStudentLoanInfo();
            } catch (e) {
                console.error('Error loading advanced tax settings:', e);
            }
        }

        // Tax calculation function
        function calculateTax(income, expenses, allowancesConfig, category, taxConfig) {
            const BASIC_TAX_RATE = 0.20;  // 20%
            const HIGHER_TAX_RATE = 0.40; // 40%
            const ADDITIONAL_TAX_RATE = 0.45; // 45%

            const HIGHER_TAX_THRESHOLD = 50270; // Higher rate threshold
            const ADDITIONAL_TAX_THRESHOLD = 125140; // Additional rate threshold

            const result = {
                incomeTax: 0,
                vat: 0,
                paye: 0,
                companyTax: 0,
                cgt: 0,
                totalTax: 0,
                totalAllowances: 0,
                allowancesList: [],
                taxableIncome: 0
            };

            // Calculate allowances (not applicable for Company category)
            if (category !== 'Company') {
                if (allowancesConfig.personalAllowance) {
                    result.totalAllowances += PERSONAL_ALLOWANCE;
                    result.allowancesList.push(`Personal Allowance: ¬£${PERSONAL_ALLOWANCE.toFixed(2)}`);
                }

                if (allowancesConfig.blindPersonsAllowance) {
                    result.totalAllowances += BLIND_PERSONS_ALLOWANCE;
                    result.allowancesList.push(`Blind Person's Allowance: ¬£${BLIND_PERSONS_ALLOWANCE.toFixed(2)}`);
                }

                if (allowancesConfig.marriageAllowance) {
                    result.totalAllowances += MARRIAGE_ALLOWANCE_TRANSFER;
                    result.allowancesList.push(`Marriage Allowance: ¬£${MARRIAGE_ALLOWANCE_TRANSFER.toFixed(2)}`);
                }

                if (allowancesConfig.tradingAllowance) {
                    result.totalAllowances += TRADING_ALLOWANCE;
                    result.allowancesList.push(`Trading Allowance: ¬£${TRADING_ALLOWANCE.toFixed(2)}`);
                }

                if (allowancesConfig.propertyAllowance) {
                    result.totalAllowances += PROPERTY_ALLOWANCE;
                    result.allowancesList.push(`Property Allowance: ¬£${PROPERTY_ALLOWANCE.toFixed(2)}`);
                }
            }

            // Calculate taxable income after allowances and expenses
            let taxableIncome = income - result.totalAllowances - expenses;
            taxableIncome = Math.max(0, taxableIncome);
            result.taxableIncome = taxableIncome;

            // Calculate income tax (for individuals)
            if (category !== 'Company') {
                let remainingIncome = taxableIncome;
                
                // Additional rate (45%) on income above ¬£125,140
                if (remainingIncome > ADDITIONAL_TAX_THRESHOLD) {
                    result.incomeTax += (remainingIncome - ADDITIONAL_TAX_THRESHOLD) * ADDITIONAL_TAX_RATE;
                    remainingIncome = ADDITIONAL_TAX_THRESHOLD;
                }

                // Higher rate (40%) on income between ¬£50,270 and ¬£125,140
                if (remainingIncome > HIGHER_TAX_THRESHOLD) {
                    result.incomeTax += (remainingIncome - HIGHER_TAX_THRESHOLD) * HIGHER_TAX_RATE;
                    remainingIncome = HIGHER_TAX_THRESHOLD;
                }

                // Basic rate (20%) on remaining taxable income
                if (remainingIncome > 0) {
                    result.incomeTax += remainingIncome * BASIC_TAX_RATE;
                }
            }

            // Calculate PAYE (simplified - includes NI)
            if (taxConfig.includePAYE) {
                if (income > NI_PRIMARY_THRESHOLD) {
                    result.paye = (income - NI_PRIMARY_THRESHOLD) * NI_RATE;
                }
            }

            // Calculate VAT
            if (taxConfig.vatRegistered && taxConfig.vatRate) {
                result.vat = income * taxConfig.vatRate;
            }

            // Calculate Company Tax
            if (category === 'Company') {
                const profit = income - expenses;
                result.companyTax = Math.max(0, profit) * (taxConfig.companyTaxRate || SMALL_COMPANY_TAX_RATE);
            }

            // Calculate CGT
            if (taxConfig.capitalGains && taxConfig.capitalGains > 0) {
                const taxableGains = Math.max(0, taxConfig.capitalGains - CGT_ANNUAL_EXEMPT_AMOUNT);
                let cgtRate = 0.10; // Basic rate for other assets
                
                if (taxConfig.cgtType === 'property') {
                    // Property CGT rates
                    cgtRate = taxableIncome > HIGHER_TAX_THRESHOLD ? 0.28 : 0.18;
                } else {
                    // Other assets CGT rates
                    cgtRate = taxableIncome > HIGHER_TAX_THRESHOLD ? 0.20 : 0.10;
                }
                
                result.cgt = taxableGains * cgtRate;
            }

            // Calculate total tax
            result.totalTax = result.incomeTax + result.vat + result.paye + result.companyTax + result.cgt;

            // Phase 2: Add advanced tax calculations if provided
            if (taxConfig.advancedTax) {
                result.advancedTax = {
                    studentLoan: taxConfig.advancedTax.studentLoan || { annual: 0 },
                    pension: taxConfig.advancedTax.pension || { totalRelief: 0 },
                    childcare: taxConfig.advancedTax.childcare || { actualRelief: 0 },
                    giftAid: taxConfig.advancedTax.giftAid || { totalTaxpayerRelief: 0 },
                    dividend: taxConfig.advancedTax.dividend || { dividendTax: 0 },
                    savings: taxConfig.advancedTax.savings || { savingsTax: 0 }
                };

                // Add student loan repayment to total (it's a deduction, not a tax)
                result.totalTax += result.advancedTax.studentLoan.annual;
                
                // Add dividend tax and savings tax
                result.totalTax += result.advancedTax.dividend.dividendTax;
                result.totalTax += result.advancedTax.savings.savingsTax;

                // Subtract tax reliefs
                result.totalTax -= result.advancedTax.pension.totalRelief;
                result.totalTax -= result.advancedTax.giftAid.totalTaxpayerRelief;
            }

            return result;
        }

        // Tax form submission
        document.getElementById('taxForm').addEventListener('submit', function(event) {
            event.preventDefault();

            // Validate category selection
            const category = document.getElementById('category').value;
            if (!category) {
                alert('Please select a tax category first.');
                return;
            }

            // Use ledger data if available, otherwise show message
            const totalIncome = incomeEntries.reduce((sum, entry) => sum + entry.amount, 0);
            const totalExpenses = expenseEntries.reduce((sum, entry) => sum + entry.amount, 0);

            if (totalIncome === 0 && totalExpenses === 0) {
                alert('No income or expense entries found. Tax calculation will use ¬£0 values.');
            }

            // Get allowance selections
            const allowancesConfig = {
                personalAllowance: document.getElementById('allowances').value === 'yes',
                blindPersonsAllowance: document.getElementById('blindPersonsAllowance').value === 'yes',
                marriageAllowance: document.getElementById('marriageAllowance').value === 'yes',
                tradingAllowance: document.getElementById('tradingAllowance').value === 'yes',
                propertyAllowance: document.getElementById('propertyAllowance').value === 'yes'
            };

            // Get tax-specific configuration
            const vatRegisteredElement = document.getElementById('vatRegistered');
            const vatRateElement = document.getElementById('vatRate');
            const vatRegistered = vatRegisteredElement ? vatRegisteredElement.value === 'yes' : false;
            const vatRate = vatRegistered && vatRateElement ? parseFloat(vatRateElement.value) : 0;
            
            const taxConfig = {
                includePAYE: CATEGORY_CONFIG[category].taxes.includes('paye'),
                vatRegistered: vatRegistered,
                vatRate: vatRate,
                companyTaxRate: document.getElementById('companyTaxRate') ? 
                    parseFloat(document.getElementById('companyTaxRate').value) : SMALL_COMPANY_TAX_RATE,
                capitalGains: document.getElementById('capitalGains') ? 
                    parseFloat(document.getElementById('capitalGains').value) || 0 : 0,
                cgtType: document.getElementById('cgtType') ? 
                    document.getElementById('cgtType').value : 'other'
            };

            // Validate allowances combination
            let validationWarnings = [];
            
            // Trading and Property allowances are alternatives to claiming actual expenses in those categories
            // Provide informational notice if expenses exist
            if (allowancesConfig.tradingAllowance && totalExpenses > 0) {
                validationWarnings.push('Note: Trading Allowance (¬£1,000) is an alternative to claiming actual trading/self-employment expenses. If your trading expenses exceed ¬£1,000, you may be better off claiming actual expenses instead.');
            }
            
            if (allowancesConfig.propertyAllowance && totalExpenses > 0) {
                validationWarnings.push('Note: Property Allowance (¬£1,000) is an alternative to claiming actual property expenses. If your property expenses exceed ¬£1,000, you may be better off claiming actual expenses instead.');
            }

            // Show validation warnings if any
            if (validationWarnings.length > 0) {
                alert(validationWarnings.join('\n'));
            }

            // Phase 2: Calculate preliminary taxable income for advanced calculations
            let preliminaryAllowances = 0;
            if (allowancesConfig.personalAllowance && category !== 'Company') preliminaryAllowances += PERSONAL_ALLOWANCE;
            if (allowancesConfig.blindPersonsAllowance && category !== 'Company') preliminaryAllowances += BLIND_PERSONS_ALLOWANCE;
            if (allowancesConfig.marriageAllowance && category !== 'Company') preliminaryAllowances += MARRIAGE_ALLOWANCE_TRANSFER;
            if (allowancesConfig.tradingAllowance && category !== 'Company') preliminaryAllowances += TRADING_ALLOWANCE;
            if (allowancesConfig.propertyAllowance && category !== 'Company') preliminaryAllowances += PROPERTY_ALLOWANCE;
            const preliminaryTaxableIncome = Math.max(0, totalIncome - preliminaryAllowances - totalExpenses);

            // Phase 2: Collect advanced tax planning data
            const advancedTaxData = {
                studentLoan: calculateStudentLoan(
                    totalIncome,
                    document.getElementById('studentLoanPlan').value
                ),
                pension: calculatePension(
                    totalIncome,
                    parseFloat(document.getElementById('employerPension').value) || 0,
                    parseFloat(document.getElementById('employeePension').value) || 0,
                    document.getElementById('pensionContribType').value,
                    document.getElementById('pensionMethod').value
                ),
                childcare: calculateChildcare(
                    parseInt(document.getElementById('numChildren').value) || 0,
                    parseInt(document.getElementById('numDisabledChildren').value) || 0,
                    parseFloat(document.getElementById('childcareExpenses').value) || 0,
                    totalIncome
                ),
                giftAid: calculateGiftAid(
                    parseFloat(document.getElementById('charitableDonations').value) || 0,
                    totalIncome
                ),
                dividend: calculateDividendTax(
                    parseFloat(document.getElementById('dividendIncome').value) || 0,
                    preliminaryTaxableIncome
                ),
                savings: calculateSavingsTax(
                    parseFloat(document.getElementById('savingsInterest').value) || 0,
                    preliminaryTaxableIncome,
                    totalIncome
                )
            };

            // Add advanced tax data to taxConfig
            taxConfig.advancedTax = advancedTaxData;

            const result = calculateTax(totalIncome, totalExpenses, allowancesConfig, category, taxConfig);

            // Display basic information
            document.getElementById('resultCategory').innerHTML = `<strong>Tax Category:</strong> ${CATEGORY_CONFIG[category].name}`;
            document.getElementById('resultIncome').textContent = `Gross Income: ¬£${totalIncome.toFixed(2)}`;
            document.getElementById('resultExpenses').textContent = `Expenses: ¬£${totalExpenses.toFixed(2)}`;
            
            // Display allowances breakdown
            let allowancesText = `Total Allowances: ¬£${result.totalAllowances.toFixed(2)}`;
            if (result.allowancesList.length > 0) {
                allowancesText += '\n  ‚Ä¢ ' + result.allowancesList.join('\n  ‚Ä¢ ');
            }
            document.getElementById('resultAllowances').innerHTML = allowancesText.replace(/\n/g, '<br>');
            
            document.getElementById('resultTaxableIncome').textContent = `Taxable Income: ¬£${Math.max(0, result.taxableIncome).toFixed(2)}`;
            
            // Display Income Tax
            if (category !== 'Company') {
                document.getElementById('resultTax').innerHTML = `<strong>Income Tax Due:</strong> ¬£${result.incomeTax.toFixed(2)}`;
            } else {
                document.getElementById('resultTax').innerHTML = '';
            }

            // Display category-specific taxes
            const resultVAT = document.getElementById('resultVAT');
            const resultPAYE = document.getElementById('resultPAYE');
            const resultCompanyTax = document.getElementById('resultCompanyTax');
            const resultCGT = document.getElementById('resultCGT');

            // Hide all initially
            resultVAT.style.display = 'none';
            resultPAYE.style.display = 'none';
            resultCompanyTax.style.display = 'none';
            resultCGT.style.display = 'none';

            // Show relevant tax sections
            if (result.vat > 0) {
                resultVAT.style.display = 'block';
                resultVAT.innerHTML = `<strong>VAT Due:</strong> ¬£${result.vat.toFixed(2)}<br>
                    <small>VAT Rate: ${(taxConfig.vatRate * 100).toFixed(0)}% on ¬£${totalIncome.toFixed(2)}</small>`;
            }

            if (result.paye > 0) {
                resultPAYE.style.display = 'block';
                resultPAYE.innerHTML = `<strong>National Insurance (PAYE):</strong> ¬£${result.paye.toFixed(2)}<br>
                    <small>Employee NI at ${(NI_RATE * 100).toFixed(0)}% on income above ¬£${NI_PRIMARY_THRESHOLD}</small>`;
            }

            if (result.companyTax > 0) {
                resultCompanyTax.style.display = 'block';
                const taxRate = (taxConfig.companyTaxRate * 100).toFixed(0);
                resultCompanyTax.innerHTML = `<strong>Corporation Tax Due:</strong> ¬£${result.companyTax.toFixed(2)}<br>
                    <small>Corporation Tax at ${taxRate}% on profit of ¬£${(totalIncome - totalExpenses).toFixed(2)}</small>`;
            }

            if (result.cgt > 0) {
                resultCGT.style.display = 'block';
                const taxableGains = Math.max(0, taxConfig.capitalGains - CGT_ANNUAL_EXEMPT_AMOUNT);
                resultCGT.innerHTML = `<strong>Capital Gains Tax Due:</strong> ¬£${result.cgt.toFixed(2)}<br>
                    <small>On taxable gains of ¬£${taxableGains.toFixed(2)} (after ¬£${CGT_ANNUAL_EXEMPT_AMOUNT} exemption)</small>`;
            }

            // Phase 2: Display advanced tax results
            const advancedTaxResultsDiv = document.getElementById('advancedTaxResults');
            const resultStudentLoan = document.getElementById('resultStudentLoan');
            const resultPension = document.getElementById('resultPension');
            const resultChildcare = document.getElementById('resultChildcare');
            const resultGiftAid = document.getElementById('resultGiftAid');
            const resultDividend = document.getElementById('resultDividend');
            const resultSavings = document.getElementById('resultSavings');

            // Hide all advanced results initially
            advancedTaxResultsDiv.style.display = 'none';
            resultStudentLoan.style.display = 'none';
            resultPension.style.display = 'none';
            resultChildcare.style.display = 'none';
            resultGiftAid.style.display = 'none';
            resultDividend.style.display = 'none';
            resultSavings.style.display = 'none';

            let hasAdvancedResults = false;

            // Student Loan Repayments
            if (result.advancedTax && result.advancedTax.studentLoan.annual > 0) {
                hasAdvancedResults = true;
                resultStudentLoan.style.display = 'block';
                const sl = result.advancedTax.studentLoan;
                resultStudentLoan.innerHTML = `
                    <strong>üíº Student Loan Repayments (${sl.planName}):</strong><br>
                    Annual Repayment: ¬£${sl.annual.toFixed(2)}<br>
                    Monthly Repayment: ¬£${sl.monthly.toFixed(2)}<br>
                    <small>${(sl.rate * 100).toFixed(0)}% on income above ¬£${sl.threshold.toLocaleString()}</small>
                `;
            }

            // Pension Contributions
            if (result.advancedTax && result.advancedTax.pension.totalContribution > 0) {
                hasAdvancedResults = true;
                resultPension.style.display = 'block';
                const pension = result.advancedTax.pension;
                let pensionHTML = `
                    <strong>üè¶ Pension Contributions:</strong><br>
                    Employer Contribution: ¬£${pension.employerContribution.toFixed(2)}<br>
                    Employee Contribution: ¬£${pension.employeeContribution.toFixed(2)}<br>
                    Total Annual Contribution: ¬£${pension.totalContribution.toFixed(2)}<br>
                    <strong>Tax Relief:</strong> ¬£${pension.totalRelief.toFixed(2)}<br>
                `;
                
                if (pension.method === 'relief') {
                    pensionHTML += `<small>Basic rate relief (20%): ¬£${pension.basicRateRelief.toFixed(2)}`;
                    if (pension.higherRateRelief > 0) {
                        pensionHTML += `<br>Higher rate relief to claim: ¬£${pension.higherRateRelief.toFixed(2)}`;
                    }
                    if (pension.additionalRateRelief > 0) {
                        pensionHTML += `<br>Additional rate relief to claim: ¬£${pension.additionalRateRelief.toFixed(2)}`;
                    }
                    pensionHTML += `</small>`;
                } else {
                    pensionHTML += `<small>Salary sacrifice - immediate tax relief at ${totalIncome > 125140 ? '45%' : totalIncome > 50270 ? '40%' : '20%'}</small>`;
                }

                if (pension.exceedsAllowance) {
                    pensionHTML += `<br><span style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è Warning: Exceeds annual allowance of ¬£${PENSION_ANNUAL_ALLOWANCE.toLocaleString()}</span>`;
                }

                resultPension.innerHTML = pensionHTML;
            }

            // Childcare Tax Relief
            if (result.advancedTax && result.advancedTax.childcare.actualRelief > 0) {
                hasAdvancedResults = true;
                resultChildcare.style.display = 'block';
                const childcare = result.advancedTax.childcare;
                let childcareHTML = `
                    <strong>üë∂ Tax-Free Childcare:</strong><br>
                    Government Contribution: ¬£${childcare.governmentContribution.toFixed(2)}<br>
                    Your Contribution: ¬£${childcare.parentContribution.toFixed(2)}<br>
                    Maximum Available: ¬£${childcare.maxRelief.toFixed(2)}<br>
                    <small>Government adds ¬£20 for every ¬£80 you pay (25% contribution)</small>
                `;

                if (childcare.exceedsLimit) {
                    childcareHTML += `<br><span style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è Warning: Income exceeds ¬£${CHILDCARE_INCOME_LIMIT.toLocaleString()} per parent limit</span>`;
                }

                resultChildcare.innerHTML = childcareHTML;
            }

            // Gift Aid
            if (result.advancedTax && result.advancedTax.giftAid.charityGets > 0) {
                hasAdvancedResults = true;
                resultGiftAid.style.display = 'block';
                const giftAid = result.advancedTax.giftAid;
                let giftAidHTML = `
                    <strong>üéÅ Gift Aid:</strong><br>
                    Your Donation: ¬£${(giftAid.charityGets - giftAid.giftAidAmount).toFixed(2)}<br>
                    Charity Receives: ¬£${giftAid.charityGets.toFixed(2)}<br>
                    Gift Aid to Charity: ¬£${giftAid.giftAidAmount.toFixed(2)}<br>
                `;

                if (giftAid.totalTaxpayerRelief > 0) {
                    giftAidHTML += `<strong>Your Tax Relief:</strong> ¬£${giftAid.totalTaxpayerRelief.toFixed(2)}<br>`;
                    giftAidHTML += `<small>You can claim back this additional relief on your tax return</small>`;
                }

                resultGiftAid.innerHTML = giftAidHTML;
            }

            // Dividend Tax
            if (result.advancedTax && result.advancedTax.dividend.dividendTax > 0) {
                hasAdvancedResults = true;
                resultDividend.style.display = 'block';
                const dividend = result.advancedTax.dividend;
                let dividendHTML = `
                    <strong>üìä Dividend Tax:</strong><br>
                    Total Dividend Income: ¬£${(dividend.taxableDividends + dividend.allowanceUsed).toFixed(2)}<br>
                    Tax-Free Allowance Used: ¬£${dividend.allowanceUsed.toFixed(2)}<br>
                    Taxable Dividends: ¬£${dividend.taxableDividends.toFixed(2)}<br>
                    <strong>Dividend Tax Due:</strong> ¬£${dividend.dividendTax.toFixed(2)}<br>
                `;

                if (dividend.strategy) {
                    dividendHTML += `<small><em>${dividend.strategy}</em></small>`;
                }

                resultDividend.innerHTML = dividendHTML;
            }

            // Savings Interest Tax
            if (result.advancedTax && result.advancedTax.savings.savingsTax > 0) {
                hasAdvancedResults = true;
                resultSavings.style.display = 'block';
                const savings = result.advancedTax.savings;
                const totalSavings = savings.taxableSavings + savings.allowanceUsed + savings.startingRateUsed;
                let savingsHTML = `
                    <strong>üí∞ Savings Interest Tax:</strong><br>
                    Total Savings Interest: ¬£${totalSavings.toFixed(2)}<br>
                `;

                if (savings.startingRateUsed > 0) {
                    savingsHTML += `Starting Rate (¬£5,000 @ 0%): ¬£${savings.startingRateUsed.toFixed(2)}<br>`;
                }
                
                savingsHTML += `Personal Savings Allowance: ¬£${savings.allowanceUsed.toFixed(2)}<br>`;
                savingsHTML += `Taxable Savings: ¬£${savings.taxableSavings.toFixed(2)}<br>`;
                savingsHTML += `<strong>Savings Tax Due:</strong> ¬£${savings.savingsTax.toFixed(2)}<br>`;
                savingsHTML += `<small>Tax rate: ${savings.taxBand === 'basic' ? '20%' : savings.taxBand === 'higher' ? '40%' : '45%'}</small>`;

                resultSavings.innerHTML = savingsHTML;
            }

            // Show advanced tax results container if any results
            if (hasAdvancedResults) {
                advancedTaxResultsDiv.style.display = 'block';
            }

            // Display total tax
            document.getElementById('resultTotalTax').innerHTML = `<strong>Total Tax Due:</strong> ¬£${result.totalTax.toFixed(2)}`;
            
            document.getElementById('results').style.display = 'block';
        });

        // Phase 2: Add event listeners to auto-save advanced tax settings
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default for date inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('incomeDate').value = today;
            document.getElementById('expenseDate').value = today;
            
            const advancedTaxFields = [
                'studentLoanPlan', 'pensionContribType', 'employerPension', 'employeePension',
                'pensionMethod', 'numChildren', 'numDisabledChildren', 'childcareExpenses',
                'charitableDonations', 'dividendIncome', 'savingsInterest'
            ];

            advancedTaxFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('change', saveAdvancedTaxSettings);
                    // Also save on blur for text inputs
                    if (element.tagName === 'INPUT') {
                        element.addEventListener('blur', saveAdvancedTaxSettings);
                    }
                }
            });
        });

        // Initialize app on page load
        initializeApp();
    </script>
</body>
</html>
