public class UKTaxAccountingApp {

    /* ===================== ENUMS ===================== */

    enum EntityType {
        COMPANY,
        DIRECTOR,
        SOLE_TRADER,
        LANDLORD
    }

    /* ===================== CONFIG (HMRC RULES) ===================== */

    static class TaxConfig {

        // Income Tax
        double PERSONAL_ALLOWANCE = 12_570;
        double BASIC_RATE_LIMIT = 50_270;
        double BASIC_RATE = 0.20;
        double HIGHER_RATE = 0.40;
        double ADDITIONAL_RATE = 0.45;

        // Corporation Tax
        double CORPORATION_TAX_RATE = 0.25;

        // Dividends
        double DIVIDEND_ALLOWANCE = 1_000;
        double DIVIDEND_BASIC_RATE = 0.0875;

        // National Insurance (simplified)
        double EMPLOYEE_NI_RATE = 0.12;
        double EMPLOYER_NI_RATE = 0.138;

        // VAT
        double VAT_RATE = 0.20;

        // Pension relief
        double PENSION_RELIEF_RATE = 0.20;
    }

    /* ===================== FINANCIAL PROFILE ===================== */

    static class FinancialProfile {
        EntityType entityType;

        double grossIncome;
        double allowableExpenses;
        double pensionContributions;

        // VAT
        double vatSales;
        double vatPurchases;

        // Director
        double salary;
        double dividends;

        FinancialProfile(EntityType entityType) {
            this.entityType = entityType;
        }
    }

    /* ===================== TAX ENGINE ===================== */

    static class TaxCalculator {

        private final TaxConfig cfg;

        TaxCalculator(TaxConfig cfg) {
            this.cfg = cfg;
        }

        double calculateTotalTax(FinancialProfile p) {
            return switch (p.entityType) {
                case COMPANY -> companyTax(p);
                case DIRECTOR -> directorTax(p);
                case SOLE_TRADER -> soleTraderTax(p);
                case LANDLORD -> landlordTax(p);
            };
        }

        /* ---------- ENTITY LOGIC ---------- */

        private double companyTax(FinancialProfile p) {
            double profit =
                    p.grossIncome
                  - p.allowableExpenses
                  - p.salary;

            double corpTax = Math.max(0, profit * cfg.CORPORATION_TAX_RATE);
            return corpTax + vatDue(p);
        }

        private double directorTax(FinancialProfile p) {
            double incomeTax = incomeTax(p.salary);
            double ni = p.salary * cfg.EMPLOYEE_NI_RATE;
            double dividendTax = dividendTax(p.dividends);
            return incomeTax + ni + dividendTax;
        }

        private double soleTraderTax(FinancialProfile p) {
            double taxable =
                    p.grossIncome
                  - p.allowableExpenses
                  - p.pensionContributions;

            return incomeTax(taxable) + taxable * cfg.EMPLOYEE_NI_RATE;
        }

        private double landlordTax(FinancialProfile p) {
            double rentalProfit = p.grossIncome - p.allowableExpenses;
            return incomeTax(rentalProfit);
        }

        /* ---------- COMMON TAX ---------- */

        private double incomeTax(double income) {
            if (income <= cfg.PERSONAL_ALLOWANCE) return 0;

            double taxable = income - cfg.PERSONAL_ALLOWANCE;
            double tax = 0;

            if (taxable <= cfg.BASIC_RATE_LIMIT) {
                tax += taxable * cfg.BASIC_RATE;
            } else {
                tax += cfg.BASIC_RATE_LIMIT * cfg.BASIC_RATE;
                tax += (taxable - cfg.BASIC_RATE_LIMIT) * cfg.HIGHER_RATE;
            }
            return tax;
        }

        private double dividendTax(double dividends) {
            double taxable = Math.max(0, dividends - cfg.DIVIDEND_ALLOWANCE);
            return taxable * cfg.DIVIDEND_BASIC_RATE;
        }

        private double vatDue(FinancialProfile p) {
            double vat = (p.vatSales - p.vatPurchases) * cfg.VAT_RATE;
            return Math.max(0, vat);
        }
    }

    /* ===================== OPTIMISER ===================== */

    static class TaxOptimizer {

        private final TaxCalculator calculator;

        TaxOptimizer(TaxCalculator calculator) {
            this.calculator = calculator;
        }

        FinancialProfile optimiseDirector(FinancialProfile base) {
            double bestTax = Double.MAX_VALUE;
            FinancialProfile best = null;

            for (double salary = 9_000; salary <= 12_570; salary += 500) {
                FinancialProfile test = clone(base);
                test.salary = salary;
                test.dividends = base.grossIncome - salary;

                double tax = calculator.calculateTotalTax(test);
                if (tax < bestTax) {
                    bestTax = tax;
                    best = test;
                }
            }
            return best;
        }

        private FinancialProfile clone(FinancialProfile p) {
            FinancialProfile c = new FinancialProfile(p.entityType);
            c.grossIncome = p.grossIncome;
            c.allowableExpenses = p.allowableExpenses;
            c.pensionContributions = p.pensionContributions;
            c.vatSales = p.vatSales;
            c.vatPurchases = p.vatPurchases;
            return c;
        }
    }

    /* ===================== DEMO ===================== */

    public static void main(String[] args) {

        TaxConfig config = new TaxConfig();
        TaxCalculator calculator = new TaxCalculator(config);
        TaxOptimizer optimizer = new TaxOptimizer(calculator);

        FinancialProfile director = new FinancialProfile(EntityType.DIRECTOR);
        director.grossIncome = 80_000;
        director.allowableExpenses = 5_000;

        FinancialProfile optimal = optimizer.optimiseDirector(director);

        System.out.println("Optimised Salary: " + optimal.salary);
        System.out.println("Optimised Dividends: " + optimal.dividends);
        System.out.println("Total Tax: " + calculator.calculateTotalTax(optimal));
    }
}
