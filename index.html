<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Tax Calculator & Accounting Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        h1 {
            margin-bottom: 20px;
            color: #0056b3;
        }
        h2 {
            margin-top: 30px;
            margin-bottom: 15px;
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 5px;
        }
        h3 {
            color: #0056b3;
            margin-top: 20px;
        }
        form > div {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"], input[type="text"], input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #fff;
            cursor: pointer;
        }
        input[type="submit"], button {
            background: #0056b3;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        input[type="submit"]:hover, button:hover {
            background: #003f7f;
        }
        button.delete-btn {
            background: #dc3545;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        button.delete-btn:hover {
            background: #c82333;
        }
        button.edit-btn {
            background: #28a745;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        button.edit-btn:hover {
            background: #218838;
        }
        .results {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #f9f9f9;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .entry-form {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        table th, table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        table th {
            background-color: #0056b3;
            color: #fff;
            font-weight: bold;
        }
        table tr:hover {
            background-color: #f5f5f5;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .summary-card {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .summary-card.income {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        .summary-card.expense {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }
        .summary-card.profit {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
        }
        .summary-card h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .summary-card .amount {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }
        .no-entries {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>UK Tax Calculator & Accounting Manager</h1>

        <!-- Income Tracking Section -->
        <div class="section">
            <h2>Income Tracking</h2>
            <div class="entry-form">
                <div>
                    <label for="incomeDate">Date:</label>
                    <input type="date" id="incomeDate" value="">
                </div>
                <div>
                    <label for="incomeAccount">Account:</label>
                    <select id="incomeAccount">
                        <option value="">-- Select Income Account --</option>
                    </select>
                </div>
                <div>
                    <label for="incomeDescription">Description:</label>
                    <input type="text" id="incomeDescription" placeholder="e.g., Salary, Freelance Work">
                </div>
                <div>
                    <label for="incomeAmount">Amount (£):</label>
                    <input type="number" id="incomeAmount" placeholder="0.00" step="0.01">
                </div>
                <div>
                    <label for="incomeVatRate">VAT Rate:</label>
                    <select id="incomeVatRate">
                        <option value="0">No VAT (0%)</option>
                        <option value="0.20">Standard (20%)</option>
                        <option value="0.05">Reduced (5%)</option>
                        <option value="0.00">Zero Rated (0%)</option>
                    </select>
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button type="button" onclick="addIncome()">Add Income</button>
                </div>
            </div>
            <div id="incomeList"></div>
        </div>

        <!-- Expense Tracking Section -->
        <div class="section">
            <h2>Expense Tracking</h2>
            <div class="entry-form">
                <div>
                    <label for="expenseDate">Date:</label>
                    <input type="date" id="expenseDate" value="">
                </div>
                <div>
                    <label for="expenseAccount">Account:</label>
                    <select id="expenseAccount">
                        <option value="">-- Select Expense Account --</option>
                    </select>
                </div>
                <div>
                    <label for="expenseDescription">Description:</label>
                    <input type="text" id="expenseDescription" placeholder="e.g., Office Supplies, Travel">
                </div>
                <div>
                    <label for="expenseAmount">Amount (£):</label>
                    <input type="number" id="expenseAmount" placeholder="0.00" step="0.01">
                </div>
                <div>
                    <label>Tax Deductible:</label>
                    <span id="expenseDeductibleInfo" style="color: #28a745; font-weight: bold;">100%</span>
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button type="button" onclick="addExpense()">Add Expense</button>
                </div>
            </div>
            <div id="expenseList"></div>
        </div>

        <!-- Mileage Allowance Tracker Section -->
        <div class="section">
            <h2>Mileage Allowance Tracker</h2>
            <div class="entry-form">
                <div>
                    <label for="mileageDate">Date:</label>
                    <input type="date" id="mileageDate" value="">
                </div>
                <div>
                    <label for="vehicleType">Vehicle Type:</label>
                    <select id="vehicleType" onchange="updateMileageRateDisplay()">
                        <option value="car">Car/Van</option>
                        <option value="motorcycle">Motorcycle</option>
                        <option value="bicycle">Bicycle</option>
                    </select>
                </div>
                <div>
                    <label for="businessMiles">Business Miles:</label>
                    <input type="number" id="businessMiles" placeholder="0" step="0.1" min="0">
                </div>
                <div>
                    <label for="employerRate">Employer Reimbursement Rate (£/mile):</label>
                    <input type="number" id="employerRate" placeholder="0.00" step="0.01" min="0" value="0">
                </div>
                <div>
                    <label for="mileageDescription">Description (optional):</label>
                    <input type="text" id="mileageDescription" placeholder="e.g., Client visit, Site inspection">
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button type="button" onclick="addMileageEntry()">Add Mileage Entry</button>
                </div>
            </div>
            <div id="mileageRateInfo" style="margin-top: 10px; padding: 10px; background: #e8f4f8; border-radius: 4px; font-size: 0.9em;">
                <strong>HMRC Rate:</strong> <span id="hmrcRateDisplay">First 10,000 miles @ 45p/mile, Over 10,000 miles @ 25p/mile</span>
            </div>
            <div id="mileageList"></div>
            <div id="mileageSummary" style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 4px; display: none;">
                <h3 style="margin-top: 0; color: #0056b3;">Mileage Summary</h3>
                <p><strong>Total Business Miles:</strong> <span id="totalMiles">0</span> miles</p>
                <p><strong>HMRC Allowable Amount:</strong> £<span id="totalHmrcAmount">0.00</span></p>
                <p><strong>Employer Reimbursement:</strong> £<span id="totalEmployerAmount">0.00</span></p>
                <p><strong>Tax Relief Claimable:</strong> £<span id="totalTaxRelief">0.00</span></p>
            </div>
        </div>

        <!-- Chart of Accounts Section -->
        <div class="section">
            <h2>Chart of Accounts</h2>
            <p style="color: #666; margin-bottom: 15px;">
                View and manage your UK standard Chart of Accounts. Accounts are organized by category.
            </p>
            <button type="button" onclick="toggleChartOfAccounts()" style="margin-bottom: 15px;">
                <span id="coaToggleText">View All Accounts</span>
            </button>
            <div id="chartOfAccountsDisplay" style="display: none;">
                <!-- COA will be populated here -->
            </div>
        </div>

        <!-- Financial Summary Section -->
        <div class="section">
            <h2>Financial Summary</h2>
            <div class="summary-grid">
                <div class="summary-card income">
                    <h4>Total Income</h4>
                    <div class="amount" id="totalIncome">£0.00</div>
                </div>
                <div class="summary-card expense">
                    <h4>Total Expenses</h4>
                    <div class="amount" id="totalExpenses">£0.00</div>
                </div>
                <div class="summary-card profit">
                    <h4>Net Profit/Loss</h4>
                    <div class="amount" id="netProfit">£0.00</div>
                </div>
            </div>
        </div>

        <!-- Ledger Display Section -->
        <div class="section">
            <h2>Detailed Ledger</h2>
            <div id="ledgerDisplay">
                <p class="no-entries">No entries yet. Add income or expenses to see your ledger.</p>
            </div>
        </div>

        <!-- Enhanced Reports Section -->
        <div class="section">
            <h2>Financial Reports</h2>
            <button type="button" onclick="toggleFinancialReports()" style="margin-bottom: 15px;">
                <span id="reportsToggleText">Show Detailed Reports</span>
            </button>
            <div id="financialReportsDisplay" style="display: none;">
                <!-- Reports will be generated here -->
            </div>
        </div>

        <!-- Tax Calculator Section -->
        <div class="section">
            <h2>Tax Calculator</h2>
            <form id="taxForm">
                <div>
                    <label for="category">Select Tax Category:</label>
                    <select id="category" name="category" required onchange="updateTaxFields()">
                        <option value="">-- Select a category --</option>
                        <option value="SoleTrader">Sole Trader</option>
                        <option value="Director">Director</option>
                        <option value="Employee">Employee</option>
                        <option value="Company">Company</option>
                        <option value="Landlords">Landlords</option>
                    </select>
                </div>
                <div>
                    <label for="allowances">Include Personal Allowance (£12,570)?</label>
                    <select id="allowances" name="allowances" required>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div>
                    <label for="blindPersonsAllowance">
                        Blind Person's Allowance (£3,130)
                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                            - Additional tax-free allowance if registered blind
                        </span>
                    </label>
                    <select id="blindPersonsAllowance" name="blindPersonsAllowance">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div>
                    <label for="marriageAllowance">
                        Marriage/Civil Partnership Allowance (£1,260 transfer)
                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                            - Transfer £1,260 to spouse/partner (saves up to £252 in tax)
                        </span>
                    </label>
                    <select id="marriageAllowance" name="marriageAllowance">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div>
                    <label for="tradingAllowance">
                        Trading Allowance (£1,000)
                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                            - Tax-free allowance for trading/self-employment income
                        </span>
                    </label>
                    <select id="tradingAllowance" name="tradingAllowance">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div>
                    <label for="propertyAllowance">
                        Property Allowance (£1,000)
                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                            - Tax-free allowance for property income
                        </span>
                    </label>
                    <select id="propertyAllowance" name="propertyAllowance">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div id="dividendAllowanceDiv">
                    <label for="dividendAllowance">
                        Dividend Allowance (£500)
                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                            - Tax-free dividend income (applicable to Directors/Shareholders)
                        </span>
                    </label>
                    <select id="dividendAllowance" name="dividendAllowance">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div id="personalSavingsAllowanceDiv">
                    <label for="personalSavingsAllowance">
                        Personal Savings Allowance
                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                            - Basic rate: £1,000 | Higher rate: £500 | Additional rate: £0
                        </span>
                    </label>
                    <select id="personalSavingsAllowance" name="personalSavingsAllowance">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div id="savingsIncomeDiv" style="display: none; margin-left: 20px;">
                    <label for="savingsIncome">
                        Savings Interest Income (£):
                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                            - Enter total savings interest received
                        </span>
                    </label>
                    <input type="number" id="savingsIncome" name="savingsIncome" placeholder="0.00" step="0.01" min="0" value="0">
                </div>
                <div id="rentARoomReliefDiv">
                    <label for="rentARoomRelief">
                        Rent-a-Room Relief (£7,500)
                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                            - Tax-free rental income for renting a room in your home
                        </span>
                    </label>
                    <select id="rentARoomRelief" name="rentARoomRelief">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div id="dividendIncomeDiv" style="display: none; margin-left: 20px;">
                    <label for="dividendIncome">
                        Dividend Income (£):
                        <span style="color: #666; font-size: 0.9em; font-weight: normal;">
                            - Enter total dividend income received
                        </span>
                    </label>
                    <input type="number" id="dividendIncome" name="dividendIncome" placeholder="0.00" step="0.01" min="0" value="0">
                </div>
                
                <!-- Category-Specific Tax Fields -->
                <div id="categorySpecificFields" style="display: none;">
                    <!-- VAT Section -->
                    <div id="vatSection" style="display: none; margin-top: 20px; padding: 15px; background: #e8f4f8; border-radius: 5px;">
                        <h3 style="margin-top: 0; color: #0056b3;">VAT Calculation</h3>
                        <div>
                            <label for="vatRegistered">VAT Registered?</label>
                            <select id="vatRegistered" name="vatRegistered" onchange="toggleVATFields()">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                        <div id="vatFields" style="display: none; margin-top: 10px;">
                            <div style="margin-bottom: 10px;">
                                <label for="vatRate">VAT Rate:</label>
                                <select id="vatRate" name="vatRate">
                                    <option value="0.20">Standard (20%)</option>
                                    <option value="0.05">Reduced (5%)</option>
                                    <option value="0.00">Zero (0%)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PAYE Section -->
                    <div id="payeSection" style="display: none; margin-top: 20px; padding: 15px; background: #f8e8f8; border-radius: 5px;">
                        <h3 style="margin-top: 0; color: #0056b3;">PAYE (Pay As You Earn)</h3>
                        <p style="margin: 0; color: #666; font-size: 0.95em;">
                            PAYE includes Income Tax and National Insurance deducted from salary
                        </p>
                    </div>
                    
                    <!-- Company Tax Section -->
                    <div id="companyTaxSection" style="display: none; margin-top: 20px; padding: 15px; background: #f8f8e8; border-radius: 5px;">
                        <h3 style="margin-top: 0; color: #0056b3;">Corporation Tax</h3>
                        <div>
                            <label for="companyTaxRate">Company Size:</label>
                            <select id="companyTaxRate" name="companyTaxRate">
                                <option value="0.19">Small Profits Rate (19%)</option>
                                <option value="0.25">Main Rate (25%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- CGT Section -->
                    <div id="cgtSection" style="display: none; margin-top: 20px; padding: 15px; background: #e8f8e8; border-radius: 5px;">
                        <h3 style="margin-top: 0; color: #0056b3;">Capital Gains Tax (CGT)</h3>
                        <div>
                            <label for="capitalGains">Capital Gains Amount (£):</label>
                            <input type="number" id="capitalGains" name="capitalGains" placeholder="0.00" step="0.01" value="0">
                        </div>
                        <div style="margin-top: 10px;">
                            <label for="cgtType">Asset Type:</label>
                            <select id="cgtType" name="cgtType">
                                <option value="property">Property (18%/28%)</option>
                                <option value="other">Other Assets (10%/20%)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <input type="submit" value="Calculate Tax">
            </form>
            <div class="results" id="results" style="display: none;">
                <h3>Tax Summary</h3>
                <p id="resultCategory"></p>
                <p id="resultIncome"></p>
                <p id="resultExpenses"></p>
                <p id="resultAllowances"></p>
                <p id="resultTaxableIncome"></p>
                <p id="resultTax"></p>
                <div id="resultVAT" style="display: none; margin-top: 15px; padding: 10px; background: #e8f4f8; border-radius: 5px;"></div>
                <div id="resultPAYE" style="display: none; margin-top: 15px; padding: 10px; background: #f8e8f8; border-radius: 5px;"></div>
                <div id="resultCompanyTax" style="display: none; margin-top: 15px; padding: 10px; background: #f8f8e8; border-radius: 5px;"></div>
                <div id="resultCGT" style="display: none; margin-top: 15px; padding: 10px; background: #e8f8e8; border-radius: 5px;"></div>
                <p id="resultTotalTax" style="font-weight: bold; font-size: 1.2em; margin-top: 15px; padding-top: 15px; border-top: 2px solid #0056b3;"></p>
            </div>
        </div>
    </div>
    <script>
        // Constants for 2025/26 Tax Year
        const PERSONAL_ALLOWANCE = 12570; // UK Personal allowance threshold
        const BLIND_PERSONS_ALLOWANCE = 3130; // Blind Person's Allowance 2025/26
        const MARRIAGE_ALLOWANCE_TRANSFER = 1260; // Marriage/Civil Partnership Allowance transfer amount
        const MARRIAGE_ALLOWANCE_SAVINGS = 252; // Maximum tax savings from Marriage Allowance (20% of £1,260)
        const TRADING_ALLOWANCE = 1000; // Trading Allowance 2025/26
        const PROPERTY_ALLOWANCE = 1000; // Property Allowance 2025/26
        const CGT_ANNUAL_EXEMPT_AMOUNT = 3000; // CGT Annual Exempt Amount 2025/26
        const NI_PRIMARY_THRESHOLD = 12570; // National Insurance Primary Threshold 2025/26
        const NI_RATE = 0.12; // National Insurance rate for employees
        const SMALL_COMPANY_TAX_RATE = 0.19; // Small Profits Rate for Corporation Tax
        const MAIN_COMPANY_TAX_RATE = 0.25; // Main Rate for Corporation Tax

        // Missing allowances 2025/26
        const DIVIDEND_ALLOWANCE = 500; // Tax-free dividend income
        const PERSONAL_SAVINGS_ALLOWANCE = { basic: 1000, higher: 500, additional: 0 };
        const STARTING_RATE_FOR_SAVINGS = 5000; // 0% tax on savings interest
        const STARTING_RATE_THRESHOLD = 17570; // Income threshold for starting rate
        const RENT_A_ROOM_RELIEF = 7500; // Tax-free rental income for renting a room

        // Dividend tax rates 2025/26
        const DIVIDEND_RATES = {
            basic: 0.0875,      // 8.75%
            higher: 0.3375,     // 33.75%
            additional: 0.3935  // 39.35%
        };

        // Mileage rates 2025/26
        const MILEAGE_RATES = {
            car: { first10k: 0.45, over10k: 0.25 },  // 45p/mile first 10k, 25p/mile over
            motorcycle: 0.24,                         // 24p/mile all miles
            bicycle: 0.20                             // 20p/mile all miles
        };

        // Category configuration mapping
        const CATEGORY_CONFIG = {
            SoleTrader: {
                name: 'Sole Trader',
                taxes: ['incomeTax', 'vat'],
                allowances: ['personal', 'trading'],
                description: 'Self-employed individual trading on their own'
            },
            Director: {
                name: 'Director',
                taxes: ['incomeTax', 'paye', 'companyTax'],
                allowances: ['personal'],
                description: 'Company director with PAYE income'
            },
            Employee: {
                name: 'Employee',
                taxes: ['incomeTax', 'paye'],
                allowances: ['personal'],
                description: 'Employed individual with PAYE'
            },
            Company: {
                name: 'Company',
                taxes: ['companyTax', 'vat'],
                allowances: [],
                description: 'Limited company or corporation'
            },
            Landlords: {
                name: 'Landlords',
                taxes: ['incomeTax', 'cgt'],
                allowances: ['personal', 'property'],
                description: 'Property rental income and capital gains'
            }
        };

        // UK Standard Chart of Accounts
        const UK_CHART_OF_ACCOUNTS = {
            // Assets (1000-1999)
            '1000': { name: 'Bank Account', category: 'Asset', vatRate: null, deductible: false, taxable: false },
            '1100': { name: 'Petty Cash', category: 'Asset', vatRate: null, deductible: false, taxable: false },
            '1200': { name: 'Accounts Receivable', category: 'Asset', vatRate: null, deductible: false, taxable: false },
            '1500': { name: 'Fixed Assets', category: 'Asset', vatRate: 'standard', deductible: false, capitalAllowance: true },
            '1600': { name: 'Accumulated Depreciation', category: 'Asset', vatRate: null, deductible: false, taxable: false },
            
            // Liabilities (2000-2999)
            '2000': { name: 'Accounts Payable', category: 'Liability', vatRate: null, deductible: false, taxable: false },
            '2100': { name: 'Credit Cards', category: 'Liability', vatRate: null, deductible: false, taxable: false },
            '2200': { name: 'Loans Payable', category: 'Liability', vatRate: null, deductible: false, taxable: false },
            '2300': { name: 'VAT Payable', category: 'Liability', vatRate: null, deductible: false, taxable: false },
            '2400': { name: 'PAYE/NI Payable', category: 'Liability', vatRate: null, deductible: false, taxable: false },
            
            // Equity (3000-3999)
            '3000': { name: 'Owner\'s Capital', category: 'Equity', vatRate: null, deductible: false, taxable: false },
            '3100': { name: 'Owner\'s Drawings', category: 'Equity', vatRate: null, deductible: false, taxable: false },
            '3200': { name: 'Retained Earnings', category: 'Equity', vatRate: null, deductible: false, taxable: false },
            
            // Income (4000-4999)
            '4000': { name: 'Sales Revenue', category: 'Income', vatRate: 'standard', deductible: false, taxable: true },
            '4100': { name: 'Service Income', category: 'Income', vatRate: 'standard', deductible: false, taxable: true },
            '4200': { name: 'Rental Income', category: 'Income', vatRate: 'exempt', deductible: false, taxable: true },
            '4300': { name: 'Investment Income', category: 'Income', vatRate: null, deductible: false, taxable: true },
            '4400': { name: 'Dividend Income', category: 'Income', vatRate: null, deductible: false, taxable: 'dividends' },
            '4500': { name: 'Other Income', category: 'Income', vatRate: 'standard', deductible: false, taxable: true },
            
            // Cost of Sales (5000-5999)
            '5000': { name: 'Materials & Supplies', category: 'CostOfSales', vatRate: 'standard', deductible: true, taxable: false },
            '5100': { name: 'Direct Labor', category: 'CostOfSales', vatRate: null, deductible: true, taxable: false },
            '5200': { name: 'Subcontractors', category: 'CostOfSales', vatRate: 'standard', deductible: true, taxable: false },
            
            // Expenses (6000-7999)
            '6000': { name: 'Advertising & Marketing', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '6100': { name: 'Bank Charges', category: 'Expense', vatRate: 'exempt', deductible: true, taxable: false },
            '6200': { name: 'Computer & Internet', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '6300': { name: 'Insurance', category: 'Expense', vatRate: 'exempt', deductible: true, taxable: false },
            '6400': { name: 'Legal & Professional', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '6500': { name: 'Office Rent', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '6600': { name: 'Office Expenses', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '6700': { name: 'Office Supplies', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '6800': { name: 'Postage & Delivery', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '6900': { name: 'Printing & Stationery', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '6950': { name: 'Subscriptions', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '6999': { name: 'Entertainment (Non-deductible)', category: 'Expense', vatRate: 'standard', deductible: false, taxable: false },
            '7000': { name: 'Motor Expenses', category: 'Expense', vatRate: 'standard', deductible: true, mileageOption: true, taxable: false },
            '7100': { name: 'Travel & Accommodation', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '7200': { name: 'Telephone', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '7300': { name: 'Utilities', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '7400': { name: 'Wages & Salaries', category: 'Expense', vatRate: null, deductible: true, taxable: false },
            '7500': { name: 'Pension Contributions', category: 'Expense', vatRate: null, deductible: true, taxable: false },
            '7600': { name: 'Training & Development', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '7700': { name: 'Repairs & Maintenance', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false },
            '7800': { name: 'Bad Debts', category: 'Expense', vatRate: null, deductible: true, taxable: false },
            '7900': { name: 'Miscellaneous Expenses', category: 'Expense', vatRate: 'standard', deductible: true, taxable: false }
        };

        // Helper function to get accounts by category
        function getAccountsByCategory(categoryType) {
            return Object.entries(UK_CHART_OF_ACCOUNTS)
                .filter(([code, account]) => account.category === categoryType)
                .sort(([a], [b]) => a.localeCompare(b));
        }

        // Update tax fields based on selected category
        function updateTaxFields() {
            const category = document.getElementById('category').value;
            const categoryFields = document.getElementById('categorySpecificFields');
            const vatSection = document.getElementById('vatSection');
            const payeSection = document.getElementById('payeSection');
            const companyTaxSection = document.getElementById('companyTaxSection');
            const cgtSection = document.getElementById('cgtSection');

            // Hide all category-specific sections initially
            categoryFields.style.display = 'none';
            vatSection.style.display = 'none';
            payeSection.style.display = 'none';
            companyTaxSection.style.display = 'none';
            cgtSection.style.display = 'none';

            if (!category) return;

            // Show category-specific fields
            categoryFields.style.display = 'block';
            const config = CATEGORY_CONFIG[category];
            
            if (config.taxes.includes('vat')) {
                vatSection.style.display = 'block';
            }
            if (config.taxes.includes('paye')) {
                payeSection.style.display = 'block';
            }
            if (config.taxes.includes('companyTax')) {
                companyTaxSection.style.display = 'block';
            }
            if (config.taxes.includes('cgt')) {
                cgtSection.style.display = 'block';
            }

            // Update allowance field visibility
            updateAllowanceFieldsForCategory(category);
        }

        // Update allowance fields based on category
        function updateAllowanceFieldsForCategory(category) {
            if (!CATEGORY_CONFIG[category]) return; // Safety check
            
            const config = CATEGORY_CONFIG[category];
            const tradingAllowanceDiv = document.getElementById('tradingAllowance').parentElement;
            const propertyAllowanceDiv = document.getElementById('propertyAllowance').parentElement;
            const personalAllowanceDiv = document.getElementById('allowances').parentElement;

            // Show/hide allowances based on category
            if (category === 'Company') {
                personalAllowanceDiv.style.display = 'none';
            } else {
                personalAllowanceDiv.style.display = 'block';
            }

            if (config.allowances.includes('trading')) {
                tradingAllowanceDiv.style.display = 'block';
            } else {
                tradingAllowanceDiv.style.display = 'none';
            }

            if (config.allowances.includes('property')) {
                propertyAllowanceDiv.style.display = 'block';
            } else {
                propertyAllowanceDiv.style.display = 'none';
            }
        }

        // Toggle VAT fields
        function toggleVATFields() {
            const vatRegistered = document.getElementById('vatRegistered').value === 'yes';
            document.getElementById('vatFields').style.display = vatRegistered ? 'block' : 'none';
        }

        // Data storage
        let incomeEntries = [];
        let expenseEntries = [];
        let mileageEntries = [];
        let entryIdCounter = 0;
        let mileageIdCounter = 0;

        // Helper function to escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add income entry
        function addIncome() {
            const date = document.getElementById('incomeDate').value;
            const accountCode = document.getElementById('incomeAccount').value;
            const description = document.getElementById('incomeDescription').value.trim();
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const vatRate = parseFloat(document.getElementById('incomeVatRate').value);

            if (!date || !accountCode || !description || !amount || amount <= 0) {
                alert('Please fill in all fields with valid values.');
                return;
            }

            const account = UK_CHART_OF_ACCOUNTS[accountCode];
            const vatAmount = amount * vatRate;

            const entry = {
                id: entryIdCounter++,
                date: date,
                accountCode: accountCode,
                accountName: account.name,
                description: description,
                amount: amount,
                vatRate: vatRate,
                vatAmount: vatAmount,
                category: account.category,
                taxable: account.taxable,
                type: 'income'
            };

            incomeEntries.push(entry);
            document.getElementById('incomeDescription').value = '';
            document.getElementById('incomeAmount').value = '';
            
            updateDisplays();
        }

        // Add expense entry
        function addExpense() {
            const date = document.getElementById('expenseDate').value;
            const accountCode = document.getElementById('expenseAccount').value;
            const description = document.getElementById('expenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);

            if (!date || !accountCode || !description || !amount || amount <= 0) {
                alert('Please fill in all fields with valid values.');
                return;
            }

            const account = UK_CHART_OF_ACCOUNTS[accountCode];
            const vatRate = account.vatRate === 'standard' ? 0.20 :
                          account.vatRate === 'reduced' ? 0.05 : 0;
            const vatAmount = amount * vatRate;

            const entry = {
                id: entryIdCounter++,
                date: date,
                accountCode: accountCode,
                accountName: account.name,
                description: description,
                amount: amount,
                vatRate: vatRate,
                vatAmount: vatAmount,
                category: account.category,
                deductible: account.deductible,
                deductiblePercentage: account.deductible ? 100 : 0,
                type: 'expense'
            };

            expenseEntries.push(entry);
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            
            updateDisplays();
        }

        // Delete entry
        function deleteEntry(id, type) {
            if (confirm('Are you sure you want to delete this entry?')) {
                if (type === 'income') {
                    incomeEntries = incomeEntries.filter(entry => entry.id !== id);
                } else {
                    expenseEntries = expenseEntries.filter(entry => entry.id !== id);
                }
                updateDisplays();
            }
        }

        // Edit entry
        function editEntry(id, type) {
            let entry;
            if (type === 'income') {
                entry = incomeEntries.find(e => e.id === id);
            } else {
                entry = expenseEntries.find(e => e.id === id);
            }

            if (!entry) return;

            const newDescription = prompt('Enter new description:', entry.description);
            if (newDescription === null) return;

            const newAmount = prompt('Enter new amount:', entry.amount);
            if (newAmount === null) return;

            const parsedAmount = parseFloat(newAmount);
            if (!newDescription.trim() || isNaN(parsedAmount) || parsedAmount <= 0) {
                alert('Invalid input. Entry not updated.');
                return;
            }

            entry.description = newDescription.trim();
            entry.amount = parsedAmount;
            updateDisplays();
        }

        // Update all displays
        function updateDisplays() {
            updateIncomeList();
            updateExpenseList();
            updateSummary();
            updateLedger();
        }

        // Update income list
        function updateIncomeList() {
            const container = document.getElementById('incomeList');
            
            if (incomeEntries.length === 0) {
                container.innerHTML = '<p class="no-entries">No income entries yet.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Date</th><th>Account</th><th>Description</th><th>Amount</th><th>VAT</th><th>Actions</th></tr></thead><tbody>';
            incomeEntries.forEach(entry => {
                html += `
                    <tr>
                        <td>${entry.date || 'N/A'}</td>
                        <td>${entry.accountCode ? entry.accountCode + ' - ' + entry.accountName : 'N/A'}</td>
                        <td>${escapeHtml(entry.description)}</td>
                        <td>£${entry.amount.toFixed(2)}</td>
                        <td>${entry.vatAmount ? '£' + entry.vatAmount.toFixed(2) : '£0.00'}</td>
                        <td>
                            <button class="edit-btn" onclick="editEntry(${entry.id}, 'income')">Edit</button>
                            <button class="delete-btn" onclick="deleteEntry(${entry.id}, 'income')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Update expense list
        function updateExpenseList() {
            const container = document.getElementById('expenseList');
            
            if (expenseEntries.length === 0) {
                container.innerHTML = '<p class="no-entries">No expense entries yet.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Date</th><th>Account</th><th>Description</th><th>Amount</th><th>Deductible</th><th>Actions</th></tr></thead><tbody>';
            expenseEntries.forEach(entry => {
                const deductibleStatus = entry.deductible ? '✓ Yes' : '✗ No';
                const deductibleColor = entry.deductible ? '#28a745' : '#dc3545';
                html += `
                    <tr>
                        <td>${entry.date || 'N/A'}</td>
                        <td>${entry.accountCode ? entry.accountCode + ' - ' + entry.accountName : 'N/A'}</td>
                        <td>${escapeHtml(entry.description)}</td>
                        <td>£${entry.amount.toFixed(2)}</td>
                        <td style="color: ${deductibleColor};">${deductibleStatus}</td>
                        <td>
                            <button class="edit-btn" onclick="editEntry(${entry.id}, 'expense')">Edit</button>
                            <button class="delete-btn" onclick="deleteEntry(${entry.id}, 'expense')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Update financial summary
        function updateSummary() {
            const totalIncome = incomeEntries.reduce((sum, entry) => sum + entry.amount, 0);
            const totalExpenses = expenseEntries.reduce((sum, entry) => sum + entry.amount, 0);
            const netProfit = totalIncome - totalExpenses;

            document.getElementById('totalIncome').textContent = `£${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `£${totalExpenses.toFixed(2)}`;
            document.getElementById('netProfit').textContent = `£${netProfit.toFixed(2)}`;
        }

        // Update ledger display
        function updateLedger() {
            const container = document.getElementById('ledgerDisplay');
            const allEntries = [...incomeEntries, ...expenseEntries].sort((a, b) => a.id - b.id);

            if (allEntries.length === 0) {
                container.innerHTML = '<p class="no-entries">No entries yet. Add income or expenses to see your ledger.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Type</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead><tbody>';
            allEntries.forEach(entry => {
                const typeLabel = entry.type === 'income' ? 'Income' : 'Expense';
                html += `
                    <tr>
                        <td><strong>${typeLabel}</strong></td>
                        <td>${escapeHtml(entry.description)}</td>
                        <td>£${entry.amount.toFixed(2)}</td>
                        <td>
                            <button class="edit-btn" onclick="editEntry(${entry.id}, '${entry.type}')">Edit</button>
                            <button class="delete-btn" onclick="deleteEntry(${entry.id}, '${entry.type}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Tax calculation function
        function calculateTax(income, expenses, allowancesConfig, category, taxConfig) {
            const BASIC_TAX_RATE = 0.20;  // 20%
            const HIGHER_TAX_RATE = 0.40; // 40%
            const ADDITIONAL_TAX_RATE = 0.45; // 45%

            const HIGHER_TAX_THRESHOLD = 50270; // Higher rate threshold
            const ADDITIONAL_TAX_THRESHOLD = 125140; // Additional rate threshold

            const result = {
                incomeTax: 0,
                vat: 0,
                paye: 0,
                companyTax: 0,
                cgt: 0,
                totalTax: 0,
                totalAllowances: 0,
                allowancesList: [],
                taxableIncome: 0
            };

            // Calculate allowances (not applicable for Company category)
            if (category !== 'Company') {
                if (allowancesConfig.personalAllowance) {
                    result.totalAllowances += PERSONAL_ALLOWANCE;
                    result.allowancesList.push(`Personal Allowance: £${PERSONAL_ALLOWANCE.toFixed(2)}`);
                }

                if (allowancesConfig.blindPersonsAllowance) {
                    result.totalAllowances += BLIND_PERSONS_ALLOWANCE;
                    result.allowancesList.push(`Blind Person's Allowance: £${BLIND_PERSONS_ALLOWANCE.toFixed(2)}`);
                }

                if (allowancesConfig.marriageAllowance) {
                    result.totalAllowances += MARRIAGE_ALLOWANCE_TRANSFER;
                    result.allowancesList.push(`Marriage Allowance: £${MARRIAGE_ALLOWANCE_TRANSFER.toFixed(2)}`);
                }

                if (allowancesConfig.tradingAllowance) {
                    result.totalAllowances += TRADING_ALLOWANCE;
                    result.allowancesList.push(`Trading Allowance: £${TRADING_ALLOWANCE.toFixed(2)}`);
                }

                if (allowancesConfig.propertyAllowance) {
                    result.totalAllowances += PROPERTY_ALLOWANCE;
                    result.allowancesList.push(`Property Allowance: £${PROPERTY_ALLOWANCE.toFixed(2)}`);
                }

                // New allowances
                if (allowancesConfig.dividendAllowance) {
                    result.totalAllowances += DIVIDEND_ALLOWANCE;
                    result.allowancesList.push(`Dividend Allowance: £${DIVIDEND_ALLOWANCE.toFixed(2)}`);
                }

                if (allowancesConfig.rentARoomRelief) {
                    result.totalAllowances += RENT_A_ROOM_RELIEF;
                    result.allowancesList.push(`Rent-a-Room Relief: £${RENT_A_ROOM_RELIEF.toFixed(2)}`);
                }

                // Mileage allowance (tax relief claimable)
                if (mileageEntries.length > 0) {
                    const totalMileageRelief = mileageEntries.reduce((sum, e) => sum + e.taxRelief, 0);
                    if (totalMileageRelief > 0) {
                        result.totalAllowances += totalMileageRelief;
                        result.allowancesList.push(`Mileage Allowance Relief: £${totalMileageRelief.toFixed(2)}`);
                    }
                }
            }

            // Handle savings income with Personal Savings Allowance
            let savingsIncomeTax = 0;
            if (allowancesConfig.personalSavingsAllowance && taxConfig.savingsIncome > 0) {
                const savingsIncome = taxConfig.savingsIncome;
                
                // Determine PSA based on tax band
                let psaAmount = 0;
                if (taxableIncome <= HIGHER_TAX_THRESHOLD) {
                    psaAmount = PERSONAL_SAVINGS_ALLOWANCE.basic; // £1,000 for basic rate
                } else if (taxableIncome <= ADDITIONAL_TAX_THRESHOLD) {
                    psaAmount = PERSONAL_SAVINGS_ALLOWANCE.higher; // £500 for higher rate
                } else {
                    psaAmount = PERSONAL_SAVINGS_ALLOWANCE.additional; // £0 for additional rate
                }
                
                // Calculate Starting Rate for Savings if applicable
                let startingRateSavings = 0;
                if (taxableIncome < STARTING_RATE_THRESHOLD) {
                    startingRateSavings = Math.min(STARTING_RATE_FOR_SAVINGS, STARTING_RATE_THRESHOLD - taxableIncome);
                }
                
                // Tax-free savings
                const taxFreeSavings = Math.min(savingsIncome, psaAmount + startingRateSavings);
                const taxableSavings = Math.max(0, savingsIncome - taxFreeSavings);
                
                // Calculate tax on taxable savings at appropriate rate
                if (taxableSavings > 0) {
                    if (taxableIncome > ADDITIONAL_TAX_THRESHOLD) {
                        savingsIncomeTax = taxableSavings * ADDITIONAL_TAX_RATE;
                    } else if (taxableIncome > HIGHER_TAX_THRESHOLD) {
                        savingsIncomeTax = taxableSavings * HIGHER_TAX_RATE;
                    } else {
                        savingsIncomeTax = taxableSavings * BASIC_TAX_RATE;
                    }
                }
                
                result.allowancesList.push(`Personal Savings Allowance: £${psaAmount.toFixed(2)}`);
                if (startingRateSavings > 0) {
                    result.allowancesList.push(`Starting Rate for Savings: £${startingRateSavings.toFixed(2)}`);
                }
            }

            // Handle dividend income with Dividend Allowance
            let dividendTax = 0;
            if (taxConfig.dividendIncome > 0) {
                const dividendIncome = taxConfig.dividendIncome;
                const dividendAllowanceAmount = allowancesConfig.dividendAllowance ? DIVIDEND_ALLOWANCE : 0;
                const taxableDividends = Math.max(0, dividendIncome - dividendAllowanceAmount);
                
                if (taxableDividends > 0) {
                    // Determine dividend tax rate based on income band
                    if (taxableIncome > ADDITIONAL_TAX_THRESHOLD) {
                        dividendTax = taxableDividends * DIVIDEND_RATES.additional;
                    } else if (taxableIncome > HIGHER_TAX_THRESHOLD) {
                        dividendTax = taxableDividends * DIVIDEND_RATES.higher;
                    } else {
                        dividendTax = taxableDividends * DIVIDEND_RATES.basic;
                    }
                }
            }

            // Calculate taxable income after allowances and expenses
            let taxableIncome = income - result.totalAllowances - expenses;
            taxableIncome = Math.max(0, taxableIncome);
            result.taxableIncome = taxableIncome;

            // Calculate income tax (for individuals)
            if (category !== 'Company') {
                let remainingIncome = taxableIncome;
                
                // Additional rate (45%) on income above £125,140
                if (remainingIncome > ADDITIONAL_TAX_THRESHOLD) {
                    result.incomeTax += (remainingIncome - ADDITIONAL_TAX_THRESHOLD) * ADDITIONAL_TAX_RATE;
                    remainingIncome = ADDITIONAL_TAX_THRESHOLD;
                }

                // Higher rate (40%) on income between £50,270 and £125,140
                if (remainingIncome > HIGHER_TAX_THRESHOLD) {
                    result.incomeTax += (remainingIncome - HIGHER_TAX_THRESHOLD) * HIGHER_TAX_RATE;
                    remainingIncome = HIGHER_TAX_THRESHOLD;
                }

                // Basic rate (20%) on remaining taxable income
                if (remainingIncome > 0) {
                    result.incomeTax += remainingIncome * BASIC_TAX_RATE;
                }

                // Add savings and dividend taxes
                result.incomeTax += savingsIncomeTax + dividendTax;
            }

            // Calculate PAYE (simplified - includes NI)
            if (taxConfig.includePAYE) {
                if (income > NI_PRIMARY_THRESHOLD) {
                    result.paye = (income - NI_PRIMARY_THRESHOLD) * NI_RATE;
                }
            }

            // Calculate VAT
            if (taxConfig.vatRegistered && taxConfig.vatRate) {
                result.vat = income * taxConfig.vatRate;
            }

            // Calculate Company Tax
            if (category === 'Company') {
                const profit = income - expenses;
                result.companyTax = Math.max(0, profit) * (taxConfig.companyTaxRate || SMALL_COMPANY_TAX_RATE);
            }

            // Calculate CGT
            if (taxConfig.capitalGains && taxConfig.capitalGains > 0) {
                const taxableGains = Math.max(0, taxConfig.capitalGains - CGT_ANNUAL_EXEMPT_AMOUNT);
                let cgtRate = 0.10; // Basic rate for other assets
                
                if (taxConfig.cgtType === 'property') {
                    // Property CGT rates
                    cgtRate = taxableIncome > HIGHER_TAX_THRESHOLD ? 0.28 : 0.18;
                } else {
                    // Other assets CGT rates
                    cgtRate = taxableIncome > HIGHER_TAX_THRESHOLD ? 0.20 : 0.10;
                }
                
                result.cgt = taxableGains * cgtRate;
            }

            // Calculate total tax
            result.totalTax = result.incomeTax + result.vat + result.paye + result.companyTax + result.cgt;

            return result;
        }

        // Tax form submission
        document.getElementById('taxForm').addEventListener('submit', function(event) {
            event.preventDefault();

            // Validate category selection
            const category = document.getElementById('category').value;
            if (!category) {
                alert('Please select a tax category first.');
                return;
            }

            // Use ledger data if available, otherwise show message
            const totalIncome = incomeEntries.reduce((sum, entry) => sum + entry.amount, 0);
            const totalExpenses = expenseEntries.reduce((sum, entry) => sum + entry.amount, 0);

            if (totalIncome === 0 && totalExpenses === 0) {
                alert('No income or expense entries found. Tax calculation will use £0 values.');
            }

            // Get allowance selections
            const allowancesConfig = {
                personalAllowance: document.getElementById('allowances').value === 'yes',
                blindPersonsAllowance: document.getElementById('blindPersonsAllowance').value === 'yes',
                marriageAllowance: document.getElementById('marriageAllowance').value === 'yes',
                tradingAllowance: document.getElementById('tradingAllowance').value === 'yes',
                propertyAllowance: document.getElementById('propertyAllowance').value === 'yes',
                dividendAllowance: document.getElementById('dividendAllowance').value === 'yes',
                personalSavingsAllowance: document.getElementById('personalSavingsAllowance').value === 'yes',
                rentARoomRelief: document.getElementById('rentARoomRelief').value === 'yes'
            };

            // Get tax-specific configuration
            const vatRegisteredElement = document.getElementById('vatRegistered');
            const vatRateElement = document.getElementById('vatRate');
            const vatRegistered = vatRegisteredElement ? vatRegisteredElement.value === 'yes' : false;
            const vatRate = vatRegistered && vatRateElement ? parseFloat(vatRateElement.value) : 0;
            
            const taxConfig = {
                includePAYE: CATEGORY_CONFIG[category].taxes.includes('paye'),
                vatRegistered: vatRegistered,
                vatRate: vatRate,
                companyTaxRate: document.getElementById('companyTaxRate') ? 
                    parseFloat(document.getElementById('companyTaxRate').value) : SMALL_COMPANY_TAX_RATE,
                capitalGains: document.getElementById('capitalGains') ? 
                    parseFloat(document.getElementById('capitalGains').value) || 0 : 0,
                cgtType: document.getElementById('cgtType') ? 
                    document.getElementById('cgtType').value : 'other',
                savingsIncome: parseFloat(document.getElementById('savingsIncome').value) || 0,
                dividendIncome: parseFloat(document.getElementById('dividendIncome').value) || 0
            };

            // Validate allowances combination
            let validationWarnings = [];
            
            // Trading and Property allowances are alternatives to claiming actual expenses in those categories
            // Provide informational notice if expenses exist
            if (allowancesConfig.tradingAllowance && totalExpenses > 0) {
                validationWarnings.push('Note: Trading Allowance (£1,000) is an alternative to claiming actual trading/self-employment expenses. If your trading expenses exceed £1,000, you may be better off claiming actual expenses instead.');
            }
            
            if (allowancesConfig.propertyAllowance && totalExpenses > 0) {
                validationWarnings.push('Note: Property Allowance (£1,000) is an alternative to claiming actual property expenses. If your property expenses exceed £1,000, you may be better off claiming actual expenses instead.');
            }

            // Show validation warnings if any
            if (validationWarnings.length > 0) {
                alert(validationWarnings.join('\n'));
            }

            const result = calculateTax(totalIncome, totalExpenses, allowancesConfig, category, taxConfig);

            // Display basic information
            document.getElementById('resultCategory').innerHTML = `<strong>Tax Category:</strong> ${CATEGORY_CONFIG[category].name}`;
            document.getElementById('resultIncome').textContent = `Gross Income: £${totalIncome.toFixed(2)}`;
            document.getElementById('resultExpenses').textContent = `Expenses: £${totalExpenses.toFixed(2)}`;
            
            // Display allowances breakdown
            let allowancesText = `Total Allowances: £${result.totalAllowances.toFixed(2)}`;
            if (result.allowancesList.length > 0) {
                allowancesText += '\n  • ' + result.allowancesList.join('\n  • ');
            }
            document.getElementById('resultAllowances').innerHTML = allowancesText.replace(/\n/g, '<br>');
            
            document.getElementById('resultTaxableIncome').textContent = `Taxable Income: £${Math.max(0, result.taxableIncome).toFixed(2)}`;
            
            // Display Income Tax
            if (category !== 'Company') {
                document.getElementById('resultTax').innerHTML = `<strong>Income Tax Due:</strong> £${result.incomeTax.toFixed(2)}`;
            } else {
                document.getElementById('resultTax').innerHTML = '';
            }

            // Display category-specific taxes
            const resultVAT = document.getElementById('resultVAT');
            const resultPAYE = document.getElementById('resultPAYE');
            const resultCompanyTax = document.getElementById('resultCompanyTax');
            const resultCGT = document.getElementById('resultCGT');

            // Hide all initially
            resultVAT.style.display = 'none';
            resultPAYE.style.display = 'none';
            resultCompanyTax.style.display = 'none';
            resultCGT.style.display = 'none';

            // Show relevant tax sections
            if (result.vat > 0) {
                resultVAT.style.display = 'block';
                resultVAT.innerHTML = `<strong>VAT Due:</strong> £${result.vat.toFixed(2)}<br>
                    <small>VAT Rate: ${(taxConfig.vatRate * 100).toFixed(0)}% on £${totalIncome.toFixed(2)}</small>`;
            }

            if (result.paye > 0) {
                resultPAYE.style.display = 'block';
                resultPAYE.innerHTML = `<strong>National Insurance (PAYE):</strong> £${result.paye.toFixed(2)}<br>
                    <small>Employee NI at ${(NI_RATE * 100).toFixed(0)}% on income above £${NI_PRIMARY_THRESHOLD}</small>`;
            }

            if (result.companyTax > 0) {
                resultCompanyTax.style.display = 'block';
                const taxRate = (taxConfig.companyTaxRate * 100).toFixed(0);
                resultCompanyTax.innerHTML = `<strong>Corporation Tax Due:</strong> £${result.companyTax.toFixed(2)}<br>
                    <small>Corporation Tax at ${taxRate}% on profit of £${(totalIncome - totalExpenses).toFixed(2)}</small>`;
            }

            if (result.cgt > 0) {
                resultCGT.style.display = 'block';
                const taxableGains = Math.max(0, taxConfig.capitalGains - CGT_ANNUAL_EXEMPT_AMOUNT);
                resultCGT.innerHTML = `<strong>Capital Gains Tax Due:</strong> £${result.cgt.toFixed(2)}<br>
                    <small>On taxable gains of £${taxableGains.toFixed(2)} (after £${CGT_ANNUAL_EXEMPT_AMOUNT} exemption)</small>`;
            }

            // Display total tax
            document.getElementById('resultTotalTax').innerHTML = `<strong>Total Tax Due:</strong> £${result.totalTax.toFixed(2)}`;
            
            document.getElementById('results').style.display = 'block';
        });

        // Populate account dropdowns
        function populateAccountDropdowns() {
            const incomeSelect = document.getElementById('incomeAccount');
            const expenseSelect = document.getElementById('expenseAccount');
            
            // Populate income accounts
            const incomeAccounts = getAccountsByCategory('Income');
            incomeAccounts.forEach(([code, account]) => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} - ${account.name}`;
                incomeSelect.appendChild(option);
            });
            
            // Populate expense accounts (Cost of Sales + Expenses)
            const costOfSalesAccounts = getAccountsByCategory('CostOfSales');
            const expenseAccounts = getAccountsByCategory('Expense');
            const allExpenseAccounts = [...costOfSalesAccounts, ...expenseAccounts];
            
            allExpenseAccounts.forEach(([code, account]) => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} - ${account.name}`;
                expenseSelect.appendChild(option);
            });
            
            // Update expense deductible info when account changes
            expenseSelect.addEventListener('change', function() {
                const accountCode = this.value;
                const deductibleInfo = document.getElementById('expenseDeductibleInfo');
                if (accountCode && UK_CHART_OF_ACCOUNTS[accountCode]) {
                    const account = UK_CHART_OF_ACCOUNTS[accountCode];
                    if (account.deductible) {
                        deductibleInfo.textContent = '100%';
                        deductibleInfo.style.color = '#28a745';
                    } else {
                        deductibleInfo.textContent = 'Non-deductible';
                        deductibleInfo.style.color = '#dc3545';
                    }
                }
            });
            
            // Auto-populate VAT rate when income account changes
            document.getElementById('incomeAccount').addEventListener('change', function() {
                const accountCode = this.value;
                const vatRateSelect = document.getElementById('incomeVatRate');
                if (accountCode && UK_CHART_OF_ACCOUNTS[accountCode]) {
                    const account = UK_CHART_OF_ACCOUNTS[accountCode];
                    if (account.vatRate === 'standard') {
                        vatRateSelect.value = '0.20';
                    } else if (account.vatRate === 'reduced') {
                        vatRateSelect.value = '0.05';
                    } else if (account.vatRate === 'exempt' || account.vatRate === null) {
                        vatRateSelect.value = '0';
                    } else if (account.vatRate === 'zero') {
                        vatRateSelect.value = '0.00';
                    }
                }
            });
        }

        // Set default date to today
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('incomeDate').value = today;
            document.getElementById('expenseDate').value = today;
            document.getElementById('mileageDate').value = today;
        }

        // Toggle Chart of Accounts display
        function toggleChartOfAccounts() {
            const display = document.getElementById('chartOfAccountsDisplay');
            const toggleText = document.getElementById('coaToggleText');
            
            if (display.style.display === 'none') {
                renderChartOfAccounts();
                display.style.display = 'block';
                toggleText.textContent = 'Hide Accounts';
            } else {
                display.style.display = 'none';
                toggleText.textContent = 'View All Accounts';
            }
        }

        // Render Chart of Accounts
        function renderChartOfAccounts() {
            const container = document.getElementById('chartOfAccountsDisplay');
            const categories = ['Asset', 'Liability', 'Equity', 'Income', 'CostOfSales', 'Expense'];
            const categoryColors = {
                'Asset': '#d4edda',
                'Liability': '#f8d7da',
                'Equity': '#d1ecf1',
                'Income': '#d4edda',
                'CostOfSales': '#fff3cd',
                'Expense': '#ffe6e6'
            };
            
            let html = '';
            categories.forEach(category => {
                const accounts = getAccountsByCategory(category);
                if (accounts.length > 0) {
                    const displayName = category === 'CostOfSales' ? 'Cost of Sales' : category;
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h3 style="background: ${categoryColors[category]}; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                                ${displayName}
                            </h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f4f4f9;">
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #0056b3;">Code</th>
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #0056b3;">Account Name</th>
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #0056b3;">VAT</th>
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #0056b3;">Tax Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    accounts.forEach(([code, account]) => {
                        const vatInfo = account.vatRate === 'standard' ? 'Standard (20%)' :
                                      account.vatRate === 'reduced' ? 'Reduced (5%)' :
                                      account.vatRate === 'exempt' ? 'Exempt' :
                                      account.vatRate === null ? 'N/A' : 'Zero Rated';
                        
                        const taxStatus = account.deductible ? '✓ Deductible' :
                                        account.taxable === true ? '✓ Taxable' :
                                        account.taxable === 'dividends' ? 'Dividends' :
                                        account.capitalAllowance ? '✓ Capital Allowance' :
                                        'N/A';
                        
                        html += `
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px;">${code}</td>
                                <td style="padding: 8px;">${account.name}</td>
                                <td style="padding: 8px;">${vatInfo}</td>
                                <td style="padding: 8px;">${taxStatus}</td>
                            </tr>
                        `;
                    });
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        // Update mileage rate display
        function updateMileageRateDisplay() {
            const vehicleType = document.getElementById('vehicleType').value;
            const display = document.getElementById('hmrcRateDisplay');
            
            if (vehicleType === 'car') {
                display.textContent = 'First 10,000 miles @ 45p/mile, Over 10,000 miles @ 25p/mile';
            } else if (vehicleType === 'motorcycle') {
                display.textContent = '24p/mile (all miles)';
            } else if (vehicleType === 'bicycle') {
                display.textContent = '20p/mile (all miles)';
            }
        }

        // Calculate mileage allowance for an entry
        function calculateMileageAllowance(vehicleType, miles, cumulativeMiles = 0) {
            let hmrcAmount = 0;
            
            if (vehicleType === 'car') {
                const milesInFirst10k = Math.max(0, Math.min(miles, 10000 - cumulativeMiles));
                const milesOver10k = miles - milesInFirst10k;
                
                hmrcAmount = (milesInFirst10k * MILEAGE_RATES.car.first10k) + 
                            (milesOver10k * MILEAGE_RATES.car.over10k);
            } else if (vehicleType === 'motorcycle') {
                hmrcAmount = miles * MILEAGE_RATES.motorcycle;
            } else if (vehicleType === 'bicycle') {
                hmrcAmount = miles * MILEAGE_RATES.bicycle;
            }
            
            return hmrcAmount;
        }

        // Add mileage entry
        function addMileageEntry() {
            const date = document.getElementById('mileageDate').value;
            const vehicleType = document.getElementById('vehicleType').value;
            const miles = parseFloat(document.getElementById('businessMiles').value);
            const employerRate = parseFloat(document.getElementById('employerRate').value) || 0;
            const description = document.getElementById('mileageDescription').value.trim() || 'Business mileage';
            
            if (!date || !miles || miles <= 0) {
                alert('Please enter a valid date and mileage.');
                return;
            }
            
            if (miles > 50000) {
                if (!confirm('Warning: Mileage exceeds 50,000 miles. Are you sure this is correct?')) {
                    return;
                }
            }
            
            // Calculate cumulative miles for car/van to apply correct rates
            let cumulativeMiles = 0;
            if (vehicleType === 'car') {
                cumulativeMiles = mileageEntries
                    .filter(e => e.vehicleType === 'car')
                    .reduce((sum, e) => sum + e.miles, 0);
            }
            
            const hmrcAmount = calculateMileageAllowance(vehicleType, miles, cumulativeMiles);
            const employerAmount = miles * employerRate;
            const taxRelief = Math.max(0, hmrcAmount - employerAmount);
            
            const entry = {
                id: mileageIdCounter++,
                date: date,
                description: description,
                vehicleType: vehicleType,
                miles: miles,
                hmrcAmount: hmrcAmount,
                employerRate: employerRate,
                employerAmount: employerAmount,
                taxRelief: taxRelief
            };
            
            mileageEntries.push(entry);
            
            // Clear form
            document.getElementById('businessMiles').value = '';
            document.getElementById('employerRate').value = '0';
            document.getElementById('mileageDescription').value = '';
            
            updateMileageDisplay();
        }

        // Update mileage display
        function updateMileageDisplay() {
            const container = document.getElementById('mileageList');
            const summaryDiv = document.getElementById('mileageSummary');
            
            if (mileageEntries.length === 0) {
                container.innerHTML = '<p class="no-entries">No mileage entries yet.</p>';
                summaryDiv.style.display = 'none';
                return;
            }
            
            // Display entries table
            let html = '<table style="margin-top: 15px;"><thead><tr><th>Date</th><th>Vehicle</th><th>Miles</th><th>HMRC Amount</th><th>Tax Relief</th><th>Actions</th></tr></thead><tbody>';
            mileageEntries.forEach(entry => {
                const vehicleDisplay = entry.vehicleType === 'car' ? 'Car/Van' :
                                      entry.vehicleType === 'motorcycle' ? 'Motorcycle' : 'Bicycle';
                html += `
                    <tr>
                        <td>${entry.date}</td>
                        <td>${vehicleDisplay}</td>
                        <td>${entry.miles.toFixed(1)}</td>
                        <td>£${entry.hmrcAmount.toFixed(2)}</td>
                        <td>£${entry.taxRelief.toFixed(2)}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteMileageEntry(${entry.id})">Delete</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Update summary
            const totalMiles = mileageEntries.reduce((sum, e) => sum + e.miles, 0);
            const totalHmrcAmount = mileageEntries.reduce((sum, e) => sum + e.hmrcAmount, 0);
            const totalEmployerAmount = mileageEntries.reduce((sum, e) => sum + e.employerAmount, 0);
            const totalTaxRelief = mileageEntries.reduce((sum, e) => sum + e.taxRelief, 0);
            
            document.getElementById('totalMiles').textContent = totalMiles.toFixed(1);
            document.getElementById('totalHmrcAmount').textContent = totalHmrcAmount.toFixed(2);
            document.getElementById('totalEmployerAmount').textContent = totalEmployerAmount.toFixed(2);
            document.getElementById('totalTaxRelief').textContent = totalTaxRelief.toFixed(2);
            
            summaryDiv.style.display = 'block';
        }

        // Delete mileage entry
        function deleteMileageEntry(id) {
            if (confirm('Are you sure you want to delete this mileage entry?')) {
                mileageEntries = mileageEntries.filter(entry => entry.id !== id);
                updateMileageDisplay();
            }
        }

        // Toggle Financial Reports Display
        function toggleFinancialReports() {
            const display = document.getElementById('financialReportsDisplay');
            const toggleText = document.getElementById('reportsToggleText');
            
            if (display.style.display === 'none') {
                generateFinancialReports();
                display.style.display = 'block';
                toggleText.textContent = 'Hide Detailed Reports';
            } else {
                display.style.display = 'none';
                toggleText.textContent = 'Show Detailed Reports';
            }
        }

        // Generate all financial reports
        function generateFinancialReports() {
            const container = document.getElementById('financialReportsDisplay');
            
            let html = '';
            
            // 1. Income by Category Report
            html += generateIncomeByCategoryReport();
            
            // 2. Expenses by Category Report
            html += generateExpensesByCategoryReport();
            
            // 3. Profit & Loss Statement
            html += generateProfitAndLossStatement();
            
            // 4. Tax Optimization Summary
            html += generateTaxOptimizationSummary();
            
            // 5. Account Balance Report
            html += generateAccountBalanceReport();
            
            container.innerHTML = html;
        }

        // Generate Income by Category Report
        function generateIncomeByCategoryReport() {
            if (incomeEntries.length === 0) {
                return '<div style="margin-bottom: 30px;"><h3>Income by Category</h3><p style="color: #666;">No income entries yet.</p></div>';
            }
            
            const categoryTotals = {};
            const categoryVAT = {};
            let totalIncome = 0;
            let totalVAT = 0;
            
            incomeEntries.forEach(entry => {
                const category = entry.accountName || 'Uncategorized';
                if (!categoryTotals[category]) {
                    categoryTotals[category] = 0;
                    categoryVAT[category] = 0;
                }
                categoryTotals[category] += entry.amount;
                categoryVAT[category] += entry.vatAmount || 0;
                totalIncome += entry.amount;
                totalVAT += entry.vatAmount || 0;
            });
            
            let html = '<div style="margin-bottom: 30px;"><h3 style="color: #0056b3;">Income by Category</h3>';
            html += '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #0056b3; color: white;"><th style="padding: 10px; text-align: left;">Account</th><th style="padding: 10px; text-align: right;">Amount</th><th style="padding: 10px; text-align: right;">VAT</th><th style="padding: 10px; text-align: right;">%</th></tr></thead><tbody>';
            
            Object.entries(categoryTotals).forEach(([category, amount]) => {
                const percentage = (amount / totalIncome * 100).toFixed(1);
                const vat = categoryVAT[category];
                html += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">${escapeHtml(category)}</td>
                        <td style="padding: 10px; text-align: right; color: #28a745; font-weight: bold;">£${amount.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right;">£${vat.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right;">${percentage}%</td>
                    </tr>
                `;
            });
            
            html += `
                <tr style="background: #f0f0f0; font-weight: bold;">
                    <td style="padding: 10px;">Total</td>
                    <td style="padding: 10px; text-align: right; color: #28a745;">£${totalIncome.toFixed(2)}</td>
                    <td style="padding: 10px; text-align: right;">£${totalVAT.toFixed(2)}</td>
                    <td style="padding: 10px; text-align: right;">100%</td>
                </tr>
            `;
            html += '</tbody></table></div>';
            
            return html;
        }

        // Generate Expenses by Category Report
        function generateExpensesByCategoryReport() {
            if (expenseEntries.length === 0) {
                return '<div style="margin-bottom: 30px;"><h3>Expenses by Category</h3><p style="color: #666;">No expense entries yet.</p></div>';
            }
            
            const categoryTotals = {};
            const categoryDeductible = {};
            let totalExpenses = 0;
            let totalDeductible = 0;
            
            expenseEntries.forEach(entry => {
                const category = entry.accountName || 'Uncategorized';
                if (!categoryTotals[category]) {
                    categoryTotals[category] = 0;
                    categoryDeductible[category] = 0;
                }
                categoryTotals[category] += entry.amount;
                if (entry.deductible) {
                    categoryDeductible[category] += entry.amount;
                    totalDeductible += entry.amount;
                }
                totalExpenses += entry.amount;
            });
            
            let html = '<div style="margin-bottom: 30px;"><h3 style="color: #0056b3;">Expenses by Category</h3>';
            html += '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #0056b3; color: white;"><th style="padding: 10px; text-align: left;">Account</th><th style="padding: 10px; text-align: right;">Amount</th><th style="padding: 10px; text-align: right;">Deductible</th><th style="padding: 10px; text-align: right;">%</th></tr></thead><tbody>';
            
            Object.entries(categoryTotals).forEach(([category, amount]) => {
                const percentage = (amount / totalExpenses * 100).toFixed(1);
                const deductible = categoryDeductible[category] || 0;
                html += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">${escapeHtml(category)}</td>
                        <td style="padding: 10px; text-align: right; color: #dc3545; font-weight: bold;">£${amount.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; color: ${deductible > 0 ? '#28a745' : '#999'};">£${deductible.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right;">${percentage}%</td>
                    </tr>
                `;
            });
            
            // Add mileage expenses if any
            if (mileageEntries.length > 0) {
                const totalMileageRelief = mileageEntries.reduce((sum, e) => sum + e.hmrcAmount, 0);
                const mileagePercentage = (totalMileageRelief / (totalExpenses + totalMileageRelief) * 100).toFixed(1);
                html += `
                    <tr style="border-bottom: 1px solid #ddd; background: #fff3cd;">
                        <td style="padding: 10px;"><strong>Mileage Allowance</strong></td>
                        <td style="padding: 10px; text-align: right; color: #dc3545; font-weight: bold;">£${totalMileageRelief.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; color: #28a745;">£${totalMileageRelief.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right;">${mileagePercentage}%</td>
                    </tr>
                `;
            }
            
            html += `
                <tr style="background: #f0f0f0; font-weight: bold;">
                    <td style="padding: 10px;">Total</td>
                    <td style="padding: 10px; text-align: right; color: #dc3545;">£${totalExpenses.toFixed(2)}</td>
                    <td style="padding: 10px; text-align: right; color: #28a745;">£${totalDeductible.toFixed(2)}</td>
                    <td style="padding: 10px; text-align: right;">100%</td>
                </tr>
            `;
            html += '</tbody></table></div>';
            
            return html;
        }

        // Generate Profit & Loss Statement
        function generateProfitAndLossStatement() {
            const totalIncome = incomeEntries.reduce((sum, e) => sum + e.amount, 0);
            const totalExpenses = expenseEntries.reduce((sum, e) => sum + e.amount, 0);
            const totalMileage = mileageEntries.reduce((sum, e) => sum + e.hmrcAmount, 0);
            const grossProfit = totalIncome;
            const totalCosts = totalExpenses + totalMileage;
            const netProfit = grossProfit - totalCosts;
            
            let html = '<div style="margin-bottom: 30px;"><h3 style="color: #0056b3;">Profit & Loss Statement</h3>';
            html += '<div style="background: #f9f9f9; padding: 20px; border-radius: 4px;">';
            
            html += '<div style="margin-bottom: 20px;"><h4 style="color: #28a745; margin: 0 0 10px 0;">Revenue</h4>';
            html += '<table style="width: 100%;"><tbody>';
            incomeEntries.forEach(entry => {
                html += `<tr><td>${escapeHtml(entry.accountName || 'Income')}</td><td style="text-align: right;">£${entry.amount.toFixed(2)}</td></tr>`;
            });
            html += `<tr style="border-top: 2px solid #28a745; font-weight: bold;"><td>Total Revenue</td><td style="text-align: right; color: #28a745;">£${totalIncome.toFixed(2)}</td></tr>`;
            html += '</tbody></table></div>';
            
            html += '<div style="margin-bottom: 20px;"><h4 style="color: #dc3545; margin: 0 0 10px 0;">Less: Expenses</h4>';
            html += '<table style="width: 100%;"><tbody>';
            expenseEntries.forEach(entry => {
                html += `<tr><td>${escapeHtml(entry.accountName || 'Expense')}</td><td style="text-align: right;">£${entry.amount.toFixed(2)}</td></tr>`;
            });
            if (mileageEntries.length > 0) {
                html += `<tr><td>Mileage Allowance</td><td style="text-align: right;">£${totalMileage.toFixed(2)}</td></tr>`;
            }
            html += `<tr style="border-top: 2px solid #dc3545; font-weight: bold;"><td>Total Expenses</td><td style="text-align: right; color: #dc3545;">£${totalCosts.toFixed(2)}</td></tr>`;
            html += '</tbody></table></div>';
            
            const profitColor = netProfit >= 0 ? '#28a745' : '#dc3545';
            html += `<div style="border-top: 3px solid #0056b3; padding-top: 15px; margin-top: 15px;">`;
            html += `<h4 style="margin: 0;">Net ${netProfit >= 0 ? 'Profit' : 'Loss'}: <span style="color: ${profitColor}; font-size: 1.3em;">£${netProfit.toFixed(2)}</span></h4>`;
            html += '</div></div></div>';
            
            return html;
        }

        // Generate Tax Optimization Summary
        function generateTaxOptimizationSummary() {
            const totalDeductibleExpenses = expenseEntries.filter(e => e.deductible).reduce((sum, e) => sum + e.amount, 0);
            const totalMileageRelief = mileageEntries.reduce((sum, e) => sum + e.taxRelief, 0);
            
            let html = '<div style="margin-bottom: 30px;"><h3 style="color: #0056b3;">Tax Optimization Summary</h3>';
            html += '<div style="background: #e8f4f8; padding: 20px; border-radius: 4px;">';
            
            html += '<table style="width: 100%;"><tbody>';
            html += `<tr><td><strong>Total Deductible Expenses:</strong></td><td style="text-align: right; color: #28a745; font-weight: bold;">£${totalDeductibleExpenses.toFixed(2)}</td></tr>`;
            if (totalMileageRelief > 0) {
                html += `<tr><td><strong>Mileage Allowance Relief:</strong></td><td style="text-align: right; color: #28a745; font-weight: bold;">£${totalMileageRelief.toFixed(2)}</td></tr>`;
            }
            html += `<tr style="border-top: 2px solid #0056b3; margin-top: 10px;"><td><strong>Total Tax Relief Available:</strong></td><td style="text-align: right; color: #0056b3; font-weight: bold; font-size: 1.2em;">£${(totalDeductibleExpenses + totalMileageRelief).toFixed(2)}</td></tr>`;
            html += '</tbody></table>';
            
            html += '<div style="margin-top: 20px; padding: 15px; background: #fff; border-left: 4px solid #0056b3;">';
            html += '<h4 style="margin: 0 0 10px 0; color: #0056b3;">Recommendations:</h4>';
            html += '<ul style="margin: 0; padding-left: 20px;">';
            
            if (totalMileageRelief > 0) {
                html += '<li>You can claim £' + totalMileageRelief.toFixed(2) + ' in mileage tax relief</li>';
            }
            
            if (incomeEntries.length > 0 && expenseEntries.length === 0) {
                html += '<li>Consider tracking business expenses to reduce taxable income</li>';
            }
            
            const hasNonDeductible = expenseEntries.some(e => !e.deductible);
            if (hasNonDeductible) {
                html += '<li>Some expenses are non-deductible. Review entertainment and personal expenses</li>';
            }
            
            html += '<li>Use the Tax Calculator below to see your final tax liability with all allowances</li>';
            html += '<li>Consider pension contributions for additional tax relief</li>';
            html += '</ul></div>';
            
            html += '</div></div>';
            
            return html;
        }

        // Generate Account Balance Report
        function generateAccountBalanceReport() {
            const accountBalances = {};
            const accountCounts = {};
            
            incomeEntries.forEach(entry => {
                const account = entry.accountCode + ' - ' + entry.accountName;
                if (!accountBalances[account]) {
                    accountBalances[account] = 0;
                    accountCounts[account] = 0;
                }
                accountBalances[account] += entry.amount;
                accountCounts[account]++;
            });
            
            expenseEntries.forEach(entry => {
                const account = entry.accountCode + ' - ' + entry.accountName;
                if (!accountBalances[account]) {
                    accountBalances[account] = 0;
                    accountCounts[account] = 0;
                }
                accountBalances[account] -= entry.amount;
                accountCounts[account]++;
            });
            
            if (Object.keys(accountBalances).length === 0) {
                return '<div style="margin-bottom: 30px;"><h3>Account Balance Report</h3><p style="color: #666;">No transactions yet.</p></div>';
            }
            
            let html = '<div style="margin-bottom: 30px;"><h3 style="color: #0056b3;">Account Balance Report</h3>';
            html += '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #0056b3; color: white;"><th style="padding: 10px; text-align: left;">Account</th><th style="padding: 10px; text-align: center;">Transactions</th><th style="padding: 10px; text-align: right;">Balance</th></tr></thead><tbody>';
            
            Object.entries(accountBalances).sort((a, b) => b[1] - a[1]).forEach(([account, balance]) => {
                const count = accountCounts[account];
                const balanceColor = balance >= 0 ? '#28a745' : '#dc3545';
                html += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">${escapeHtml(account)}</td>
                        <td style="padding: 10px; text-align: center;">${count}</td>
                        <td style="padding: 10px; text-align: right; color: ${balanceColor}; font-weight: bold;">£${balance.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            
            return html;
        }

        // Show/hide allowance input fields based on selection
        document.getElementById('personalSavingsAllowance').addEventListener('change', function() {
            const savingsDiv = document.getElementById('savingsIncomeDiv');
            savingsDiv.style.display = this.value === 'yes' ? 'block' : 'none';
        });

        document.getElementById('dividendAllowance').addEventListener('change', function() {
            const dividendDiv = document.getElementById('dividendIncomeDiv');
            dividendDiv.style.display = this.value === 'yes' ? 'block' : 'none';
        });

        // Initialize displays
        populateAccountDropdowns();
        setDefaultDates();
        updateDisplays();
    </script>
</body>
                        </html>
