<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Month-End Close Automation - Front-End Prototype</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .card h3 {
            color: #667eea;
            margin: 20px 0 10px 0;
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 150px;
            font-family: monospace;
        }
        
        .form-group input[type="number"] {
            max-width: 300px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: scale(1.02);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .results h4 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #666;
            font-weight: 500;
        }
        
        .metric-value {
            color: #333;
            font-weight: 600;
        }
        
        .metric-value.positive {
            color: #28a745;
        }
        
        .metric-value.negative {
            color: #dc3545;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card h3 {
            color: white;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
        }
        
        .help-text {
            color: #666;
            font-size: 14px;
            font-style: italic;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Month-End Close Automation System</h1>
            <p>Standalone front-end prototype for account reconciliation, accrual postings, and financial statement generation</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">üìä Overview</button>
            <button class="tab" onclick="switchTab('reconciliation')">üîç Reconciliation</button>
            <button class="tab" onclick="switchTab('accruals')">üìù Accruals</button>
            <button class="tab" onclick="switchTab('statements')">üí∞ Financial Statements</button>
        </div>
        
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="card">
                <h2>Welcome to the Month-End Close System</h2>
                <div class="alert alert-info">
                    <strong>‚ÑπÔ∏è About this prototype:</strong> This is a browser-based implementation of the Python month-end close process. 
                    All calculations run in your browser using JavaScript. No data is sent to any server.
                </div>
                
                <h3>Features</h3>
                <ul style="margin-left: 20px; color: #666; line-height: 1.8;">
                    <li><strong>Account Reconciliation:</strong> Match GL transactions with bank statements</li>
                    <li><strong>Accrual Postings:</strong> Calculate interest, depreciation, and expense accruals</li>
                    <li><strong>Financial Statements:</strong> Generate P&L, Balance Sheet, and Cash Flow statements</li>
                </ul>
                
                <h3>How to Use</h3>
                <ol style="margin-left: 20px; color: #666; line-height: 1.8; margin-bottom: 20px;">
                    <li>Navigate to each tab to access different features</li>
                    <li>Enter your transaction data in CSV format</li>
                    <li>Click "Process" to run calculations</li>
                    <li>Review results and export if needed</li>
                </ol>
                
                <div class="grid">
                    <div class="stat-card">
                        <h3>Account Reconciliation</h3>
                        <div class="value" id="recon-count">0</div>
                        <div class="label">Transactions Processed</div>
                    </div>
                    <div class="stat-card">
                        <h3>Accrual Postings</h3>
                        <div class="value" id="accrual-count">0</div>
                        <div class="label">Journal Entries Created</div>
                    </div>
                    <div class="stat-card">
                        <h3>Financial Statements</h3>
                        <div class="value" id="statement-count">0</div>
                        <div class="label">Statements Generated</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Reconciliation Tab -->
        <div id="reconciliation" class="tab-content">
            <div class="card">
                <h2>üîç Account Reconciliation</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Match general ledger transactions with bank statements to identify discrepancies.
                </p>
                
                <div class="form-group">
                    <label for="gl-data">General Ledger Transactions (CSV)</label>
                    <textarea id="gl-data" placeholder="date,reference,description,amount
2026-01-01,INV001,Client Payment,1500.00
2026-01-02,INV002,Office Supplies,-250.00"></textarea>
                    <div class="help-text">Format: date, reference, description, amount</div>
                </div>
                
                <div class="form-group">
                    <label for="bank-data">Bank Statement Transactions (CSV)</label>
                    <textarea id="bank-data" placeholder="date,reference,description,amount
2026-01-01,INV001,Payment Received,1500.00
2026-01-02,SUP001,Office Supplies,-250.00"></textarea>
                    <div class="help-text">Format: date, reference, description, amount</div>
                </div>
                
                <button class="btn btn-primary" onclick="performReconciliation()">üîç Perform Reconciliation</button>
                <button class="btn btn-danger" onclick="clearReconciliation()">Clear</button>
                
                <div id="recon-results"></div>
            </div>
        </div>
        
        <!-- Accruals Tab -->
        <div id="accruals" class="tab-content">
            <div class="card">
                <h2>üìù Accrual Postings</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Calculate interest, depreciation, and periodic expense accruals.
                </p>
                
                <div class="form-group">
                    <label for="accrual-type">Accrual Type</label>
                    <select id="accrual-type" onchange="updateAccrualForm()">
                        <option value="interest">Interest Accrual</option>
                        <option value="depreciation">Depreciation</option>
                        <option value="expense">Periodic Expense</option>
                    </select>
                </div>
                
                <div id="accrual-form">
                    <!-- Dynamic form content -->
                </div>
                
                <button class="btn btn-primary" onclick="calculateAccrual()">üìä Calculate Accrual</button>
                <button class="btn btn-success" onclick="generateJournalEntry()">üìÑ Generate Journal Entry</button>
                <button class="btn btn-danger" onclick="clearAccruals()">Clear</button>
                
                <div id="accrual-results"></div>
            </div>
        </div>
        
        <!-- Financial Statements Tab -->
        <div id="statements" class="tab-content">
            <div class="card">
                <h2>üí∞ Financial Statements</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Generate Profit & Loss, Balance Sheet, and Cash Flow statements from transaction data.
                </p>
                
                <div class="form-group">
                    <label for="transaction-data">Transaction Data (CSV)</label>
                    <textarea id="transaction-data" placeholder="date,account,account_type,description,debit,credit
2026-01-01,4000,Revenue,Sales Revenue,0,5000
2026-01-01,1000,Asset,Cash,5000,0
2026-01-02,6000,Expense,Rent,1000,0
2026-01-02,1000,Asset,Cash,0,1000"></textarea>
                    <div class="help-text">
                        Format: date, account, account_type, description, debit, credit<br>
                        Account types: Asset, Liability, Equity, Revenue, COGS, Expense
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="statement-type">Statement Type</label>
                    <select id="statement-type">
                        <option value="all">All Statements</option>
                        <option value="pl">Profit & Loss Only</option>
                        <option value="bs">Balance Sheet Only</option>
                        <option value="cf">Cash Flow Only</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" onclick="generateStatements()">üìà Generate Statements</button>
                <button class="btn btn-danger" onclick="clearStatements()">Clear</button>
                
                <div id="statement-results"></div>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================================================
        // GLOBAL STATE
        // ============================================================================
        
        let reconciliationResults = null;
        let currentAccrual = null;
        let journalEntries = [];
        let statementResults = null;
        
        // ============================================================================
        // TAB SWITCHING
        // ============================================================================
        
        function switchTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }
        
        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            
            return data;
        }
        
        function formatCurrency(amount) {
            return '¬£' + parseFloat(amount).toLocaleString('en-GB', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        function safeFloat(value) {
            const num = parseFloat(value);
            return isNaN(num) ? 0 : num;
        }
        
        // ============================================================================
        // ACCOUNT RECONCILIATION
        // ============================================================================
        
        function performReconciliation() {
            const glText = document.getElementById('gl-data').value;
            const bankText = document.getElementById('bank-data').value;
            
            if (!glText || !bankText) {
                alert('Please enter both GL and Bank transaction data');
                return;
            }
            
            const glTransactions = parseCSV(glText);
            const bankTransactions = parseCSV(bankText);
            
            const matched = [];
            const unmatchedGL = [];
            const unmatchedBank = [];
            const discrepancies = [];
            
            const remainingBank = [...bankTransactions];
            
            // Try to match GL transactions with bank transactions
            glTransactions.forEach(gl => {
                let matchFound = false;
                const glAmount = safeFloat(gl.amount);
                
                for (let i = 0; i < remainingBank.length; i++) {
                    const bank = remainingBank[i];
                    const bankAmount = safeFloat(bank.amount);
                    
                    // Matching criteria
                    const amountMatch = Math.abs(glAmount - bankAmount) < 0.01;
                    const dateMatch = gl.date === bank.date;
                    const refMatch = gl.reference === bank.reference;
                    const descMatch = gl.description && bank.description && 
                                    (gl.description.toLowerCase().includes(bank.description.toLowerCase()) ||
                                     bank.description.toLowerCase().includes(gl.description.toLowerCase()));
                    
                    if (amountMatch && (dateMatch || refMatch || descMatch)) {
                        matched.push({
                            gl: gl,
                            bank: bank,
                            confidence: (dateMatch && refMatch) ? 'High' : 'Medium'
                        });
                        remainingBank.splice(i, 1);
                        matchFound = true;
                        break;
                    }
                }
                
                if (!matchFound && glAmount !== 0) {
                    unmatchedGL.push(gl);
                }
            });
            
            unmatchedBank.push(...remainingBank);
            
            reconciliationResults = {
                matched,
                unmatchedGL,
                unmatchedBank,
                discrepancies
            };
            
            displayReconciliationResults();
            updateOverviewStats();
        }
        
        function displayReconciliationResults() {
            const resultsDiv = document.getElementById('recon-results');
            const r = reconciliationResults;
            
            const totalGL = safeFloat(r.matched.reduce((sum, m) => sum + safeFloat(m.gl.amount), 0));
            const matchedAmount = totalGL;
            
            let html = '<div class="results">';
            html += '<h4>Reconciliation Summary</h4>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Matched Transactions</span>';
            html += `<span class="metric-value positive">${r.matched.length}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Unmatched GL Transactions</span>';
            html += `<span class="metric-value ${r.unmatchedGL.length > 0 ? 'negative' : ''}">${r.unmatchedGL.length}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Unmatched Bank Transactions</span>';
            html += `<span class="metric-value ${r.unmatchedBank.length > 0 ? 'negative' : ''}">${r.unmatchedBank.length}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Matched Amount</span>';
            html += `<span class="metric-value">${formatCurrency(matchedAmount)}</span>`;
            html += '</div>';
            
            html += '</div>';
            
            // Matched transactions table
            if (r.matched.length > 0) {
                html += '<div class="table-container">';
                html += '<h4 style="margin-top: 20px; margin-bottom: 10px;">Matched Transactions</h4>';
                html += '<table>';
                html += '<thead><tr><th>Date</th><th>Reference</th><th>Description</th><th>Amount</th><th>Confidence</th></tr></thead>';
                html += '<tbody>';
                r.matched.forEach(m => {
                    html += `<tr>
                        <td>${m.gl.date}</td>
                        <td>${m.gl.reference}</td>
                        <td>${m.gl.description}</td>
                        <td>${formatCurrency(m.gl.amount)}</td>
                        <td>${m.confidence}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            }
            
            // Unmatched GL transactions
            if (r.unmatchedGL.length > 0) {
                html += '<div class="table-container">';
                html += '<h4 style="margin-top: 20px; margin-bottom: 10px;">Unmatched GL Transactions</h4>';
                html += '<table>';
                html += '<thead><tr><th>Date</th><th>Reference</th><th>Description</th><th>Amount</th></tr></thead>';
                html += '<tbody>';
                r.unmatchedGL.forEach(tx => {
                    html += `<tr>
                        <td>${tx.date}</td>
                        <td>${tx.reference}</td>
                        <td>${tx.description}</td>
                        <td>${formatCurrency(tx.amount)}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            }
            
            // Unmatched bank transactions
            if (r.unmatchedBank.length > 0) {
                html += '<div class="table-container">';
                html += '<h4 style="margin-top: 20px; margin-bottom: 10px;">Unmatched Bank Transactions</h4>';
                html += '<table>';
                html += '<thead><tr><th>Date</th><th>Reference</th><th>Description</th><th>Amount</th></tr></thead>';
                html += '<tbody>';
                r.unmatchedBank.forEach(tx => {
                    html += `<tr>
                        <td>${tx.date}</td>
                        <td>${tx.reference}</td>
                        <td>${tx.description}</td>
                        <td>${formatCurrency(tx.amount)}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function clearReconciliation() {
            document.getElementById('gl-data').value = '';
            document.getElementById('bank-data').value = '';
            document.getElementById('recon-results').innerHTML = '';
            reconciliationResults = null;
            updateOverviewStats();
        }
        
        // ============================================================================
        // ACCRUAL POSTINGS
        // ============================================================================
        
        function updateAccrualForm() {
            const type = document.getElementById('accrual-type').value;
            const formDiv = document.getElementById('accrual-form');
            
            let html = '';
            
            if (type === 'interest') {
                html = `
                    <div class="form-group">
                        <label for="principal">Principal Amount (¬£)</label>
                        <input type="number" id="principal" step="0.01" value="10000">
                    </div>
                    <div class="form-group">
                        <label for="interest-rate">Annual Interest Rate (%)</label>
                        <input type="number" id="interest-rate" step="0.01" value="5.0">
                    </div>
                    <div class="form-group">
                        <label for="months">Number of Months</label>
                        <input type="number" id="months" min="1" value="1">
                    </div>
                `;
            } else if (type === 'depreciation') {
                html = `
                    <div class="form-group">
                        <label for="asset-cost">Asset Cost (¬£)</label>
                        <input type="number" id="asset-cost" step="0.01" value="50000">
                    </div>
                    <div class="form-group">
                        <label for="salvage-value">Salvage Value (¬£)</label>
                        <input type="number" id="salvage-value" step="0.01" value="5000">
                    </div>
                    <div class="form-group">
                        <label for="useful-life">Useful Life (years)</label>
                        <input type="number" id="useful-life" min="1" value="5">
                    </div>
                `;
            } else if (type === 'expense') {
                html = `
                    <div class="form-group">
                        <label for="expense-name">Expense Name</label>
                        <input type="text" id="expense-name" value="Rent">
                    </div>
                    <div class="form-group">
                        <label for="annual-amount">Annual Amount (¬£)</label>
                        <input type="number" id="annual-amount" step="0.01" value="12000">
                    </div>
                    <div class="form-group">
                        <label for="expense-months">Number of Months</label>
                        <input type="number" id="expense-months" min="1" value="1">
                    </div>
                `;
            }
            
            formDiv.innerHTML = html;
        }
        
        function calculateAccrual() {
            const type = document.getElementById('accrual-type').value;
            let accrual = { type: type, date: new Date().toISOString().split('T')[0] };
            
            if (type === 'interest') {
                const principal = safeFloat(document.getElementById('principal').value);
                const rate = safeFloat(document.getElementById('interest-rate').value) / 100;
                const months = parseInt(document.getElementById('months').value) || 1;
                
                const monthlyRate = rate / 12;
                const accrualAmount = principal * monthlyRate * months;
                
                accrual.principal = principal;
                accrual.rate = rate * 100;
                accrual.months = months;
                accrual.amount = accrualAmount;
                accrual.description = `Interest Accrual: ${rate * 100}% on ¬£${principal.toLocaleString()} for ${months} month(s)`;
                
            } else if (type === 'depreciation') {
                const assetCost = safeFloat(document.getElementById('asset-cost').value);
                const salvageValue = safeFloat(document.getElementById('salvage-value').value);
                const usefulLife = parseInt(document.getElementById('useful-life').value) || 5;
                
                const depreciableAmount = assetCost - salvageValue;
                const annualDepreciation = depreciableAmount / usefulLife;
                const monthlyDepreciation = annualDepreciation / 12;
                
                accrual.assetCost = assetCost;
                accrual.salvageValue = salvageValue;
                accrual.usefulLife = usefulLife;
                accrual.annualDepreciation = annualDepreciation;
                accrual.amount = monthlyDepreciation;
                accrual.description = `Depreciation: ¬£${assetCost.toLocaleString()} asset over ${usefulLife} years`;
                
            } else if (type === 'expense') {
                const name = document.getElementById('expense-name').value;
                const annualAmount = safeFloat(document.getElementById('annual-amount').value);
                const months = parseInt(document.getElementById('expense-months').value) || 1;
                
                const monthlyAmount = annualAmount / 12;
                const accrualAmount = monthlyAmount * months;
                
                accrual.name = name;
                accrual.annualAmount = annualAmount;
                accrual.months = months;
                accrual.amount = accrualAmount;
                accrual.description = `${name} Accrual: ¬£${annualAmount.toLocaleString()}/year for ${months} month(s)`;
            }
            
            currentAccrual = accrual;
            displayAccrualResults(accrual);
        }
        
        function displayAccrualResults(accrual) {
            const resultsDiv = document.getElementById('accrual-results');
            
            let html = '<div class="results">';
            html += '<h4>Accrual Calculation Results</h4>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Type</span>';
            html += `<span class="metric-value">${accrual.type.charAt(0).toUpperCase() + accrual.type.slice(1)}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Description</span>';
            html += `<span class="metric-value">${accrual.description}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Accrual Amount</span>';
            html += `<span class="metric-value positive">${formatCurrency(accrual.amount)}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Date</span>';
            html += `<span class="metric-value">${accrual.date}</span>`;
            html += '</div>';
            
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }
        
        function generateJournalEntry() {
            if (!currentAccrual) {
                alert('Please calculate an accrual first');
                return;
            }
            
            const accrual = currentAccrual;
            const entry = {
                date: accrual.date,
                description: accrual.description,
                amount: accrual.amount,
                lines: []
            };
            
            if (accrual.type === 'interest') {
                entry.lines = [
                    { account: '7200', accountName: 'Interest Expense', debit: accrual.amount, credit: 0 },
                    { account: '2300', accountName: 'Interest Payable', debit: 0, credit: accrual.amount }
                ];
            } else if (accrual.type === 'depreciation') {
                entry.lines = [
                    { account: '7100', accountName: 'Depreciation Expense', debit: accrual.amount, credit: 0 },
                    { account: '1500', accountName: 'Accumulated Depreciation', debit: 0, credit: accrual.amount }
                ];
            } else if (accrual.type === 'expense') {
                entry.lines = [
                    { account: '6000', accountName: `${accrual.name} Expense`, debit: accrual.amount, credit: 0 },
                    { account: '2000', accountName: 'Accrued Expenses', debit: 0, credit: accrual.amount }
                ];
            }
            
            journalEntries.push(entry);
            displayJournalEntry(entry);
            updateOverviewStats();
        }
        
        function displayJournalEntry(entry) {
            const resultsDiv = document.getElementById('accrual-results');
            
            let html = resultsDiv.innerHTML;
            html += '<div class="table-container" style="margin-top: 20px;">';
            html += '<h4>Journal Entry</h4>';
            html += `<p><strong>Date:</strong> ${entry.date} | <strong>Description:</strong> ${entry.description}</p>`;
            html += '<table>';
            html += '<thead><tr><th>Account</th><th>Account Name</th><th>Debit</th><th>Credit</th></tr></thead>';
            html += '<tbody>';
            
            entry.lines.forEach(line => {
                html += `<tr>
                    <td>${line.account}</td>
                    <td>${line.accountName}</td>
                    <td>${line.debit > 0 ? formatCurrency(line.debit) : '-'}</td>
                    <td>${line.credit > 0 ? formatCurrency(line.credit) : '-'}</td>
                </tr>`;
            });
            
            const totalDebit = entry.lines.reduce((sum, l) => sum + l.debit, 0);
            const totalCredit = entry.lines.reduce((sum, l) => sum + l.credit, 0);
            
            html += `<tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="2">Total</td>
                <td>${formatCurrency(totalDebit)}</td>
                <td>${formatCurrency(totalCredit)}</td>
            </tr>`;
            html += '</tbody></table>';
            html += `<p style="margin-top: 10px;"><strong>Balanced:</strong> ${totalDebit === totalCredit ? '‚úì Yes' : '‚úó No'}</p>`;
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }
        
        function clearAccruals() {
            document.getElementById('accrual-form').innerHTML = '';
            document.getElementById('accrual-results').innerHTML = '';
            currentAccrual = null;
            updateAccrualForm();
        }
        
        // ============================================================================
        // FINANCIAL STATEMENTS
        // ============================================================================
        
        function generateStatements() {
            const transactionText = document.getElementById('transaction-data').value;
            const statementType = document.getElementById('statement-type').value;
            
            if (!transactionText) {
                alert('Please enter transaction data');
                return;
            }
            
            const transactions = parseCSV(transactionText);
            const accounts = {};
            
            // Process transactions
            transactions.forEach(tx => {
                const account = tx.account;
                const accountType = tx.account_type;
                const debit = safeFloat(tx.debit);
                const credit = safeFloat(tx.credit);
                
                if (!accounts[account]) {
                    accounts[account] = {
                        type: accountType,
                        debits: 0,
                        credits: 0,
                        balance: 0
                    };
                }
                
                accounts[account].debits += debit;
                accounts[account].credits += credit;
                
                // Calculate balance based on account type
                if (['Asset', 'Expense', 'COGS'].includes(accountType)) {
                    accounts[account].balance += debit - credit;
                } else {
                    accounts[account].balance += credit - debit;
                }
            });
            
            statementResults = {
                accounts: accounts,
                profitLoss: generateProfitLoss(accounts),
                balanceSheet: generateBalanceSheet(accounts),
                cashFlow: generateCashFlow(accounts)
            };
            
            displayStatements(statementType);
            updateOverviewStats();
        }
        
        function generateProfitLoss(accounts) {
            let revenue = 0;
            let cogs = 0;
            let expenses = 0;
            
            const revenueAccounts = [];
            const cogsAccounts = [];
            const expenseAccounts = [];
            
            Object.keys(accounts).forEach(account => {
                const data = accounts[account];
                if (data.type === 'Revenue') {
                    revenue += data.balance;
                    revenueAccounts.push({ account, balance: data.balance });
                } else if (data.type === 'COGS') {
                    cogs += data.balance;
                    cogsAccounts.push({ account, balance: data.balance });
                } else if (data.type === 'Expense') {
                    expenses += data.balance;
                    expenseAccounts.push({ account, balance: data.balance });
                }
            });
            
            const grossProfit = revenue - cogs;
            const netIncome = grossProfit - expenses;
            
            return {
                revenue,
                cogs,
                grossProfit,
                expenses,
                netIncome,
                revenueAccounts,
                cogsAccounts,
                expenseAccounts
            };
        }
        
        function generateBalanceSheet(accounts) {
            let assets = 0;
            let liabilities = 0;
            let equity = 0;
            
            const assetAccounts = [];
            const liabilityAccounts = [];
            const equityAccounts = [];
            
            Object.keys(accounts).forEach(account => {
                const data = accounts[account];
                if (data.type === 'Asset') {
                    assets += data.balance;
                    assetAccounts.push({ account, balance: data.balance });
                } else if (data.type === 'Liability') {
                    liabilities += data.balance;
                    liabilityAccounts.push({ account, balance: data.balance });
                } else if (data.type === 'Equity') {
                    equity += data.balance;
                    equityAccounts.push({ account, balance: data.balance });
                }
            });
            
            // Add net income to equity
            const pl = generateProfitLoss(accounts);
            equity += pl.netIncome;
            
            const totalLiabilitiesEquity = liabilities + equity;
            const balanced = Math.abs(assets - totalLiabilitiesEquity) < 0.01;
            
            return {
                assets,
                liabilities,
                equity,
                totalLiabilitiesEquity,
                balanced,
                assetAccounts,
                liabilityAccounts,
                equityAccounts
            };
        }
        
        function generateCashFlow(accounts) {
            const pl = generateProfitLoss(accounts);
            
            return {
                operatingCash: pl.netIncome,
                investingCash: 0,
                financingCash: 0,
                netCashChange: pl.netIncome
            };
        }
        
        function displayStatements(type) {
            const resultsDiv = document.getElementById('statement-results');
            let html = '';
            
            if (type === 'all' || type === 'pl') {
                html += displayProfitLoss();
            }
            
            if (type === 'all' || type === 'bs') {
                html += displayBalanceSheet();
            }
            
            if (type === 'all' || type === 'cf') {
                html += displayCashFlow();
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function displayProfitLoss() {
            const pl = statementResults.profitLoss;
            
            let html = '<div class="results">';
            html += '<h4>üìä Profit & Loss Statement</h4>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Revenue</span>';
            html += `<span class="metric-value positive">${formatCurrency(pl.revenue)}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Cost of Goods Sold</span>';
            html += `<span class="metric-value">${formatCurrency(pl.cogs)}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Gross Profit</span>';
            html += `<span class="metric-value ${pl.grossProfit >= 0 ? 'positive' : 'negative'}">${formatCurrency(pl.grossProfit)}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Operating Expenses</span>';
            html += `<span class="metric-value">${formatCurrency(pl.expenses)}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label"><strong>Net Income</strong></span>';
            html += `<span class="metric-value ${pl.netIncome >= 0 ? 'positive' : 'negative'}"><strong>${formatCurrency(pl.netIncome)}</strong></span>`;
            html += '</div>';
            
            html += '</div>';
            
            return html;
        }
        
        function displayBalanceSheet() {
            const bs = statementResults.balanceSheet;
            
            let html = '<div class="results" style="margin-top: 20px;">';
            html += '<h4>üíº Balance Sheet</h4>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Total Assets</span>';
            html += `<span class="metric-value">${formatCurrency(bs.assets)}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Total Liabilities</span>';
            html += `<span class="metric-value">${formatCurrency(bs.liabilities)}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Total Equity</span>';
            html += `<span class="metric-value">${formatCurrency(bs.equity)}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Total Liabilities & Equity</span>';
            html += `<span class="metric-value">${formatCurrency(bs.totalLiabilitiesEquity)}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label"><strong>Balanced</strong></span>';
            html += `<span class="metric-value ${bs.balanced ? 'positive' : 'negative'}"><strong>${bs.balanced ? '‚úì Yes' : '‚úó No'}</strong></span>`;
            html += '</div>';
            
            html += '</div>';
            
            return html;
        }
        
        function displayCashFlow() {
            const cf = statementResults.cashFlow;
            
            let html = '<div class="results" style="margin-top: 20px;">';
            html += '<h4>ÔøΩÔøΩ Cash Flow Statement (Simplified)</h4>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Operating Activities</span>';
            html += `<span class="metric-value ${cf.operatingCash >= 0 ? 'positive' : 'negative'}">${formatCurrency(cf.operatingCash)}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Investing Activities</span>';
            html += `<span class="metric-value">${formatCurrency(cf.investingCash)}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label">Financing Activities</span>';
            html += `<span class="metric-value">${formatCurrency(cf.financingCash)}</span>`;
            html += '</div>';
            
            html += '<div class="metric">';
            html += '<span class="metric-label"><strong>Net Cash Change</strong></span>';
            html += `<span class="metric-value ${cf.netCashChange >= 0 ? 'positive' : 'negative'}"><strong>${formatCurrency(cf.netCashChange)}</strong></span>`;
            html += '</div>';
            
            html += '</div>';
            
            return html;
        }
        
        function clearStatements() {
            document.getElementById('transaction-data').value = '';
            document.getElementById('statement-results').innerHTML = '';
            statementResults = null;
            updateOverviewStats();
        }
        
        // ============================================================================
        // OVERVIEW STATISTICS
        // ============================================================================
        
        function updateOverviewStats() {
            const reconCount = reconciliationResults ? 
                (reconciliationResults.matched.length + reconciliationResults.unmatchedGL.length) : 0;
            document.getElementById('recon-count').textContent = reconCount;
            
            document.getElementById('accrual-count').textContent = journalEntries.length;
            
            const statementCount = statementResults ? 3 : 0;
            document.getElementById('statement-count').textContent = statementCount;
        }
        
        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        window.addEventListener('DOMContentLoaded', () => {
            updateAccrualForm();
            updateOverviewStats();
        });
    </script>
</body>
    </html>
