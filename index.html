<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xero Accounting Integration & Tax Optimization</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    /* Navigation Header */
    .nav-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .nav-brand {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }

    .nav-menu {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .nav-link {
      color: #333;
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 5px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .nav-link:hover {
      background: #667eea;
      color: white;
    }

    .auth-buttons {
      display: flex;
      gap: 10px;
    }

    .btn-login, .btn-logout {
      padding: 8px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-login {
      background: #667eea;
      color: white;
    }

    .btn-login:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .btn-logout {
      background: #dc3545;
      color: white;
      display: none;
    }

    .btn-logout:hover {
      background: #c82333;
      transform: translateY(-2px);
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
    }

    /* Dashboard Overview */
    .dashboard-section {
      background: white;
      border-radius: 10px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 28px;
      color: #333;
      margin-bottom: 20px;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
    }

    /* Xero Connection */
    .xero-connection {
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .xero-btn {
      background: #13B5EA;
      color: white;
      padding: 15px 40px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .xero-btn:hover {
      background: #0E9FCE;
      transform: scale(1.05);
    }

    .connection-status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      font-weight: 600;
    }

    .status-connected {
      background: #d4edda;
      color: #155724;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
    }

    /* Content Grid */
    .content-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 30px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card-title {
      font-size: 22px;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 5px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    button {
      background: #667eea;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-success {
      background: #28a745;
    }

    .btn-success:hover {
      background: #218838;
    }

    /* Invoice List */
    .invoice-list, .expense-list {
      margin-top: 20px;
    }

    .item-row {
      background: #f8f9fa;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .item-info {
      flex: 1;
    }

    .item-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .item-details {
      font-size: 14px;
      color: #666;
    }

    .item-actions {
      display: flex;
      gap: 10px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-pending {
      background: #fff3cd;
      color: #856404;
    }

    .badge-paid {
      background: #d4edda;
      color: #155724;
    }

    .badge-overdue {
      background: #f8d7da;
      color: #721c24;
    }

    /* Tax Optimization */
    .tax-result {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 5px;
      margin-top: 20px;
    }

    .tax-metric {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .tax-metric:last-child {
      border-bottom: none;
    }

    .metric-label {
      color: #666;
      font-weight: 500;
    }

    .metric-value {
      color: #333;
      font-weight: 600;
    }

    .metric-value.positive {
      color: #28a745;
    }

    .result, .error {
      margin-top: 20px;
      padding: 15px;
      border-radius: 5px;
    }

    .result {
      background: #d4edda;
      color: #155724;
      border-left: 5px solid #28a745;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border-left: 5px solid #dc3545;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #666;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .nav-container {
        flex-direction: column;
        gap: 15px;
      }

      .nav-menu {
        width: 100%;
        justify-content: center;
      }

      .content-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .item-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .item-actions {
        width: 100%;
        justify-content: flex-end;
      }
    }

    /* Hidden by default */
    .hidden {
      display: none;
    }

    /* Tax Rules Section Additional Styles */
    .tax-rules-section {
      margin-top: 30px;
    }

    .tax-rules-category {
      margin-bottom: 25px;
    }

    .tax-rules-category h4 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .info-box {
      padding: 15px;
      background: #e7f3ff;
      border-radius: 5px;
      border-left: 4px solid #667eea;
    }

    .info-box strong {
      color: #333;
    }

    .info-box ul {
      margin-top: 10px;
      padding-left: 20px;
      color: #333;
    }

    /* Enhanced form styling */
    #dynamicTaxFields {
      max-width: 100%;
    }

    #entityDescription {
      border-left: 4px solid #667eea;
    }

    /* Smooth scroll behavior */
    html {
      scroll-behavior: smooth;
    }
  </style>
</head>
<body>
  <!-- Navigation Header -->
  <nav class="nav-header">
    <div class="nav-container">
      <div class="nav-brand">üßæ Xero Tax Optimizer</div>
      <div class="nav-menu">
        <a class="nav-link" onclick="showSection('dashboard')">Dashboard</a>
        <a class="nav-link" onclick="showSection('invoices')">Invoices</a>
        <a class="nav-link" onclick="showSection('expenses')">Expenses</a>
        <a class="nav-link" onclick="showSection('tax')">Tax Optimization</a>
        <a class="nav-link" onclick="scrollToTaxRules()">Tax Rules</a>
      </div>
      <div class="auth-buttons">
        <button class="btn-login" id="loginBtn" onclick="login()">Login</button>
        <button class="btn-logout" id="logoutBtn" onclick="logout()">Logout</button>
        <span id="userDisplay" style="display: none; color: #333; font-weight: 600; padding: 8px;"></span>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- Xero Connection Section -->
    <div class="xero-connection">
      <h2 style="margin-bottom: 15px;">Connect to Xero</h2>
      <p style="color: #666; margin-bottom: 20px;">Seamlessly integrate your Xero account for real-time data synchronization</p>
      <button class="xero-btn" onclick="connectToXero()">
        <span>üîó</span> Connect to Xero
      </button>
      <div id="connectedStatus"></div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="dashboard-section">
      <h2 class="section-title">üìä Dashboard Overview</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Income</div>
          <div class="stat-value" id="totalIncome">¬£45,320</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Expenses</div>
          <div class="stat-value" id="totalExpenses">¬£12,450</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Net Profit</div>
          <div class="stat-value" id="netProfit">¬£32,870</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Estimated Tax</div>
          <div class="stat-value" id="estimatedTax">¬£6,574</div>
        </div>
      </div>
    </div>

    <!-- Invoices Section -->
    <div id="invoicesSection" class="content-grid hidden">
      <div class="card">
        <h3 class="card-title">üìÑ Create Invoice</h3>
        <form id="invoiceForm">
          <div class="form-group">
            <label>Client Name</label>
            <input type="text" id="clientName" placeholder="Enter client name" required>
          </div>
          <div class="form-group">
            <label>Invoice Amount (¬£)</label>
            <input type="number" id="invoiceAmount" placeholder="0.00" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Due Date</label>
            <input type="date" id="dueDate" required>
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="invoiceDescription" placeholder="Invoice description"></textarea>
          </div>
          <button type="submit" class="btn-success">Create Invoice</button>
        </form>
      </div>

      <div class="card">
        <h3 class="card-title">üìã Invoice List</h3>
        <div class="invoice-list" id="invoiceList">
          <!-- Sample invoices will be added here -->
        </div>
      </div>
    </div>

    <!-- Expenses Section -->
    <div id="expensesSection" class="content-grid hidden">
      <div class="card">
        <h3 class="card-title">üí∞ Track Expense</h3>
        <form id="expenseForm">
          <div class="form-group">
            <label>Expense Description</label>
            <input type="text" id="expenseDescription" placeholder="Enter expense description" required>
          </div>
          <div class="form-group">
            <label>Amount (¬£)</label>
            <input type="number" id="expenseAmount" placeholder="0.00" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Category</label>
            <select id="expenseCategory" required>
              <option value="">Select category</option>
              <option value="Office Supplies">Office Supplies</option>
              <option value="Travel">Travel</option>
              <option value="Marketing">Marketing</option>
              <option value="Utilities">Utilities</option>
              <option value="Software">Software</option>
              <option value="Equipment">Equipment</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="expenseDate" required>
          </div>
          <button type="submit" class="btn-success">Add Expense</button>
        </form>
      </div>

      <div class="card">
        <h3 class="card-title">üìä Expense List</h3>
        <div class="expense-list" id="expenseList">
          <!-- Sample expenses will be added here -->
        </div>
      </div>
    </div>

    <!-- Tax Optimization Section -->
    <div id="taxSection" class="dashboard-section hidden">
      <h2 class="section-title">üíº Advanced Tax Optimization</h2>
      <p style="color: #666; margin-bottom: 20px;">Optimize your tax strategy based on UK HMRC rules, reliefs, and allowances</p>
      
      <!-- Entity Selection -->
      <div class="card" style="margin-bottom: 20px;">
        <h3 class="card-title">üìã Entity Type Selection</h3>
        <div class="form-group">
          <label>Select Your Entity Type</label>
          <select id="entityType" onchange="updateTaxCalculator()">
            <option value="">-- Select Entity Type --</option>
            <option value="sole_trader">Sole Trader / Self-Employed</option>
            <option value="company">Limited Company</option>
            <option value="landlord">Landlord / Property Owner</option>
            <option value="employee">Employee (PAYE)</option>
          </select>
        </div>
        <div id="entityDescription" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; display: none;">
          <strong id="entityDescTitle"></strong>
          <p id="entityDescText" style="margin-top: 10px; color: #666;"></p>
        </div>
      </div>

      <!-- Tax Calculator Form -->
      <div class="card" style="margin-bottom: 20px; display: none;" id="taxCalculatorForm">
        <h3 class="card-title">üßÆ Tax Calculator</h3>
        <form id="advancedTaxForm">
          <div id="dynamicTaxFields"></div>
          <button type="submit" class="btn-success" style="margin-top: 15px;">Calculate Comprehensive Tax</button>
        </form>
      </div>

      <div id="resultContainer"></div>

      <!-- Tax Results -->
      <div id="taxResults" class="tax-result" style="display: none;">
        <h3 style="margin-bottom: 15px;">Comprehensive Tax Analysis</h3>
        <div id="taxBreakdown"></div>
        <div id="optimizationTips" style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px;">
          <strong>üí° Optimization Tips:</strong>
          <ul id="tipsList" style="margin-top: 10px; padding-left: 20px;"></ul>
        </div>
      </div>

      <!-- Tax Rules & Information Section -->
      <div class="card" style="margin-top: 30px;">
        <h3 class="card-title">üìö UK HMRC Tax Rules & Information (2024/25)</h3>
        <div id="taxRulesContent">
          <div style="margin-bottom: 25px;">
            <h4 style="color: #667eea; margin-bottom: 10px;">Income Tax Allowances & Rates</h4>
            <div class="tax-metric">
              <span class="metric-label">Personal Allowance</span>
              <span class="metric-value">¬£12,570</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Basic Rate (20%)</span>
              <span class="metric-value">¬£12,571 - ¬£50,270</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Higher Rate (40%)</span>
              <span class="metric-value">¬£50,271 - ¬£125,140</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Additional Rate (45%)</span>
              <span class="metric-value">Over ¬£125,140</span>
            </div>
          </div>

          <div style="margin-bottom: 25px;">
            <h4 style="color: #667eea; margin-bottom: 10px;">National Insurance (NI) Contributions</h4>
            <div class="tax-metric">
              <span class="metric-label">Class 1 (Employees) - 12%</span>
              <span class="metric-value">¬£12,570 - ¬£50,270</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Class 1 (Employees) - 2%</span>
              <span class="metric-value">Over ¬£50,270</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Class 2 (Self-Employed)</span>
              <span class="metric-value">¬£3.45/week if profits over ¬£6,725</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Class 4 (Self-Employed) - 9%</span>
              <span class="metric-value">¬£12,570 - ¬£50,270</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Class 4 (Self-Employed) - 2%</span>
              <span class="metric-value">Over ¬£50,270</span>
            </div>
          </div>

          <div style="margin-bottom: 25px;">
            <h4 style="color: #667eea; margin-bottom: 10px;">Corporation Tax</h4>
            <div class="tax-metric">
              <span class="metric-label">Small Profits Rate (19%)</span>
              <span class="metric-value">Up to ¬£50,000</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Marginal Rate</span>
              <span class="metric-value">¬£50,001 - ¬£250,000</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Main Rate (25%)</span>
              <span class="metric-value">Over ¬£250,000</span>
            </div>
          </div>

          <div style="margin-bottom: 25px;">
            <h4 style="color: #667eea; margin-bottom: 10px;">Capital Gains Tax (CGT)</h4>
            <div class="tax-metric">
              <span class="metric-label">Annual Exemption</span>
              <span class="metric-value">¬£3,000 (2024/25)</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Basic Rate Taxpayer</span>
              <span class="metric-value">10% (18% property)</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Higher/Additional Rate</span>
              <span class="metric-value">20% (24% property)</span>
            </div>
          </div>

          <div style="margin-bottom: 25px;">
            <h4 style="color: #667eea; margin-bottom: 10px;">VAT Rates</h4>
            <div class="tax-metric">
              <span class="metric-label">Standard Rate</span>
              <span class="metric-value">20%</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Reduced Rate</span>
              <span class="metric-value">5% (e.g., domestic fuel, children's car seats)</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Zero Rate</span>
              <span class="metric-value">0% (e.g., most food, books, children's clothes)</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">VAT Registration Threshold</span>
              <span class="metric-value">¬£90,000 annual turnover</span>
            </div>
          </div>

          <div style="margin-bottom: 25px;">
            <h4 style="color: #667eea; margin-bottom: 10px;">Withholding Tax (WHT)</h4>
            <div class="tax-metric">
              <span class="metric-label">Interest Payments</span>
              <span class="metric-value">20% (unless treaty relief applies)</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Royalty Payments</span>
              <span class="metric-value">20% (unless treaty relief applies)</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Dividend Payments</span>
              <span class="metric-value">Generally 0% (varies by treaty)</span>
            </div>
          </div>

          <div style="margin-bottom: 25px;">
            <h4 style="color: #667eea; margin-bottom: 10px;">Key Allowances & Reliefs</h4>
            <div class="tax-metric">
              <span class="metric-label">Trading Allowance</span>
              <span class="metric-value">¬£1,000 (self-employed/sole traders)</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Property Allowance</span>
              <span class="metric-value">¬£1,000 (landlords)</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Dividend Allowance</span>
              <span class="metric-value">¬£500 (2024/25)</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Personal Savings Allowance</span>
              <span class="metric-value">¬£1,000 (basic) / ¬£500 (higher) / ¬£0 (additional)</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Marriage Allowance</span>
              <span class="metric-value">¬£1,260 transferable</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Pension Tax Relief</span>
              <span class="metric-value">Up to ¬£60,000 annual allowance</span>
            </div>
          </div>

          <div style="padding: 15px; background: #e7f3ff; border-radius: 5px; border-left: 4px solid #667eea;">
            <strong>‚ÑπÔ∏è Important Notes:</strong>
            <ul style="margin-top: 10px; padding-left: 20px; color: #333;">
              <li>Tax rates and allowances are for the 2024/25 tax year</li>
              <li>Scottish Income Tax rates may differ</li>
              <li>Welsh Income Tax rates may have variations</li>
              <li>Always consult HMRC guidance or a tax professional for specific advice</li>
              <li>Deadline for Self Assessment: 31 January following the tax year</li>
              <li>Corporation Tax payment: 9 months and 1 day after accounting period end</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Invoice Modal -->
  <div id="editInvoiceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Invoice</h3>
        <button class="modal-close" onclick="closeModal('editInvoiceModal')">&times;</button>
      </div>
      <form id="editInvoiceForm">
        <input type="hidden" id="editInvoiceId">
        <div class="form-group">
          <label>Client Name</label>
          <input type="text" id="editClientName" required>
        </div>
        <div class="form-group">
          <label>Amount (¬£)</label>
          <input type="number" id="editInvoiceAmount" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="editInvoiceStatus" required>
            <option value="pending">Pending</option>
            <option value="paid">Paid</option>
            <option value="overdue">Overdue</option>
          </select>
        </div>
        <button type="submit" class="btn-success">Save Changes</button>
      </form>
    </div>
  </div>

  <script>
    // Global state
    let isLoggedIn = false;
    let invoices = [];
    let expenses = [];
    let invoiceIdCounter = 1;
    let expenseIdCounter = 1;

    // Initialize app
    function init() {
      loadSampleData();
      showSection('dashboard');
      updateFinancialStats();
    }

    // Load sample data
    function loadSampleData() {
      invoices = [
        { id: 1, clientName: 'ABC Ltd', amount: 5000, status: 'paid', dueDate: '2024-12-15', description: 'Web development services' },
        { id: 2, clientName: 'XYZ Corp', amount: 3500, status: 'pending', dueDate: '2024-12-25', description: 'Consulting services' },
        { id: 3, clientName: 'Tech Solutions', amount: 2800, status: 'overdue', dueDate: '2024-11-30', description: 'Software maintenance' }
      ];
      invoiceIdCounter = invoices.length + 1;

      expenses = [
        { id: 1, description: 'Office rent', amount: 1200, category: 'Utilities', date: '2024-12-01' },
        { id: 2, description: 'Marketing campaign', amount: 850, category: 'Marketing', date: '2024-12-05' },
        { id: 3, description: 'Software licenses', amount: 450, category: 'Software', date: '2024-12-10' }
      ];
      expenseIdCounter = expenses.length + 1;

      renderInvoices();
      renderExpenses();
    }

    // Authentication
    function login() {
      isLoggedIn = true;
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'inline-block';
      document.getElementById('userDisplay').style.display = 'inline-block';
      document.getElementById('userDisplay').textContent = 'üë§ John Doe';
      showNotification('Successfully logged in!', 'success');
    }

    function logout() {
      isLoggedIn = false;
      document.getElementById('loginBtn').style.display = 'inline-block';
      document.getElementById('logoutBtn').style.display = 'none';
      document.getElementById('userDisplay').style.display = 'none';
      showNotification('Successfully logged out!', 'success');
    }

    // Navigation
    function showSection(section) {
      document.getElementById('dashboardSection').classList.add('hidden');
      document.getElementById('invoicesSection').classList.add('hidden');
      document.getElementById('expensesSection').classList.add('hidden');
      document.getElementById('taxSection').classList.add('hidden');

      if (section === 'dashboard') {
        document.getElementById('dashboardSection').classList.remove('hidden');
      } else if (section === 'invoices') {
        document.getElementById('invoicesSection').classList.remove('hidden');
      } else if (section === 'expenses') {
        document.getElementById('expensesSection').classList.remove('hidden');
      } else if (section === 'tax') {
        document.getElementById('taxSection').classList.remove('hidden');
      }
    }

    // Xero Connection
    async function connectToXero() {
      const statusDiv = document.getElementById('connectedStatus');
      statusDiv.innerHTML = '<p style="color: #666;">Connecting to Xero...</p>';
      
      try {
        // Simulated API call
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Simulate success
        statusDiv.innerHTML = '<div class="connection-status status-connected">‚úì Successfully connected to Xero!</div>';
        showNotification('Connected to Xero successfully!', 'success');
      } catch (error) {
        statusDiv.innerHTML = '<div class="connection-status status-error">‚úó Failed to connect to Xero. Please try again.</div>';
        showNotification('Failed to connect to Xero', 'error');
      }
    }

    // Invoice Management
    document.getElementById('invoiceForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const newInvoice = {
        id: invoiceIdCounter++,
        clientName: document.getElementById('clientName').value,
        amount: parseFloat(document.getElementById('invoiceAmount').value),
        status: 'pending',
        dueDate: document.getElementById('dueDate').value,
        description: document.getElementById('invoiceDescription').value
      };

      invoices.push(newInvoice);
      renderInvoices();
      updateFinancialStats();
      this.reset();
      showNotification('Invoice created successfully!', 'success');
    });

    function renderInvoices() {
      const listDiv = document.getElementById('invoiceList');
      if (invoices.length === 0) {
        listDiv.innerHTML = '<p style="color: #666; text-align: center;">No invoices yet. Create your first invoice!</p>';
        return;
      }

      listDiv.innerHTML = invoices.map(invoice => `
        <div class="item-row">
          <div class="item-info">
            <div class="item-title">${invoice.clientName} - ¬£${invoice.amount.toFixed(2)}</div>
            <div class="item-details">
              Due: ${invoice.dueDate} | 
              <span class="status-badge badge-${invoice.status}">${invoice.status.toUpperCase()}</span>
            </div>
          </div>
          <div class="item-actions">
            <button class="btn-sm btn-secondary" onclick="editInvoice(${invoice.id})">Edit</button>
            <button class="btn-sm" style="background: #dc3545;" onclick="deleteInvoice(${invoice.id})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function editInvoice(id) {
      const invoice = invoices.find(inv => inv.id === id);
      if (invoice) {
        document.getElementById('editInvoiceId').value = invoice.id;
        document.getElementById('editClientName').value = invoice.clientName;
        document.getElementById('editInvoiceAmount').value = invoice.amount;
        document.getElementById('editInvoiceStatus').value = invoice.status;
        document.getElementById('editInvoiceModal').classList.add('active');
      }
    }

    document.getElementById('editInvoiceForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = parseInt(document.getElementById('editInvoiceId').value);
      const invoice = invoices.find(inv => inv.id === id);
      
      if (invoice) {
        invoice.clientName = document.getElementById('editClientName').value;
        invoice.amount = parseFloat(document.getElementById('editInvoiceAmount').value);
        invoice.status = document.getElementById('editInvoiceStatus').value;
        
        renderInvoices();
        updateFinancialStats();
        closeModal('editInvoiceModal');
        showNotification('Invoice updated successfully!', 'success');
      }
    });

    function deleteInvoice(id) {
      if (confirm('Are you sure you want to delete this invoice?')) {
        invoices = invoices.filter(inv => inv.id !== id);
        renderInvoices();
        updateFinancialStats();
        showNotification('Invoice deleted successfully!', 'success');
      }
    }

    // Expense Management
    document.getElementById('expenseForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const newExpense = {
        id: expenseIdCounter++,
        description: document.getElementById('expenseDescription').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        category: document.getElementById('expenseCategory').value,
        date: document.getElementById('expenseDate').value
      };

      expenses.push(newExpense);
      renderExpenses();
      updateFinancialStats();
      this.reset();
      showNotification('Expense added successfully!', 'success');
    });

    function renderExpenses() {
      const listDiv = document.getElementById('expenseList');
      if (expenses.length === 0) {
        listDiv.innerHTML = '<p style="color: #666; text-align: center;">No expenses yet. Track your first expense!</p>';
        return;
      }

      listDiv.innerHTML = expenses.map(expense => `
        <div class="item-row">
          <div class="item-info">
            <div class="item-title">${expense.description} - ¬£${expense.amount.toFixed(2)}</div>
            <div class="item-details">${expense.category} | ${expense.date}</div>
          </div>
          <div class="item-actions">
            <button class="btn-sm" style="background: #dc3545;" onclick="deleteExpense(${expense.id})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function deleteExpense(id) {
      if (confirm('Are you sure you want to delete this expense?')) {
        expenses = expenses.filter(exp => exp.id !== id);
        renderExpenses();
        updateFinancialStats();
        showNotification('Expense deleted successfully!', 'success');
      }
    }

    // Financial Stats Update
    function updateFinancialStats() {
      const totalIncome = invoices
        .filter(inv => inv.status === 'paid')
        .reduce((sum, inv) => sum + inv.amount, 0);
      
      const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
      const netProfit = totalIncome - totalExpenses;
      const estimatedTax = netProfit * 0.20; // 20% tax rate

      document.getElementById('totalIncome').textContent = `¬£${totalIncome.toFixed(2)}`;
      document.getElementById('totalExpenses').textContent = `¬£${totalExpenses.toFixed(2)}`;
      document.getElementById('netProfit').textContent = `¬£${netProfit.toFixed(2)}`;
      document.getElementById('estimatedTax').textContent = `¬£${estimatedTax.toFixed(2)}`;
    }

    // HMRC Tax Rules and Constants (2024/25)
    const TAX_RULES = {
      personalAllowance: 12570,
      personalAllowanceTaperThreshold: 100000,
      basicRateLimit: 50270,
      higherRateLimit: 125140,
      basicRate: 0.20,
      higherRate: 0.40,
      additionalRate: 0.45,
      niClass1Rate: 0.12,
      niClass1ReducedRate: 0.02,
      niClass2Weekly: 3.45,
      niClass2Threshold: 6725,
      niClass4Rate: 0.09,
      niClass4ReducedRate: 0.02,
      corporationSmallRate: 0.19,
      corporationMainRate: 0.25,
      corporationSmallThreshold: 50000,
      corporationMainThreshold: 250000,
      cgtAnnualExemption: 3000,
      cgtBasicRate: 0.10,
      cgtHigherRate: 0.20,
      cgtPropertyBasicRate: 0.18,
      cgtPropertyHigherRate: 0.24,
      vatStandardRate: 0.20,
      vatReducedRate: 0.05,
      vatThreshold: 90000,
      whtRate: 0.20,
      tradingAllowance: 1000,
      propertyAllowance: 1000,
      dividendAllowance: 500,
      dividendBasicRate: 0.0875,
      dividendHigherRate: 0.3375,
      dividendAdditionalRate: 0.3938,
      savingsAllowanceBasic: 1000,
      savingsAllowanceHigher: 500,
      marriageAllowance: 1260,
      pensionAnnualAllowance: 60000,
      studentLoanPlan1Threshold: 22015,
      studentLoanPlan2Threshold: 27295,
      studentLoanPlan4Threshold: 27660,
      studentLoanPostgradThreshold: 21000,
      studentLoanPlan1Rate: 0.09,
      studentLoanPlan2Rate: 0.09,
      studentLoanPlan4Rate: 0.09,
      studentLoanPostgradRate: 0.06
    };

    // Helper function to calculate personal allowance with tapering
    function calculatePersonalAllowance(adjustedIncome) {
      if (adjustedIncome <= TAX_RULES.personalAllowanceTaperThreshold) {
        return TAX_RULES.personalAllowance;
      }
      
      // Taper: reduce by ¬£1 for every ¬£2 over ¬£100,000
      const excessIncome = adjustedIncome - TAX_RULES.personalAllowanceTaperThreshold;
      const reduction = Math.floor(excessIncome / 2);
      const allowance = Math.max(0, TAX_RULES.personalAllowance - reduction);
      
      return allowance;
    }

    // Entity Descriptions
    const ENTITY_DESCRIPTIONS = {
      sole_trader: {
        title: 'Sole Trader / Self-Employed',
        text: 'As a sole trader, you pay Income Tax on your profits and Class 2 and Class 4 National Insurance. You can claim the Trading Allowance (¬£1,000) and various business expenses.'
      },
      company: {
        title: 'Limited Company',
        text: 'Limited companies pay Corporation Tax on profits. Directors can take salary and dividends, with different tax treatments. Consider dividend allowance and tax-efficient salary/dividend mix.'
      },
      landlord: {
        title: 'Landlord / Property Owner',
        text: 'Rental income is subject to Income Tax. You can claim the Property Allowance (¬£1,000) or deduct actual expenses. CGT applies when selling properties.'
      },
      employee: {
        title: 'Employee (PAYE)',
        text: 'Employees pay Income Tax and Class 1 National Insurance through PAYE. You benefit from Personal Allowance and may have additional income requiring Self Assessment.'
      }
    };

    // Entity Type Selection Handler
    function updateTaxCalculator() {
      const entityType = document.getElementById('entityType').value;
      const descDiv = document.getElementById('entityDescription');
      const formDiv = document.getElementById('taxCalculatorForm');
      const fieldsDiv = document.getElementById('dynamicTaxFields');
      
      if (!entityType) {
        descDiv.style.display = 'none';
        formDiv.style.display = 'none';
        return;
      }

      // Show entity description
      const desc = ENTITY_DESCRIPTIONS[entityType];
      document.getElementById('entityDescTitle').textContent = desc.title;
      document.getElementById('entityDescText').textContent = desc.text;
      descDiv.style.display = 'block';
      formDiv.style.display = 'block';

      // Generate dynamic fields based on entity type
      let fieldsHTML = '';
      
      if (entityType === 'sole_trader') {
        fieldsHTML = `
          <div class="form-group">
            <label>Gross Income (¬£)</label>
            <input type="number" id="grossIncome" placeholder="0.00" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Allowable Expenses (¬£)</label>
            <input type="number" id="allowableExpenses" placeholder="0.00" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Use Trading Allowance instead of expenses? (¬£1,000)</label>
            <select id="useTradingAllowance">
              <option value="no">No - Use actual expenses</option>
              <option value="yes">Yes - Claim ¬£1,000 Trading Allowance</option>
            </select>
          </div>
          <div class="form-group">
            <label>Pension Contributions (¬£)</label>
            <input type="number" id="pensionContributions" placeholder="0.00" step="0.01" value="0">
          </div>
          <div class="form-group">
            <label>VAT Registered?</label>
            <select id="vatRegistered">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div class="form-group" id="vatSection" style="display:none;">
            <label>VAT Collected (¬£)</label>
            <input type="number" id="vatCollected" placeholder="0.00" step="0.01" value="0">
          </div>
        `;
      } else if (entityType === 'company') {
        fieldsHTML = `
          <div class="form-group">
            <label>Company Profit Before Tax (¬£)</label>
            <input type="number" id="companyProfit" placeholder="0.00" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Director's Salary (¬£)</label>
            <input type="number" id="directorSalary" placeholder="0.00" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Dividends Taken (¬£)</label>
            <input type="number" id="dividends" placeholder="0.00" step="0.01" required>
          </div>
          <div class="form-group">
            <label>VAT Registered?</label>
            <select id="vatRegistered">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div class="form-group" id="vatSection" style="display:none;">
            <label>VAT Collected (¬£)</label>
            <input type="number" id="vatCollected" placeholder="0.00" step="0.01" value="0">
          </div>
        `;
      } else if (entityType === 'landlord') {
        fieldsHTML = `
          <div class="form-group">
            <label>Rental Income (¬£)</label>
            <input type="number" id="rentalIncome" placeholder="0.00" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Property Expenses (¬£)</label>
            <input type="number" id="propertyExpenses" placeholder="0.00" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Use Property Allowance instead of expenses? (¬£1,000)</label>
            <select id="usePropertyAllowance">
              <option value="no">No - Use actual expenses</option>
              <option value="yes">Yes - Claim ¬£1,000 Property Allowance</option>
            </select>
          </div>
          <div class="form-group">
            <label>Capital Gains from Property Sale (¬£)</label>
            <input type="number" id="capitalGains" placeholder="0.00" step="0.01" value="0">
          </div>
          <div class="form-group">
            <label>Other Income (¬£)</label>
            <input type="number" id="otherIncome" placeholder="0.00" step="0.01" value="0">
          </div>
        `;
      } else if (entityType === 'employee') {
        fieldsHTML = `
          <div class="form-group">
            <label>Annual Gross Salary (¬£)</label>
            <input type="number" id="grossSalary" placeholder="0.00" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Bonus / Commission (¬£)</label>
            <input type="number" id="bonus" placeholder="0.00" step="0.01" value="0">
          </div>
          <div class="form-group">
            <label>Other Income (e.g., rental, dividends) (¬£)</label>
            <input type="number" id="otherIncome" placeholder="0.00" step="0.01" value="0">
          </div>
          <div class="form-group">
            <label>Pension Contributions (¬£)</label>
            <input type="number" id="pensionContributions" placeholder="0.00" step="0.01" value="0">
          </div>
          <div class="form-group">
            <label>Student Loan?</label>
            <select id="studentLoan">
              <option value="none">No Student Loan</option>
              <option value="plan1">Plan 1</option>
              <option value="plan2">Plan 2</option>
              <option value="plan4">Plan 4</option>
              <option value="postgrad">Postgraduate Loan</option>
            </select>
          </div>
        `;
      }

      fieldsDiv.innerHTML = fieldsHTML;

      // Add VAT section toggle listener
      const vatSelect = document.getElementById('vatRegistered');
      if (vatSelect) {
        vatSelect.addEventListener('change', function() {
          const vatSection = document.getElementById('vatSection');
          vatSection.style.display = this.value === 'yes' ? 'block' : 'none';
        });
      }
    }

    // Advanced Tax Form Submission
    document.addEventListener('DOMContentLoaded', function() {
      const taxForm = document.getElementById('advancedTaxForm');
      if (taxForm) {
        taxForm.addEventListener('submit', function(e) {
          e.preventDefault();
          calculateAdvancedTax();
        });
      }
    });

    // Calculate Advanced Tax
    async function calculateAdvancedTax() {
      const entityType = document.getElementById('entityType').value;
      const resultContainer = document.getElementById('resultContainer');
      
      resultContainer.innerHTML = '<p style="color: #666;">Calculating comprehensive tax analysis...</p>';
      
      try {
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        let results = {};
        
        if (entityType === 'sole_trader') {
          results = calculateSoleTraderTax();
        } else if (entityType === 'company') {
          results = calculateCompanyTax();
        } else if (entityType === 'landlord') {
          results = calculateLandlordTax();
        } else if (entityType === 'employee') {
          results = calculateEmployeeTax();
        }

        displayTaxResults(results);
        resultContainer.innerHTML = '<div class="result"><strong>‚úì Tax calculation completed successfully!</strong></div>';
        
      } catch (error) {
        resultContainer.innerHTML = `<div class="error"><strong>Error:</strong> ${error.message}</div>`;
      }
    }

    // Sole Trader Tax Calculation
    function calculateSoleTraderTax() {
      const grossIncome = parseFloat(document.getElementById('grossIncome').value) || 0;
      const allowableExpenses = parseFloat(document.getElementById('allowableExpenses').value) || 0;
      const useTradingAllowance = document.getElementById('useTradingAllowance').value === 'yes';
      const pensionContributions = parseFloat(document.getElementById('pensionContributions').value) || 0;
      const vatRegistered = document.getElementById('vatRegistered').value === 'yes';
      const vatCollected = vatRegistered ? (parseFloat(document.getElementById('vatCollected').value) || 0) : 0;

      const expenses = useTradingAllowance ? TAX_RULES.tradingAllowance : allowableExpenses;
      const profit = grossIncome - expenses;
      const adjustedProfit = Math.max(0, profit - pensionContributions);

      // Income Tax
      const personalAllowance = calculatePersonalAllowance(adjustedProfit);
      const taxableIncome = Math.max(0, adjustedProfit - personalAllowance);
      
      let incomeTax = 0;
      if (taxableIncome > TAX_RULES.higherRateLimit - personalAllowance) {
        const additionalBand = taxableIncome - (TAX_RULES.higherRateLimit - personalAllowance);
        const higherBand = (TAX_RULES.higherRateLimit - personalAllowance) - (TAX_RULES.basicRateLimit - personalAllowance);
        const basicBand = TAX_RULES.basicRateLimit - personalAllowance;
        incomeTax = (basicBand * TAX_RULES.basicRate) + (higherBand * TAX_RULES.higherRate) + (additionalBand * TAX_RULES.additionalRate);
      } else if (taxableIncome > TAX_RULES.basicRateLimit - personalAllowance) {
        const higherBand = taxableIncome - (TAX_RULES.basicRateLimit - personalAllowance);
        const basicBand = TAX_RULES.basicRateLimit - personalAllowance;
        incomeTax = (basicBand * TAX_RULES.basicRate) + (higherBand * TAX_RULES.higherRate);
      } else {
        incomeTax = taxableIncome * TAX_RULES.basicRate;
      }

      // National Insurance Class 2 and 4
      const class2NI = profit > TAX_RULES.niClass2Threshold ? TAX_RULES.niClass2Weekly * 52 : 0;
      
      let class4NI = 0;
      const class4Taxable = Math.max(0, profit - TAX_RULES.personalAllowance);
      if (class4Taxable > TAX_RULES.basicRateLimit - TAX_RULES.personalAllowance) {
        const lowerBand = (TAX_RULES.basicRateLimit - TAX_RULES.personalAllowance) * TAX_RULES.niClass4Rate;
        const upperBand = (class4Taxable - (TAX_RULES.basicRateLimit - TAX_RULES.personalAllowance)) * TAX_RULES.niClass4ReducedRate;
        class4NI = lowerBand + upperBand;
      } else {
        class4NI = class4Taxable * TAX_RULES.niClass4Rate;
      }

      const totalNI = class2NI + class4NI;
      const totalTax = incomeTax + totalNI;
      const netIncome = profit - totalTax;

      const tips = [
        useTradingAllowance ? 'You\'re using the Trading Allowance - consider if actual expenses are higher' : 'Review all allowable business expenses',
        pensionContributions < TAX_RULES.pensionAnnualAllowance ? 'Consider increasing pension contributions for tax relief' : 'Maximizing pension contributions',
        !vatRegistered && grossIncome > TAX_RULES.vatThreshold * 0.8 ? 'Approaching VAT threshold - plan ahead' : '',
        'Keep accurate records of all business income and expenses',
        'Consider incorporation if profits consistently exceed ¬£50,000'
      ].filter(tip => tip);

      return {
        breakdown: [
          { label: 'Gross Income', value: grossIncome },
          { label: 'Less: Expenses', value: -expenses },
          { label: 'Trading Profit', value: profit, highlight: true },
          { label: 'Less: Pension Contributions', value: -pensionContributions },
          { label: 'Adjusted Profit', value: adjustedProfit },
          { label: 'Personal Allowance', value: personalAllowance },
          { label: 'Taxable Income', value: taxableIncome, highlight: true },
          { label: 'Income Tax', value: incomeTax, isTax: true },
          { label: 'Class 2 NI', value: class2NI, isTax: true },
          { label: 'Class 4 NI', value: class4NI, isTax: true },
          { label: 'Total Tax & NI', value: totalTax, highlight: true, isTax: true },
          { label: 'Net Income After Tax', value: netIncome, highlight: true, positive: true }
        ],
        vat: vatRegistered ? { collected: vatCollected, rate: TAX_RULES.vatStandardRate } : null,
        tips: tips
      };
    }

    // Company Tax Calculation
    function calculateCompanyTax() {
      const companyProfit = parseFloat(document.getElementById('companyProfit').value) || 0;
      const directorSalary = parseFloat(document.getElementById('directorSalary').value) || 0;
      const dividends = parseFloat(document.getElementById('dividends').value) || 0;
      const vatRegistered = document.getElementById('vatRegistered').value === 'yes';
      const vatCollected = vatRegistered ? (parseFloat(document.getElementById('vatCollected').value) || 0) : 0;

      // Corporation Tax
      let corporationTax = 0;
      if (companyProfit <= TAX_RULES.corporationSmallThreshold) {
        corporationTax = companyProfit * TAX_RULES.corporationSmallRate;
      } else if (companyProfit >= TAX_RULES.corporationMainThreshold) {
        corporationTax = companyProfit * TAX_RULES.corporationMainRate;
      } else {
        // Marginal relief calculation
        const marginalRate = TAX_RULES.corporationSmallRate + 
          ((companyProfit - TAX_RULES.corporationSmallThreshold) / 
          (TAX_RULES.corporationMainThreshold - TAX_RULES.corporationSmallThreshold)) * 
          (TAX_RULES.corporationMainRate - TAX_RULES.corporationSmallRate);
        corporationTax = companyProfit * marginalRate;
      }

      // Director's PAYE
      const totalIncome = directorSalary + dividends;
      const personalAllowance = calculatePersonalAllowance(totalIncome);
      const taxableSalary = Math.max(0, directorSalary - personalAllowance);
      
      let salaryIncomeTax = 0;
      if (taxableSalary > TAX_RULES.basicRateLimit - personalAllowance) {
        const higherBand = taxableSalary - (TAX_RULES.basicRateLimit - personalAllowance);
        const basicBand = TAX_RULES.basicRateLimit - personalAllowance;
        salaryIncomeTax = (basicBand * TAX_RULES.basicRate) + (higherBand * TAX_RULES.higherRate);
      } else {
        salaryIncomeTax = taxableSalary * TAX_RULES.basicRate;
      }

      // Employee NI (Class 1)
      let employeeNI = 0;
      const niableSalary = Math.max(0, directorSalary - TAX_RULES.personalAllowance);
      if (niableSalary > TAX_RULES.basicRateLimit - TAX_RULES.personalAllowance) {
        const lowerBand = (TAX_RULES.basicRateLimit - TAX_RULES.personalAllowance) * TAX_RULES.niClass1Rate;
        const upperBand = (niableSalary - (TAX_RULES.basicRateLimit - TAX_RULES.personalAllowance)) * TAX_RULES.niClass1ReducedRate;
        employeeNI = lowerBand + upperBand;
      } else {
        employeeNI = niableSalary * TAX_RULES.niClass1Rate;
      }

      // Dividend Tax
      const dividendAllowance = TAX_RULES.dividendAllowance;
      const taxableDividends = Math.max(0, dividends - dividendAllowance);
      
      let dividendTax = 0;
      
      if (totalIncome > TAX_RULES.higherRateLimit) {
        // All dividends taxed at additional rate
        dividendTax = taxableDividends * TAX_RULES.dividendAdditionalRate;
      } else if (totalIncome > TAX_RULES.basicRateLimit) {
        // Some dividends in higher rate, possibly some in additional rate
        const incomeInHigherBand = totalIncome - TAX_RULES.basicRateLimit;
        if (incomeInHigherBand >= taxableDividends) {
          // All dividends in higher rate band
          dividendTax = taxableDividends * TAX_RULES.dividendHigherRate;
        } else {
          // Split between higher and additional rate
          const higherRateDividends = incomeInHigherBand;
          const additionalRateDividends = taxableDividends - higherRateDividends;
          dividendTax = (higherRateDividends * TAX_RULES.dividendHigherRate) + 
                       (additionalRateDividends * TAX_RULES.dividendAdditionalRate);
        }
      } else {
        // Dividends in basic rate, possibly some in higher rate
        const incomeInBasicBand = TAX_RULES.basicRateLimit - (totalIncome - taxableDividends);
        if (incomeInBasicBand >= taxableDividends) {
          // All dividends in basic rate
          dividendTax = taxableDividends * TAX_RULES.dividendBasicRate;
        } else {
          // Split between basic and higher rate
          const basicRateDividends = Math.max(0, incomeInBasicBand);
          const higherRateDividends = taxableDividends - basicRateDividends;
          dividendTax = (basicRateDividends * TAX_RULES.dividendBasicRate) + 
                       (higherRateDividends * TAX_RULES.dividendHigherRate);
        }
      }

      const totalPersonalTax = salaryIncomeTax + employeeNI + dividendTax;
      const totalTax = corporationTax + totalPersonalTax;
      const netIncome = (directorSalary + dividends) - totalPersonalTax;

      const tips = [
        'Optimal salary is around ¬£12,570 (personal allowance) to minimize NI',
        dividends > TAX_RULES.dividendAllowance ? 'Consider timing of dividend payments' : 'You have unused dividend allowance',
        'Employer NI (13.8%) also applies to salary above ¬£9,100',
        'Consider pension contributions through the company for tax efficiency',
        companyProfit > TAX_RULES.corporationMainThreshold ? 'High profit - explore profit extraction strategies' : ''
      ].filter(tip => tip);

      return {
        breakdown: [
          { label: 'Company Profit', value: companyProfit },
          { label: 'Corporation Tax', value: corporationTax, isTax: true },
          { label: 'Profit After Tax', value: companyProfit - corporationTax, highlight: true },
          { label: 'Director\'s Salary', value: directorSalary },
          { label: 'Income Tax on Salary', value: salaryIncomeTax, isTax: true },
          { label: 'Employee NI', value: employeeNI, isTax: true },
          { label: 'Dividends Paid', value: dividends },
          { label: 'Dividend Tax', value: dividendTax, isTax: true },
          { label: 'Total Tax (Corp + Personal)', value: totalTax, highlight: true, isTax: true },
          { label: 'Net Personal Income', value: netIncome, highlight: true, positive: true }
        ],
        vat: vatRegistered ? { collected: vatCollected, rate: TAX_RULES.vatStandardRate } : null,
        tips: tips
      };
    }

    // Landlord Tax Calculation
    function calculateLandlordTax() {
      const rentalIncome = parseFloat(document.getElementById('rentalIncome').value) || 0;
      const propertyExpenses = parseFloat(document.getElementById('propertyExpenses').value) || 0;
      const usePropertyAllowance = document.getElementById('usePropertyAllowance').value === 'yes';
      const capitalGains = parseFloat(document.getElementById('capitalGains').value) || 0;
      const otherIncome = parseFloat(document.getElementById('otherIncome').value) || 0;

      const expenses = usePropertyAllowance ? TAX_RULES.propertyAllowance : propertyExpenses;
      const rentalProfit = Math.max(0, rentalIncome - expenses);
      const totalIncome = rentalProfit + otherIncome;

      // Income Tax on Rental Income
      const personalAllowance = calculatePersonalAllowance(totalIncome);
      const taxableIncome = Math.max(0, totalIncome - personalAllowance);
      
      let incomeTax = 0;
      if (taxableIncome > TAX_RULES.higherRateLimit - personalAllowance) {
        const additionalBand = taxableIncome - (TAX_RULES.higherRateLimit - personalAllowance);
        const higherBand = (TAX_RULES.higherRateLimit - personalAllowance) - (TAX_RULES.basicRateLimit - personalAllowance);
        const basicBand = TAX_RULES.basicRateLimit - personalAllowance;
        incomeTax = (basicBand * TAX_RULES.basicRate) + (higherBand * TAX_RULES.higherRate) + (additionalBand * TAX_RULES.additionalRate);
      } else if (taxableIncome > TAX_RULES.basicRateLimit - personalAllowance) {
        const higherBand = taxableIncome - (TAX_RULES.basicRateLimit - personalAllowance);
        const basicBand = TAX_RULES.basicRateLimit - personalAllowance;
        incomeTax = (basicBand * TAX_RULES.basicRate) + (higherBand * TAX_RULES.higherRate);
      } else {
        incomeTax = taxableIncome * TAX_RULES.basicRate;
      }

      // Capital Gains Tax
      let cgt = 0;
      if (capitalGains > TAX_RULES.cgtAnnualExemption) {
        const taxableGains = capitalGains - TAX_RULES.cgtAnnualExemption;
        const isHigherRate = totalIncome > TAX_RULES.basicRateLimit;
        cgt = taxableGains * (isHigherRate ? TAX_RULES.cgtPropertyHigherRate : TAX_RULES.cgtPropertyBasicRate);
      }

      const totalTax = incomeTax + cgt;
      const netIncome = totalIncome - incomeTax;

      const tips = [
        usePropertyAllowance ? 'You\'re using Property Allowance - check if actual expenses are higher' : 'Keep records of all property expenses',
        capitalGains > 0 ? 'CGT annual exemption is ¬£3,000 - consider timing of property sales' : '',
        'Mortgage interest is no longer fully deductible - only 20% tax credit available',
        'Consider property ownership structure (personal vs company) for tax efficiency',
        'Keep records for at least 5 years after the tax year'
      ].filter(tip => tip);

      return {
        breakdown: [
          { label: 'Rental Income', value: rentalIncome },
          { label: 'Less: Expenses', value: -expenses },
          { label: 'Rental Profit', value: rentalProfit, highlight: true },
          { label: 'Other Income', value: otherIncome },
          { label: 'Total Income', value: totalIncome },
          { label: 'Personal Allowance', value: personalAllowance },
          { label: 'Taxable Income', value: taxableIncome, highlight: true },
          { label: 'Income Tax', value: incomeTax, isTax: true },
          { label: 'Capital Gains', value: capitalGains },
          { label: 'CGT Annual Exemption', value: TAX_RULES.cgtAnnualExemption },
          { label: 'Capital Gains Tax', value: cgt, isTax: true },
          { label: 'Total Tax', value: totalTax, highlight: true, isTax: true },
          { label: 'Net Income After Tax', value: netIncome, highlight: true, positive: true }
        ],
        vat: null,
        tips: tips
      };
    }

    // Employee Tax Calculation
    function calculateEmployeeTax() {
      const grossSalary = parseFloat(document.getElementById('grossSalary').value) || 0;
      const bonus = parseFloat(document.getElementById('bonus').value) || 0;
      const otherIncome = parseFloat(document.getElementById('otherIncome').value) || 0;
      const pensionContributions = parseFloat(document.getElementById('pensionContributions').value) || 0;
      const studentLoan = document.getElementById('studentLoan').value;

      const totalGrossIncome = grossSalary + bonus + otherIncome;
      const adjustedIncome = totalGrossIncome - pensionContributions;

      // Income Tax
      const personalAllowance = calculatePersonalAllowance(adjustedIncome);
      const taxableIncome = Math.max(0, adjustedIncome - personalAllowance);
      
      let incomeTax = 0;
      if (taxableIncome > TAX_RULES.higherRateLimit - personalAllowance) {
        const additionalBand = taxableIncome - (TAX_RULES.higherRateLimit - personalAllowance);
        const higherBand = (TAX_RULES.higherRateLimit - personalAllowance) - (TAX_RULES.basicRateLimit - personalAllowance);
        const basicBand = TAX_RULES.basicRateLimit - personalAllowance;
        incomeTax = (basicBand * TAX_RULES.basicRate) + (higherBand * TAX_RULES.higherRate) + (additionalBand * TAX_RULES.additionalRate);
      } else if (taxableIncome > TAX_RULES.basicRateLimit - personalAllowance) {
        const higherBand = taxableIncome - (TAX_RULES.basicRateLimit - personalAllowance);
        const basicBand = TAX_RULES.basicRateLimit - personalAllowance;
        incomeTax = (basicBand * TAX_RULES.basicRate) + (higherBand * TAX_RULES.higherRate);
      } else {
        incomeTax = taxableIncome * TAX_RULES.basicRate;
      }

      // National Insurance (Class 1)
      let nationalInsurance = 0;
      const niableIncome = Math.max(0, totalGrossIncome - TAX_RULES.personalAllowance);
      if (niableIncome > TAX_RULES.basicRateLimit - TAX_RULES.personalAllowance) {
        const lowerBand = (TAX_RULES.basicRateLimit - TAX_RULES.personalAllowance) * TAX_RULES.niClass1Rate;
        const upperBand = (niableIncome - (TAX_RULES.basicRateLimit - TAX_RULES.personalAllowance)) * TAX_RULES.niClass1ReducedRate;
        nationalInsurance = lowerBand + upperBand;
      } else {
        nationalInsurance = niableIncome * TAX_RULES.niClass1Rate;
      }

      // Student Loan Repayment
      let studentLoanRepayment = 0;
      const studentLoanThresholds = {
        plan1: TAX_RULES.studentLoanPlan1Threshold,
        plan2: TAX_RULES.studentLoanPlan2Threshold,
        plan4: TAX_RULES.studentLoanPlan4Threshold,
        postgrad: TAX_RULES.studentLoanPostgradThreshold
      };
      
      const studentLoanRates = {
        plan1: TAX_RULES.studentLoanPlan1Rate,
        plan2: TAX_RULES.studentLoanPlan2Rate,
        plan4: TAX_RULES.studentLoanPlan4Rate,
        postgrad: TAX_RULES.studentLoanPostgradRate
      };
      
      if (studentLoan !== 'none') {
        const threshold = studentLoanThresholds[studentLoan];
        const rate = studentLoanRates[studentLoan];
        if (totalGrossIncome > threshold) {
          studentLoanRepayment = (totalGrossIncome - threshold) * rate;
        }
      }

      const totalDeductions = incomeTax + nationalInsurance + studentLoanRepayment + pensionContributions;
      const netIncome = totalGrossIncome - totalDeductions;

      const tips = [
        pensionContributions < TAX_RULES.pensionAnnualAllowance ? 'Consider salary sacrifice pension contributions' : 'Maximizing pension contributions',
        otherIncome > 0 ? 'You may need to complete a Self Assessment for additional income' : '',
        bonus > 0 ? 'Bonuses can push you into a higher tax band - consider timing' : '',
        totalGrossIncome > 100000 ? 'Personal allowance tapers above ¬£100k - effective 60% tax rate' : '',
        'Check if you\'re eligible for Marriage Allowance (transfer ¬£1,260)'
      ].filter(tip => tip);

      return {
        breakdown: [
          { label: 'Gross Salary', value: grossSalary },
          { label: 'Bonus/Commission', value: bonus },
          { label: 'Other Income', value: otherIncome },
          { label: 'Total Gross Income', value: totalGrossIncome, highlight: true },
          { label: 'Pension Contributions', value: pensionContributions },
          { label: 'Personal Allowance', value: personalAllowance },
          { label: 'Taxable Income', value: taxableIncome, highlight: true },
          { label: 'Income Tax (PAYE)', value: incomeTax, isTax: true },
          { label: 'National Insurance', value: nationalInsurance, isTax: true },
          { label: 'Student Loan Repayment', value: studentLoanRepayment, isTax: true },
          { label: 'Total Deductions', value: totalDeductions, highlight: true, isTax: true },
          { label: 'Net Take-Home Pay', value: netIncome, highlight: true, positive: true }
        ],
        vat: null,
        tips: tips
      };
    }

    // Display Tax Results
    function displayTaxResults(results) {
      const breakdownDiv = document.getElementById('taxBreakdown');
      const tipsDiv = document.getElementById('tipsList');

      // Display breakdown
      let breakdownHTML = '';
      results.breakdown.forEach(item => {
        const valueClass = item.isTax ? 'metric-value' : (item.positive ? 'metric-value positive' : 'metric-value');
        const rowStyle = item.highlight ? 'font-weight: bold; background: #f0f7ff;' : '';
        breakdownHTML += `
          <div class="tax-metric" style="${rowStyle}">
            <span class="metric-label">${item.label}</span>
            <span class="${valueClass}">¬£${Math.abs(item.value).toFixed(2)}</span>
          </div>
        `;
      });

      // Add VAT section if applicable
      if (results.vat) {
        breakdownHTML += `
          <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
            <h4 style="color: #667eea; margin-bottom: 10px;">VAT Summary</h4>
            <div class="tax-metric">
              <span class="metric-label">VAT Collected (${(results.vat.rate * 100).toFixed(0)}%)</span>
              <span class="metric-value">¬£${results.vat.collected.toFixed(2)}</span>
            </div>
            <div class="tax-metric">
              <span class="metric-label">Net VAT Due (after input VAT)</span>
              <span class="metric-value">Calculate separately</span>
            </div>
          </div>
        `;
      }

      breakdownDiv.innerHTML = breakdownHTML;

      // Display tips
      let tipsHTML = '';
      results.tips.forEach(tip => {
        tipsHTML += `<li>${tip}</li>`;
      });
      tipsDiv.innerHTML = tipsHTML;

      document.getElementById('taxResults').style.display = 'block';
    }

    // Scroll to Tax Rules Section
    function scrollToTaxRules() {
      showSection('tax');
      setTimeout(() => {
        const taxRulesCard = document.querySelector('#taxSection .card:last-child');
        if (taxRulesCard) {
          taxRulesCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
    }

    // Modal Management
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Notifications
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = type === 'success' ? 'result' : 'error';
      notification.textContent = message;
      notification.style.position = 'fixed';
      notification.style.top = '80px';
      notification.style.right = '20px';
      notification.style.zIndex = '3000';
      notification.style.minWidth = '250px';
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Close modal on outside click
    window.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
      }
    });

    // Initialize app on load
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
        </html>
