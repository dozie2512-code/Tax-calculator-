public class UKTaxAccountingApp {

    /* ===================== ENUMS ===================== */

    enum EntityType {
        COMPANY,
        DIRECTOR,
        SOLE_TRADER,
        LANDLORD
    }

    /* ===================== CONFIG (HMRC RULES) ===================== */

    static class TaxConfig {

        // Income Tax
        final double PERSONAL_ALLOWANCE = 12_570;
        final double BASIC_RATE_LIMIT = 50_270;
        final double BASIC_RATE = 0.20;
        final double HIGHER_RATE = 0.40;
        final double ADDITIONAL_RATE = 0.45;

        // Corporation Tax
        final double CORPORATION_TAX_RATE = 0.25;

        // Dividends
        final double DIVIDEND_ALLOWANCE = 1_000;
        final double DIVIDEND_BASIC_RATE = 0.0875;

        // National Insurance (simplified)
        final double EMPLOYEE_NI_RATE = 0.12;
        final double EMPLOYER_NI_RATE = 0.138;

        // VAT
        final double VAT_RATE = 0.20;

        // Pension relief
        final double PENSION_RELIEF_RATE = 0.20;
    }

    /* ===================== FINANCIAL PROFILE ===================== */

    static class FinancialProfile {
        final EntityType entityType;

        double grossIncome;
        double allowableExpenses;
        double pensionContributions;

        // VAT
        double vatSales;
        double vatPurchases;

        // Director
        double salary;
        double dividends;

        FinancialProfile(EntityType entityType) {
            if (entityType == null) {
                throw new IllegalArgumentException("Entity type cannot be null.");
            }
            this.entityType = entityType;
        }
    }

    /* ===================== TAX ENGINE ===================== */

    static class TaxCalculator {

        private final TaxConfig cfg;

        TaxCalculator(TaxConfig cfg) {
            this.cfg = cfg; // Assume config is validated externally
        }

        double calculateTotalTax(FinancialProfile profile) {
            if (profile == null) {
                throw new IllegalArgumentException("FinancialProfile cannot be null.");
            }

            return switch (profile.entityType) {
                case COMPANY -> companyTax(profile);
                case DIRECTOR -> directorTax(profile);
                case SOLE_TRADER -> soleTraderTax(profile);
                case LANDLORD -> landlordTax(profile);
            };
        }

        /* ---------- ENTITY LOGIC ---------- */

        private double companyTax(FinancialProfile profile) {
            double profit =
                    profile.grossIncome
                  - profile.allowableExpenses
                  - profile.salary;

            double corpTax = Math.max(0, profit * cfg.CORPORATION_TAX_RATE);
            return corpTax + vatDue(profile);
        }

        private double directorTax(FinancialProfile profile) {
            double incomeTax = incomeTax(profile.salary);
            double ni = profile.salary * cfg.EMPLOYEE_NI_RATE;
            double dividendTax = dividendTax(profile.dividends);
            return incomeTax + ni + dividendTax;
        }

        private double soleTraderTax(FinancialProfile profile) {
            double taxable =
                    profile.grossIncome
                  - profile.allowableExpenses
                  - profile.pensionContributions;

            return incomeTax(taxable) + taxable * cfg.EMPLOYEE_NI_RATE;
        }

        private double landlordTax(FinancialProfile profile) {
            double rentalProfit = profile.grossIncome - profile.allowableExpenses;
            return incomeTax(rentalProfit);
        }

        /* ---------- COMMON TAX ---------- */

        private double incomeTax(double income) {
            if (income <= cfg.PERSONAL_ALLOWANCE) return 0;

            double taxable = income - cfg.PERSONAL_ALLOWANCE;
            double tax = 0;

            if (taxable <= cfg.BASIC_RATE_LIMIT) {
                tax += taxable * cfg.BASIC_RATE;
            } else {
                tax += cfg.BASIC_RATE_LIMIT * cfg.BASIC_RATE;
                tax += (taxable - cfg.BASIC_RATE_LIMIT) * cfg.HIGHER_RATE;
            }
            return tax;
        }

        private double dividendTax(double dividends) {
            double taxable = Math.max(0, dividends - cfg.DIVIDEND_ALLOWANCE);
            return taxable * cfg.DIVIDEND_BASIC_RATE;
        }

        private double vatDue(FinancialProfile profile) {
            double vat = (profile.vatSales - profile.vatPurchases) * cfg.VAT_RATE;
            return Math.max(0, vat);
        }
    }

    /* ===================== OPTIMISER ===================== */

    static class TaxOptimizer {

        private final TaxCalculator calculator;

        TaxOptimizer(TaxCalculator calculator) {
            this.calculator = calculator;
        }

        FinancialProfile optimiseDirector(FinancialProfile base) {
            double bestTax = Double.MAX_VALUE;
            FinancialProfile best = null;

            for (double salary = 9_000; salary <= 12_570; salary += 500) {
                FinancialProfile test = cloneFinancialProfile(base);
                test.salary = salary;
                test.dividends = base.grossIncome - salary;

                double tax = calculator.calculateTotalTax(test);
                if (tax < bestTax) {
                    bestTax = tax;
                    best = test;
                }
            }
            return best;
        }

        private FinancialProfile cloneFinancialProfile(FinancialProfile profile) {
            FinancialProfile clonedProfile = new FinancialProfile(profile.entityType);
            clonedProfile.grossIncome = profile.grossIncome;
            clonedProfile.allowableExpenses = profile.allowableExpenses;
            clonedProfile.pensionContributions = profile.pensionContributions;
            clonedProfile.vatSales = profile.vatSales;
            clonedProfile.vatPurchases = profile.vatPurchases;
            return clonedProfile;
        }
    }

    /* ===================== DEMO ===================== */

    public static void main(String[] args) {
        TaxConfig config = new TaxConfig();
        TaxCalculator calculator = new TaxCalculator(config);
        TaxOptimizer optimizer = new TaxOptimizer(calculator);

        FinancialProfile directorProfile = new FinancialProfile(EntityType.DIRECTOR);
        directorProfile.grossIncome = 80_000;
        directorProfile.allowableExpenses = 5_000;

        FinancialProfile optimalProfile = optimizer.optimiseDirector(directorProfile);

        System.out.println("Optimised Salary: " + optimalProfile.salary);
        System.out.println("Optimised Dividends: " + optimalProfile.dividends);
        System.out.println("Total Tax: " + calculator.calculateTotalTax(optimalProfile));
    }
}
