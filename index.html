import java.util.List;
import java.util.Scanner;

public class TaxApplication {

    private static final double BASIC_TAX_RATE = 0.20;  // 20%
    private static final double HIGHER_TAX_RATE = 0.40; // 40%
    private static final double ADDITIONAL_TAX_RATE = 0.45; // 45%

    private static final double HIGHER_TAX_THRESHOLD = 50_270; // Higher rate
    private static final double ADDITIONAL_TAX_THRESHOLD = 125_140; // Additional rate

    public static double calculateTax(double income, double expenses, List<UKTaxAllowances.TaxAllowance> applicableAllowances) {
        double taxableIncome = income;

        // Apply all allowances (deduct from taxable income)
        for (UKTaxAllowances.TaxAllowance allowance : applicableAllowances) {
            if (allowance.annualLimit() > 0 && !allowance.requiresClaim()) {
                taxableIncome -= allowance.annualLimit();
            }
        }

        // Deduct user-provided expenses
        taxableIncome -= expenses;

        // Ensure taxable income is not negative
        taxableIncome = Math.max(0, taxableIncome);

        // Calculate tax based on UK rates
        double taxDue = 0.0;

        if (taxableIncome > ADDITIONAL_TAX_THRESHOLD) {
            taxDue += (taxableIncome - ADDITIONAL_TAX_THRESHOLD) * ADDITIONAL_TAX_RATE;
            taxableIncome = ADDITIONAL_TAX_THRESHOLD;
        }

        if (taxableIncome > HIGHER_TAX_THRESHOLD) {
            taxDue += (taxableIncome - HIGHER_TAX_THRESHOLD) * HIGHER_TAX_RATE;
            taxableIncome = HIGHER_TAX_THRESHOLD;
        }

        if (taxableIncome > 12_570) { // Personal Allowance threshold
            taxDue += (taxableIncome - 12_570) * BASIC_TAX_RATE;
        }

        return taxDue;
    }

    public static double calculatePotentialSavings(List<UKTaxAllowances.TaxAllowance> claimableAllowances) {
        return claimableAllowances.stream()
                .filter(a -> a.annualLimit() > 0)
                .mapToDouble(UKTaxAllowances.TaxAllowance::annualLimit)
                .sum();
    }

    public static void main(String[] args) {
        Scanner scanner = new Scanner(System.in);

        System.out.println("=== UK Tax Calculator ===");
        System.out.print("Enter your annual income (£): ");
        double income = scanner.nextDouble();

        System.out.print("Enter your annual expenses (£): ");
        double expenses = scanner.nextDouble();

        System.out.println("\nApplied Allowances:");
        UKTaxAllowances.groupByCategory().forEach((category, allowances) -> {
            System.out.println("- " + category);
            allowances.forEach(allowance -> System.out.printf("  > %s: £%,.2f\n", allowance.name(), allowance.annualLimit()));
        });

        // Select required allowances
        System.out.print("\nWould you like to include all claimable allowances? (yes/no): ");
        boolean includeClaims = scanner.next().equalsIgnoreCase("yes");

        List<UKTaxAllowances.TaxAllowance> claimableAllowances = includeClaims ? UKTaxAllowances.claimRequired() : List.of();

        // Perform calculations
        double taxDue = calculateTax(income, expenses, UKTaxAllowances.ALL);
        double potentialSavings = calculatePotentialSavings(claimableAllowances);

        // Output results
        System.out.println("\n====== Tax Summary ======");
        System.out.printf("Income: £%,.2f\n", income);
        System.out.printf("Expenses: £%,.2f\n", expenses);
        System.out.printf("Income Tax Due: £%,.2f\n", taxDue);
        System.out.printf("Potential Savings: £%,.2f\n", potentialSavings);
        System.out.println("=========================");
    }
}
