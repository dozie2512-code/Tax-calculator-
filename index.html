<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomous Month-End Close - Interactive Prototype</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .card h3 {
            color: #667eea;
            margin: 20px 0 10px 0;
            font-size: 18px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .input-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-high-risk {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-medium-risk {
            background: #fed7aa;
            color: #92400e;
        }
        
        .status-low-risk {
            background: #d1fae5;
            color: #065f46;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        table tr:hover {
            background: #f9fafb;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #666;
            font-weight: 600;
        }
        
        .metric-value {
            color: #333;
            font-weight: 600;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: width 0.5s ease;
        }
        
        .risk-score {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        
        .risk-low { color: #10b981; }
        .risk-medium { color: #f59e0b; }
        .risk-high { color: #ef4444; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .approval-item {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .approval-item h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .approval-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        
        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        .data-entry-area {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .sample-data-btn {
            background: #8b5cf6;
            color: white;
        }
        
        .sample-data-btn:hover {
            background: #7c3aed;
        }
        
        .accordion {
            margin-bottom: 15px;
        }
        
        .accordion-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .accordion-header:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .accordion-header.active {
            background: #5568d3;
            border-radius: 5px 5px 0 0;
        }
        
        .accordion-icon {
            font-size: 20px;
            transition: transform 0.3s;
        }
        
        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            display: none;
            padding: 20px;
            background: #f9fafb;
            border-radius: 0 0 5px 5px;
            border: 1px solid #e5e7eb;
            border-top: none;
        }
        
        .accordion-content.active {
            display: block;
        }
        
        .tax-result {
            background: white;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }
        
        .tax-breakdown {
            margin-top: 15px;
        }
        
        .tax-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .tax-row:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 18px;
            color: #667eea;
            padding-top: 15px;
            border-top: 2px solid #667eea;
        }
        
        .tax-label {
            color: #666;
        }
        
        .tax-value {
            color: #333;
            font-weight: 600;
        }
        
        .info-message {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 12px 15px;
            border-radius: 5px;
            margin: 15px 0;
            color: #1e40af;
        }
        
        /* Authentication and Business Selection Styles */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .auth-card {
            background: white;
            border-radius: 10px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .auth-card h2 {
            margin-bottom: 25px;
            color: #333;
            border-bottom: none;
        }
        
        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .auth-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .auth-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .user-info-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .user-details {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .business-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .business-selector select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .user-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-icon {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f9fafb;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #f3f4f6;
            border-color: #5568d3;
        }
        
        .upload-area.dragover {
            background: #e0e7ff;
            border-color: #667eea;
        }
        
        .file-input {
            display: none;
        }
        
        .transaction-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .summary-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal" style="display: none;">
        <div class="auth-card">
            <h2>Welcome to Tax Calculator</h2>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <div class="input-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter your username">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                <div id="loginError" class="alert alert-danger hidden"></div>
                <button class="btn btn-primary" onclick="handleLogin()" style="width: 100%; margin-top: 10px;">
                    Login
                </button>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="auth-form hidden">
                <div class="input-group">
                    <label>Full Name</label>
                    <input type="text" id="registerFullName" placeholder="Enter your full name">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email">
                </div>
                <div class="input-group">
                    <label>Username</label>
                    <input type="text" id="registerUsername" placeholder="Choose a username">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="registerPassword" placeholder="Choose a password">
                </div>
                <div id="registerError" class="alert alert-danger hidden"></div>
                <div id="registerSuccess" class="alert alert-success hidden"></div>
                <button class="btn btn-primary" onclick="handleRegister()" style="width: 100%; margin-top: 10px;">
                    Register
                </button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>üöÄ Autonomous Month-End Close</h1>
            <p>Interactive browser-based prototype for automated financial close process with reconciliation, accruals, and approval workflows</p>
        </div>
        
        <!-- User Info and Business Selector Bar -->
        <div id="userInfoBar" class="user-info-bar hidden">
            <div class="user-details">
                <div>
                    <strong id="userFullName"></strong>
                    <span style="color: #666; margin-left: 10px;" id="userEmail"></span>
                </div>
                <div class="business-selector">
                    <label style="font-weight: 600;">Business:</label>
                    <select id="businessSelect" onchange="handleBusinessChange()">
                        <option value="">Select a business...</option>
                    </select>
                    <button class="btn btn-secondary btn-icon" onclick="showCreateBusinessModal()">
                        ‚ûï New Business
                    </button>
                </div>
            </div>
            <div class="user-actions">
                <button class="btn btn-secondary btn-icon" onclick="handleLogout()">
                    üö™ Logout
                </button>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('reconciliation')">üîç Reconciliation</button>
            <button class="tab" onclick="showTab('accruals')">üìä Accrual Postings</button>
            <button class="tab" onclick="showTab('statements')">üìà Financial Statements</button>
            <button class="tab" onclick="showTab('close')">üéØ Automated Close</button>
            <button class="tab" onclick="showTab('approval')">‚úÖ Approval Workflow</button>
            <button class="tab" onclick="showTab('uktax')">üá¨üáß UK Tax Computations</button>
        </div>
        
        <!-- Reconciliation Tab -->
        <div id="reconciliation" class="tab-content active">
            <div class="card">
                <h2>Autonomous Reconciliation</h2>
                <p style="color: #666; margin-bottom: 20px;">Automatically match GL transactions with bank statements and identify discrepancies</p>
                
                <div class="data-entry-area">
                    <h3>General Ledger Data</h3>
                    <textarea id="glData" placeholder="Paste CSV data or click 'Load Sample Data'&#10;Format: date,reference,description,amount"></textarea>
                    
                    <h3>Bank Statement Data</h3>
                    <textarea id="bankData" placeholder="Paste CSV data or click 'Load Sample Data'&#10;Format: date,reference,description,amount"></textarea>
                    
                    <button class="btn sample-data-btn" onclick="loadSampleReconciliationData()">Load Sample Data</button>
                    <button class="btn btn-primary" onclick="performReconciliation()">Run Reconciliation</button>
                    <button class="btn btn-secondary" onclick="clearReconciliationData()">Clear</button>
                </div>
                
                <div id="reconciliationResults" class="hidden">
                    <h3>Reconciliation Summary</h3>
                    <div id="reconciliationSummary"></div>
                    
                    <h3>Matched Transactions</h3>
                    <div id="matchedTransactions"></div>
                    
                    <h3>Unmatched GL Transactions</h3>
                    <div id="unmatchedGL"></div>
                    
                    <h3>Unmatched Bank Transactions</h3>
                    <div id="unmatchedBank"></div>
                    
                    <h3>Discrepancies</h3>
                    <div id="discrepancies"></div>
                </div>
            </div>
        </div>
        
        <!-- Accruals Tab -->
        <div id="accruals" class="tab-content">
            <div class="card">
                <h2>Intelligent Accrual Postings</h2>
                <p style="color: #666; margin-bottom: 20px;">Calculate and generate journal entries for interest, depreciation, and expense accruals</p>
                
                <div class="grid">
                    <div class="card" style="box-shadow: none; padding: 15px; background: #f9fafb;">
                        <h3>Interest Accrual</h3>
                        <div class="input-group">
                            <label>Principal Amount (¬£)</label>
                            <input type="number" id="interestPrincipal" value="100000" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Annual Rate (%)</label>
                            <input type="number" id="interestRate" value="5" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Months</label>
                            <input type="number" id="interestMonths" value="1" min="1">
                        </div>
                        <button class="btn btn-primary" onclick="calculateInterest()">Calculate</button>
                    </div>
                    
                    <div class="card" style="box-shadow: none; padding: 15px; background: #f9fafb;">
                        <h3>Depreciation Accrual</h3>
                        <div class="input-group">
                            <label>Asset Cost (¬£)</label>
                            <input type="number" id="assetCost" value="50000" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Salvage Value (¬£)</label>
                            <input type="number" id="salvageValue" value="5000" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Useful Life (Years)</label>
                            <input type="number" id="usefulLife" value="5" min="1">
                        </div>
                        <button class="btn btn-primary" onclick="calculateDepreciation()">Calculate</button>
                    </div>
                    
                    <div class="card" style="box-shadow: none; padding: 15px; background: #f9fafb;">
                        <h3>Expense Accrual</h3>
                        <div class="input-group">
                            <label>Expense Name</label>
                            <input type="text" id="expenseName" value="Insurance">
                        </div>
                        <div class="input-group">
                            <label>Annual Amount (¬£)</label>
                            <input type="number" id="annualAmount" value="12000" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Months</label>
                            <input type="number" id="expenseMonths" value="1" min="1">
                        </div>
                        <button class="btn btn-primary" onclick="calculateExpense()">Calculate</button>
                    </div>
                </div>
                
                <div id="accrualResults" class="hidden">
                    <h3>Generated Journal Entries</h3>
                    <div id="journalEntries"></div>
                    
                    <h3>Summary</h3>
                    <div id="accrualSummary"></div>
                </div>
            </div>
        </div>
        
        <!-- Financial Statements Tab -->
        <div id="statements" class="tab-content">
            <div class="card">
                <h2>Financial Statement Generation</h2>
                <p style="color: #666; margin-bottom: 20px;">Generate P&L, Balance Sheet, and Cash Flow statements from transaction data</p>
                
                <div class="data-entry-area">
                    <h3>Transaction Data</h3>
                    <textarea id="transactionData" placeholder="Paste CSV data or click 'Load Sample Data'&#10;Format: date,account,description,debit,credit"></textarea>
                    
                    <button class="btn sample-data-btn" onclick="loadSampleTransactions()">Load Sample Data</button>
                    <button class="btn btn-primary" onclick="generateStatements()">Generate Statements</button>
                    <button class="btn btn-secondary" onclick="clearTransactionData()">Clear</button>
                </div>
                
                <div id="statementResults" class="hidden">
                    <h3>Profit & Loss Statement</h3>
                    <div id="plStatement"></div>
                    
                    <h3>Balance Sheet</h3>
                    <div id="balanceSheet"></div>
                    
                    <h3>Summary</h3>
                    <div id="statementSummary"></div>
                </div>
            </div>
        </div>
        
        <!-- Automated Close Tab -->
        <div id="close" class="tab-content">
            <div class="card">
                <h2>Automated Close with Risk Scoring</h2>
                <p style="color: #666; margin-bottom: 20px;">Complete month-end close process with risk assessment</p>
                
                <div class="alert alert-warning">
                    ‚ö†Ô∏è Ensure you have completed Reconciliation, Accruals, and Statements tabs before running the automated close.
                </div>
                
                <button class="btn btn-primary" onclick="runAutomatedClose()">Start Automated Close</button>
                
                <div id="closeProgress" class="hidden">
                    <h3>Process Status</h3>
                    <div class="progress-bar">
                        <div id="closeProgressBar" class="progress-fill" style="width: 0%">0%</div>
                    </div>
                    
                    <div id="closeSteps"></div>
                    
                    <h3>Overall Risk Score</h3>
                    <div id="riskScore" class="risk-score">-</div>
                    <div id="riskAssessment"></div>
                </div>
            </div>
        </div>
        
        <!-- Approval Workflow Tab -->
        <div id="approval" class="tab-content">
            <div class="card">
                <h2>Human Approval Workflow</h2>
                <p style="color: #666; margin-bottom: 20px;">Review and approve each component of the month-end close</p>
                
                <div id="approvalItems">
                    <div class="approval-item">
                        <h4>Reconciliation <span id="reconApprovalStatus" class="status-badge status-pending">Pending</span></h4>
                        <p>Review GL vs Bank reconciliation results</p>
                        <div class="input-group">
                            <label>Comments:</label>
                            <textarea id="reconComments" placeholder="Add your review comments..."></textarea>
                        </div>
                        <div class="approval-actions">
                            <button class="btn btn-success" onclick="approveItem('reconciliation')">Approve</button>
                            <button class="btn btn-danger" onclick="rejectItem('reconciliation')">Reject</button>
                        </div>
                    </div>
                    
                    <div class="approval-item">
                        <h4>Accrual Postings <span id="accrualApprovalStatus" class="status-badge status-pending">Pending</span></h4>
                        <p>Review generated journal entries</p>
                        <div class="input-group">
                            <label>Comments:</label>
                            <textarea id="accrualComments" placeholder="Add your review comments..."></textarea>
                        </div>
                        <div class="approval-actions">
                            <button class="btn btn-success" onclick="approveItem('accruals')">Approve</button>
                            <button class="btn btn-danger" onclick="rejectItem('accruals')">Reject</button>
                        </div>
                    </div>
                    
                    <div class="approval-item">
                        <h4>Financial Statements <span id="statementApprovalStatus" class="status-badge status-pending">Pending</span></h4>
                        <p>Review P&L and Balance Sheet</p>
                        <div class="input-group">
                            <label>Comments:</label>
                            <textarea id="statementComments" placeholder="Add your review comments..."></textarea>
                        </div>
                        <div class="approval-actions">
                            <button class="btn btn-success" onclick="approveItem('statements')">Approve</button>
                            <button class="btn btn-danger" onclick="rejectItem('statements')">Reject</button>
                        </div>
                    </div>
                </div>
                
                <h3>Approval History</h3>
                <div id="approvalHistory"></div>
            </div>
        </div>
        
        <!-- UK Tax Computations Tab -->
        <div id="uktax" class="tab-content">
            <div class="card">
                <h2>üá¨üáß UK Tax Summary Computations</h2>
                <p style="color: #666; margin-bottom: 20px;">Calculate various UK taxes including PAYE, Self-Assessment, VAT, and Corporate Tax with real-time computations</p>
                
                <!-- Bank Transaction Upload Section -->
                <div class="accordion">
                    <div class="accordion-header active" onclick="toggleAccordion('banktransactions')">
                        <span>üè¶ Bank Transaction Upload & Categorization</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div id="banktransactions-content" class="accordion-content active">
                        <div class="info-message">
                            üí° <strong>Bank Transaction Import:</strong> Upload your bank statement CSV file to automatically categorize transactions for tax computations. Supported formats: date, description, amount (or debit/credit columns).
                        </div>
                        
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('bankCSVFile').click()">
                            <input type="file" id="bankCSVFile" class="file-input" accept=".csv" onchange="handleBankCSVUpload(event)">
                            <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                            <p style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">
                                Click to upload or drag and drop
                            </p>
                            <p style="color: #666; font-size: 14px;">
                                Bank statement CSV file (date, description, amount)
                            </p>
                        </div>
                        
                        <div id="transactionUploadStatus" class="hidden"></div>
                        
                        <div id="transactionSummarySection" class="hidden">
                            <h3>Transaction Summary</h3>
                            <div id="transactionSummaryCards" class="transaction-summary"></div>
                            
                            <h3>Imported Transactions</h3>
                            <div id="importedTransactionsTable"></div>
                            
                            <div style="margin-top: 20px;">
                                <button class="btn btn-primary" onclick="applyTransactionsToTaxCalc()">
                                    Apply to Tax Calculations
                                </button>
                                <button class="btn btn-secondary" onclick="clearTransactionImport()">
                                    Clear Import
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- PAYE Section -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion('paye')">
                        <span>üíº PAYE (Pay As You Earn)</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div id="paye-content" class="accordion-content">
                        <div class="info-message">
                            üí° <strong>PAYE Information:</strong> Calculate income tax and National Insurance contributions for employees. UK tax rates for 2024/25: Personal Allowance ¬£12,570, Basic rate 20% (¬£12,571-¬£50,270), Higher rate 40% (¬£50,271-¬£125,140), Additional rate 45% (over ¬£125,140).
                        </div>
                        
                        <div class="grid">
                            <div>
                                <div class="input-group">
                                    <label>Annual Gross Salary (¬£)</label>
                                    <input type="number" id="payeGrossSalary" value="45000" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label>Tax Code</label>
                                    <input type="text" id="payeTaxCode" value="1257L">
                                </div>
                                <div class="input-group">
                                    <label>Pension Contribution (%)</label>
                                    <input type="number" id="payePension" value="5" min="0" max="100" step="0.1">
                                </div>
                                <div class="input-group">
                                    <label>Student Loan Plan</label>
                                    <select id="payeStudentLoan">
                                        <option value="none">None</option>
                                        <option value="plan1">Plan 1</option>
                                        <option value="plan2">Plan 2</option>
                                        <option value="plan4">Plan 4</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <div class="input-group">
                                    <label>Pay Period</label>
                                    <select id="payePeriod">
                                        <option value="annual" selected>Annual</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="weekly">Weekly</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>Age</label>
                                    <input type="number" id="payeAge" value="35" min="16" max="100">
                                </div>
                                <button class="btn btn-primary" onclick="calculatePAYE()">Calculate PAYE</button>
                                <button class="btn sample-data-btn" onclick="loadSamplePAYE()">Load Sample</button>
                            </div>
                        </div>
                        
                        <div id="payeResults" class="hidden">
                            <div class="tax-result">
                                <h3>PAYE Calculation Results</h3>
                                <div id="payeBreakdown"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Self-Assessment Tax Section -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion('selfassessment')">
                        <span>üìã Self-Assessment Tax</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div id="selfassessment-content" class="accordion-content">
                        <div class="info-message">
                            üí° <strong>Self-Assessment Information:</strong> Calculate tax liability for self-employed individuals and other income sources. Includes income from freelance work, rental properties, dividends, and savings interest.
                        </div>
                        
                        <div class="grid">
                            <div>
                                <div class="input-group">
                                    <label>Employment Income (¬£)</label>
                                    <input type="number" id="saEmploymentIncome" value="25000" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label>Self-Employment Income (¬£)</label>
                                    <input type="number" id="saSelfEmploymentIncome" value="35000" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label>Rental Income (¬£)</label>
                                    <input type="number" id="saRentalIncome" value="12000" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label>Dividend Income (¬£)</label>
                                    <input type="number" id="saDividendIncome" value="5000" step="0.01">
                                </div>
                            </div>
                            <div>
                                <div class="input-group">
                                    <label>Savings Interest (¬£)</label>
                                    <input type="number" id="saSavingsInterest" value="1500" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label>Allowable Expenses (¬£)</label>
                                    <input type="number" id="saExpenses" value="8000" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label>Pension Contributions (¬£)</label>
                                    <input type="number" id="saPension" value="4000" step="0.01">
                                </div>
                                <button class="btn btn-primary" onclick="calculateSelfAssessment()">Calculate Tax</button>
                                <button class="btn sample-data-btn" onclick="loadSampleSelfAssessment()">Load Sample</button>
                            </div>
                        </div>
                        
                        <div id="saResults" class="hidden">
                            <div class="tax-result">
                                <h3>Self-Assessment Tax Results</h3>
                                <div id="saBreakdown"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- VAT Section -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion('vat')">
                        <span>üßæ VAT (Value Added Tax)</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div id="vat-content" class="accordion-content">
                        <div class="info-message">
                            üí° <strong>VAT Information:</strong> Calculate VAT charges and rebates. Standard UK VAT rate is 20%, reduced rate is 5%, and zero rate is 0%. VAT registration threshold is ¬£85,000.
                        </div>
                        
                        <div class="grid">
                            <div>
                                <h3>VAT Calculation</h3>
                                <div class="input-group">
                                    <label>Calculation Type</label>
                                    <select id="vatCalcType" onchange="updateVATFields()">
                                        <option value="addvat">Add VAT to Net Amount</option>
                                        <option value="removevat">Remove VAT from Gross Amount</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label id="vatAmountLabel">Net Amount (¬£)</label>
                                    <input type="number" id="vatAmount" value="1000" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label>VAT Rate (%)</label>
                                    <select id="vatRate">
                                        <option value="20" selected>Standard - 20%</option>
                                        <option value="5">Reduced - 5%</option>
                                        <option value="0">Zero - 0%</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="calculateVAT()">Calculate VAT</button>
                                <button class="btn sample-data-btn" onclick="loadSampleVAT()">Load Sample</button>
                            </div>
                            <div>
                                <h3>VAT Return Summary</h3>
                                <div class="input-group">
                                    <label>Sales (Output VAT) (¬£)</label>
                                    <input type="number" id="vatSales" value="50000" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label>Purchases (Input VAT) (¬£)</label>
                                    <input type="number" id="vatPurchases" value="30000" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label>VAT Rate for Return (%)</label>
                                    <select id="vatReturnRate">
                                        <option value="20" selected>Standard - 20%</option>
                                        <option value="5">Reduced - 5%</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="calculateVATReturn()">Calculate VAT Return</button>
                            </div>
                        </div>
                        
                        <div id="vatResults" class="hidden">
                            <div class="tax-result">
                                <h3>VAT Calculation Results</h3>
                                <div id="vatBreakdown"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Corporate Tax Section -->
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion('corporatetax')">
                        <span>üè¢ Corporate Tax</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div id="corporatetax-content" class="accordion-content">
                        <div class="info-message">
                            üí° <strong>Corporate Tax Information:</strong> Calculate UK Corporation Tax for limited companies. Main rate is 25% for profits over ¬£250,000, small profits rate is 19% for profits up to ¬£50,000, with marginal relief for profits between ¬£50,000 and ¬£250,000.
                        </div>
                        
                        <div class="grid">
                            <div>
                                <div class="input-group">
                                    <label>Turnover (¬£)</label>
                                    <input type="number" id="ctTurnover" value="500000" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label>Cost of Sales (¬£)</label>
                                    <input type="number" id="ctCostOfSales" value="200000" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label>Operating Expenses (¬£)</label>
                                    <input type="number" id="ctExpenses" value="150000" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label>Other Income (¬£)</label>
                                    <input type="number" id="ctOtherIncome" value="10000" step="0.01">
                                </div>
                            </div>
                            <div>
                                <div class="input-group">
                                    <label>Capital Allowances (¬£)</label>
                                    <input type="number" id="ctCapitalAllowances" value="15000" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label>Accounting Period (months)</label>
                                    <input type="number" id="ctPeriod" value="12" min="1" max="18">
                                </div>
                                <div class="input-group">
                                    <label>Tax Year</label>
                                    <select id="ctTaxYear">
                                        <option value="2024" selected>2024/25</option>
                                        <option value="2023">2023/24</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="calculateCorporateTax()">Calculate Corporation Tax</button>
                                <button class="btn sample-data-btn" onclick="loadSampleCorporateTax()">Load Sample</button>
                            </div>
                        </div>
                        
                        <div id="ctResults" class="hidden">
                            <div class="tax-result">
                                <h3>Corporation Tax Results</h3>
                                <div id="ctBreakdown"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="frontend/api-client.js"></script>
    <script>
        // Global state
        const state = {
            reconciliation: null,
            accruals: [],
            statements: null,
            approvals: {},
            approvalHistory: [],
            currentUser: null,
            currentBusiness: null
        };

        // Tab navigation
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Utility functions
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            
            return data;
        }

        function formatCurrency(amount) {
            return '¬£' + parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function safeFloat(value) {
            const parsed = parseFloat(value);
            return isNaN(parsed) ? 0 : parsed;
        }

        // Reconciliation functions
        function loadSampleReconciliationData() {
            document.getElementById('glData').value = `date,reference,description,amount
2024-12-01,REF001,Customer Payment - ABC Corp,15000.00
2024-12-05,REF002,Supplier Payment - XYZ Ltd,-5000.00
2024-12-10,REF003,Customer Payment - DEF Inc,8500.00
2024-12-15,REF004,Rent Payment,-3000.00
2024-12-20,REF005,Customer Payment - GHI Co,12000.00
2024-12-22,REF006,Utilities Payment,-500.00
2024-12-25,REF007,Sales - JKL Corp,6500.00
2024-12-28,REF008,Equipment Purchase,-8000.00
2024-12-30,REF009,Employee Salaries,-10000.00`;

            document.getElementById('bankData').value = `date,reference,description,amount
2024-12-01,REF001,ABC Corp deposit,15000.00
2024-12-05,REF002,Payment to XYZ Ltd,-5000.00
2024-12-10,REF003,DEF Inc payment,8500.00
2024-12-15,REF004,Rent - December,-3000.00
2024-12-20,REF005,GHI Co transfer,12000.00
2024-12-22,REF006,Utility bill payment,-500.00
2024-12-25,REF007,JKL Corp deposit,6500.00
2024-12-28,REF008,Equipment vendor,-8000.00
2024-12-31,REF010,Interest income,250.00`;
        }

        function clearReconciliationData() {
            document.getElementById('glData').value = '';
            document.getElementById('bankData').value = '';
            document.getElementById('reconciliationResults').classList.add('hidden');
        }

        function performReconciliation() {
            const glData = parseCSV(document.getElementById('glData').value);
            const bankData = parseCSV(document.getElementById('bankData').value);
            
            if (glData.length === 0 || bankData.length === 0) {
                alert('Please enter both GL and Bank data');
                return;
            }
            
            const matched = [];
            const unmatchedGL = [...glData];
            const unmatchedBank = [...bankData];
            const discrepancies = [];
            const tolerance = 0.01;
            
            glData.forEach(glTx => {
                const glAmount = safeFloat(glTx.amount);
                const glDate = glTx.date;
                const glDesc = (glTx.description || '').toLowerCase();
                const glRef = glTx.reference;
                
                let matchFound = false;
                
                for (let i = unmatchedBank.length - 1; i >= 0; i--) {
                    const bankTx = unmatchedBank[i];
                    const bankAmount = safeFloat(bankTx.amount);
                    const bankDate = bankTx.date;
                    const bankDesc = (bankTx.description || '').toLowerCase();
                    const bankRef = bankTx.reference;
                    
                    const amountMatch = Math.abs(glAmount - bankAmount) <= tolerance;
                    const dateMatch = glDate === bankDate;
                    const refMatch = (glRef && glRef === bankRef) || 
                                   (glDesc && bankDesc && glDesc.includes(bankDesc)) ||
                                   (bankDesc && glDesc && bankDesc.includes(glDesc));
                    
                    if (amountMatch && (dateMatch || refMatch)) {
                        matched.push({
                            gl: glTx,
                            bank: bankTx,
                            confidence: dateMatch && refMatch ? 'High' : 'Medium'
                        });
                        
                        const glIndex = unmatchedGL.findIndex(tx => 
                            tx.reference === glTx.reference && tx.amount === glTx.amount
                        );
                        if (glIndex >= 0) unmatchedGL.splice(glIndex, 1);
                        unmatchedBank.splice(i, 1);
                        matchFound = true;
                        break;
                    }
                }
                
                if (!matchFound && glAmount !== 0) {
                    bankData.forEach(bankTx => {
                        const bankAmount = safeFloat(bankTx.amount);
                        if (Math.abs(Math.abs(glAmount) - Math.abs(bankAmount)) < 100 && 
                            Math.abs(glAmount - bankAmount) > tolerance) {
                            discrepancies.push({
                                gl: glTx,
                                bank: bankTx,
                                difference: glAmount - bankAmount
                            });
                        }
                    });
                }
            });
            
            const totalGLAmount = glData.reduce((sum, tx) => sum + safeFloat(tx.amount), 0);
            const totalBankAmount = bankData.reduce((sum, tx) => sum + safeFloat(tx.amount), 0);
            const matchedAmount = matched.reduce((sum, m) => sum + safeFloat(m.gl.amount), 0);
            const reconPercentage = glData.length > 0 ? (matched.length / glData.length * 100).toFixed(2) : 0;
            
            state.reconciliation = {
                matched,
                unmatchedGL,
                unmatchedBank,
                discrepancies,
                summary: {
                    totalGL: glData.length,
                    totalBank: bankData.length,
                    matched: matched.length,
                    unmatchedGL: unmatchedGL.length,
                    unmatchedBank: unmatchedBank.length,
                    discrepancies: discrepancies.length,
                    totalGLAmount,
                    totalBankAmount,
                    matchedAmount,
                    reconPercentage
                }
            };
            
            displayReconciliationResults();
        }

        function displayReconciliationResults() {
            const { matched, unmatchedGL, unmatchedBank, discrepancies, summary } = state.reconciliation;
            
            document.getElementById('reconciliationSummary').innerHTML = `
                <div class="metric"><span class="metric-label">Total GL Transactions:</span><span class="metric-value">${summary.totalGL}</span></div>
                <div class="metric"><span class="metric-label">Total Bank Transactions:</span><span class="metric-value">${summary.totalBank}</span></div>
                <div class="metric"><span class="metric-label">Matched Transactions:</span><span class="metric-value">${summary.matched}</span></div>
                <div class="metric"><span class="metric-label">Unmatched GL:</span><span class="metric-value">${summary.unmatchedGL}</span></div>
                <div class="metric"><span class="metric-label">Unmatched Bank:</span><span class="metric-value">${summary.unmatchedBank}</span></div>
                <div class="metric"><span class="metric-label">Discrepancies:</span><span class="metric-value">${summary.discrepancies}</span></div>
                <div class="metric"><span class="metric-label">Reconciliation Rate:</span><span class="metric-value">${summary.reconPercentage}%</span></div>
                <div class="metric"><span class="metric-label">Total GL Amount:</span><span class="metric-value">${formatCurrency(summary.totalGLAmount)}</span></div>
                <div class="metric"><span class="metric-label">Total Bank Amount:</span><span class="metric-value">${formatCurrency(summary.totalBankAmount)}</span></div>
            `;
            
            document.getElementById('matchedTransactions').innerHTML = matched.length > 0 ? `
                <table>
                    <thead><tr><th>Date</th><th>Reference</th><th>Description</th><th>Amount</th><th>Confidence</th></tr></thead>
                    <tbody>${matched.map(m => `
                        <tr>
                            <td>${m.gl.date}</td>
                            <td>${m.gl.reference}</td>
                            <td>${m.gl.description}</td>
                            <td>${formatCurrency(m.gl.amount)}</td>
                            <td><span class="status-badge status-${m.confidence === 'High' ? 'low-risk' : 'medium-risk'}">${m.confidence}</span></td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>No matched transactions</p>';
            
            document.getElementById('unmatchedGL').innerHTML = unmatchedGL.length > 0 ? `
                <table>
                    <thead><tr><th>Date</th><th>Reference</th><th>Description</th><th>Amount</th></tr></thead>
                    <tbody>${unmatchedGL.map(tx => `
                        <tr>
                            <td>${tx.date}</td>
                            <td>${tx.reference}</td>
                            <td>${tx.description}</td>
                            <td>${formatCurrency(tx.amount)}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>No unmatched GL transactions</p>';
            
            document.getElementById('unmatchedBank').innerHTML = unmatchedBank.length > 0 ? `
                <table>
                    <thead><tr><th>Date</th><th>Reference</th><th>Description</th><th>Amount</th></tr></thead>
                    <tbody>${unmatchedBank.map(tx => `
                        <tr>
                            <td>${tx.date}</td>
                            <td>${tx.reference}</td>
                            <td>${tx.description}</td>
                            <td>${formatCurrency(tx.amount)}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>No unmatched bank transactions</p>';
            
            document.getElementById('discrepancies').innerHTML = discrepancies.length > 0 ? `
                <table>
                    <thead><tr><th>GL Ref</th><th>GL Amount</th><th>Bank Ref</th><th>Bank Amount</th><th>Difference</th></tr></thead>
                    <tbody>${discrepancies.map(d => `
                        <tr>
                            <td>${d.gl.reference}</td>
                            <td>${formatCurrency(d.gl.amount)}</td>
                            <td>${d.bank.reference}</td>
                            <td>${formatCurrency(d.bank.amount)}</td>
                            <td><span class="status-badge status-high-risk">${formatCurrency(d.difference)}</span></td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>No discrepancies found</p>';
            
            document.getElementById('reconciliationResults').classList.remove('hidden');
        }

        // Accrual functions
        function calculateInterest() {
            const principal = safeFloat(document.getElementById('interestPrincipal').value);
            const rate = safeFloat(document.getElementById('interestRate').value) / 100;
            const months = parseInt(document.getElementById('interestMonths').value);
            
            const monthlyRate = rate / 12;
            const amount = principal * monthlyRate * months;
            
            const accrual = {
                type: 'Interest Accrual',
                principal,
                rate: rate * 100,
                months,
                amount: amount.toFixed(2),
                debitAccount: '7200',
                creditAccount: '2300',
                date: new Date().toISOString().split('T')[0]
            };
            
            state.accruals.push(accrual);
            displayAccrualResults();
        }

        function calculateDepreciation() {
            const assetCost = safeFloat(document.getElementById('assetCost').value);
            const salvage = safeFloat(document.getElementById('salvageValue').value);
            const life = parseInt(document.getElementById('usefulLife').value);
            
            const depreciableAmount = assetCost - salvage;
            const annualDepreciation = depreciableAmount / life;
            const monthlyDepreciation = annualDepreciation / 12;
            
            const accrual = {
                type: 'Depreciation Accrual',
                assetCost,
                salvageValue: salvage,
                usefulLife: life,
                amount: monthlyDepreciation.toFixed(2),
                debitAccount: '7100',
                creditAccount: '1500',
                date: new Date().toISOString().split('T')[0]
            };
            
            state.accruals.push(accrual);
            displayAccrualResults();
        }

        function calculateExpense() {
            const name = document.getElementById('expenseName').value;
            const annual = safeFloat(document.getElementById('annualAmount').value);
            const months = parseInt(document.getElementById('expenseMonths').value);
            
            const monthlyAmount = annual / 12;
            const amount = monthlyAmount * months;
            
            const accrual = {
                type: `${name} Accrual`,
                name,
                annualAmount: annual,
                months,
                amount: amount.toFixed(2),
                debitAccount: '6100',
                creditAccount: '2000',
                date: new Date().toISOString().split('T')[0]
            };
            
            state.accruals.push(accrual);
            displayAccrualResults();
        }

        function displayAccrualResults() {
            if (state.accruals.length === 0) return;
            
            const totalDebits = state.accruals.reduce((sum, a) => sum + safeFloat(a.amount), 0);
            const totalCredits = totalDebits;
            const balanced = totalDebits === totalCredits;
            
            document.getElementById('journalEntries').innerHTML = `
                <table>
                    <thead><tr><th>Date</th><th>Type</th><th>Debit Account</th><th>Credit Account</th><th>Amount</th></tr></thead>
                    <tbody>${state.accruals.map(a => `
                        <tr>
                            <td>${a.date}</td>
                            <td>${a.type}</td>
                            <td>${a.debitAccount}</td>
                            <td>${a.creditAccount}</td>
                            <td>${formatCurrency(a.amount)}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            `;
            
            document.getElementById('accrualSummary').innerHTML = `
                <div class="metric"><span class="metric-label">Total Journal Entries:</span><span class="metric-value">${state.accruals.length}</span></div>
                <div class="metric"><span class="metric-label">Total Debits:</span><span class="metric-value">${formatCurrency(totalDebits)}</span></div>
                <div class="metric"><span class="metric-label">Total Credits:</span><span class="metric-value">${formatCurrency(totalCredits)}</span></div>
                <div class="metric"><span class="metric-label">Balanced:</span><span class="metric-value"><span class="status-badge ${balanced ? 'status-approved' : 'status-rejected'}">${balanced ? 'Yes' : 'No'}</span></span></div>
            `;
            
            document.getElementById('accrualResults').classList.remove('hidden');
        }

        // Financial Statements functions
        function loadSampleTransactions() {
            document.getElementById('transactionData').value = `date,account,description,debit,credit
2024-12-01,1000,Cash - Opening Balance,50000.00,0
2024-12-01,3000,Equity - Opening Balance,0,50000.00
2024-12-01,4100,Sales Revenue - ABC Corp,0,15000.00
2024-12-01,1200,Accounts Receivable - ABC,15000.00,0
2024-12-05,5000,Cost of Goods Sold,5000.00,0
2024-12-05,1300,Inventory,0,5000.00
2024-12-05,2000,Accounts Payable - XYZ,0,5000.00
2024-12-05,5000,COGS,5000.00,0
2024-12-10,4100,Sales Revenue - DEF Inc,0,8500.00
2024-12-10,1000,Cash,8500.00,0
2024-12-15,6000,Rent Expense,3000.00,0
2024-12-15,1000,Cash,0,3000.00
2024-12-20,4200,Service Revenue - GHI,0,12000.00
2024-12-20,1200,Accounts Receivable,12000.00,0
2024-12-22,6100,Utilities Expense,500.00,0
2024-12-22,1000,Cash,0,500.00
2024-12-25,4100,Sales Revenue - JKL,0,6500.00
2024-12-25,1000,Cash,6500.00,0
2024-12-28,1500,Equipment,8000.00,0
2024-12-28,1000,Cash,0,8000.00
2024-12-30,6200,Salaries Expense,10000.00,0
2024-12-30,1000,Cash,0,10000.00`;
        }

        function clearTransactionData() {
            document.getElementById('transactionData').value = '';
            document.getElementById('statementResults').classList.add('hidden');
        }

        function generateStatements() {
            const transactions = parseCSV(document.getElementById('transactionData').value);
            
            if (transactions.length === 0) {
                alert('Please enter transaction data');
                return;
            }
            
            const accounts = {};
            
            transactions.forEach(tx => {
                const account = tx.account;
                const debit = safeFloat(tx.debit);
                const credit = safeFloat(tx.credit);
                
                if (!accounts[account]) {
                    accounts[account] = { balance: 0, debits: 0, credits: 0, type: getAccountType(account) };
                }
                
                accounts[account].debits += debit;
                accounts[account].credits += credit;
                
                if (['Asset', 'Expense', 'COGS'].includes(accounts[account].type)) {
                    accounts[account].balance += debit - credit;
                } else {
                    accounts[account].balance += credit - debit;
                }
            });
            
            let revenue = 0, cogs = 0, expenses = 0;
            let assets = 0, liabilities = 0, equity = 0;
            
            const revenueDetails = [], cogsDetails = [], expenseDetails = [];
            const assetDetails = [], liabilityDetails = [], equityDetails = [];
            
            Object.entries(accounts).forEach(([account, data]) => {
                const balance = data.balance;
                
                if (data.type === 'Revenue') {
                    revenue += balance;
                    revenueDetails.push({ account, amount: balance });
                } else if (data.type === 'COGS') {
                    cogs += balance;
                    cogsDetails.push({ account, amount: balance });
                } else if (data.type === 'Expense') {
                    expenses += balance;
                    expenseDetails.push({ account, amount: balance });
                } else if (data.type === 'Asset') {
                    assets += balance;
                    assetDetails.push({ account, amount: balance });
                } else if (data.type === 'Liability') {
                    liabilities += balance;
                    liabilityDetails.push({ account, amount: balance });
                } else if (data.type === 'Equity') {
                    equity += balance;
                    equityDetails.push({ account, amount: balance });
                }
            });
            
            const grossProfit = revenue - cogs;
            const netIncome = grossProfit - expenses;
            const totalEquityWithIncome = equity + netIncome;
            const balanced = Math.abs(assets - (liabilities + totalEquityWithIncome)) < 0.01;
            
            state.statements = {
                pl: { revenue, cogs, expenses, grossProfit, netIncome, revenueDetails, cogsDetails, expenseDetails },
                bs: { assets, liabilities, equity, netIncome, totalEquityWithIncome, balanced, assetDetails, liabilityDetails, equityDetails },
                summary: { revenue, netIncome, assets, balanced }
            };
            
            displayStatementResults();
        }

        function getAccountType(account) {
            const firstChar = account.charAt(0);
            if (firstChar === '1') return 'Asset';
            if (firstChar === '2') return 'Liability';
            if (firstChar === '3') return 'Equity';
            if (firstChar === '4') return 'Revenue';
            if (firstChar === '5') return 'COGS';
            if (firstChar === '6' || firstChar === '7') return 'Expense';
            return 'Unknown';
        }

        function displayStatementResults() {
            const { pl, bs } = state.statements;
            
            document.getElementById('plStatement').innerHTML = `
                <table>
                    <thead><tr><th>Item</th><th>Amount</th></tr></thead>
                    <tbody>
                        <tr><td><strong>Revenue</strong></td><td><strong>${formatCurrency(pl.revenue)}</strong></td></tr>
                        <tr><td>Cost of Goods Sold</td><td>${formatCurrency(pl.cogs)}</td></tr>
                        <tr><td><strong>Gross Profit</strong></td><td><strong>${formatCurrency(pl.grossProfit)}</strong></td></tr>
                        <tr><td>Operating Expenses</td><td>${formatCurrency(pl.expenses)}</td></tr>
                        <tr><td><strong>Net Income</strong></td><td><strong>${formatCurrency(pl.netIncome)}</strong></td></tr>
                    </tbody>
                </table>
            `;
            
            document.getElementById('balanceSheet').innerHTML = `
                <table>
                    <thead><tr><th>Item</th><th>Amount</th></tr></thead>
                    <tbody>
                        <tr><td colspan="2"><strong>Assets</strong></td></tr>
                        <tr><td>Total Assets</td><td>${formatCurrency(bs.assets)}</td></tr>
                        <tr><td colspan="2"><strong>Liabilities</strong></td></tr>
                        <tr><td>Total Liabilities</td><td>${formatCurrency(bs.liabilities)}</td></tr>
                        <tr><td colspan="2"><strong>Equity</strong></td></tr>
                        <tr><td>Opening Equity</td><td>${formatCurrency(bs.equity)}</td></tr>
                        <tr><td>Net Income</td><td>${formatCurrency(bs.netIncome)}</td></tr>
                        <tr><td><strong>Total Equity</strong></td><td><strong>${formatCurrency(bs.totalEquityWithIncome)}</strong></td></tr>
                        <tr><td><strong>Total Liabilities & Equity</strong></td><td><strong>${formatCurrency(bs.liabilities + bs.totalEquityWithIncome)}</strong></td></tr>
                    </tbody>
                </table>
            `;
            
            document.getElementById('statementSummary').innerHTML = `
                <div class="metric"><span class="metric-label">Total Revenue:</span><span class="metric-value">${formatCurrency(pl.revenue)}</span></div>
                <div class="metric"><span class="metric-label">Net Income:</span><span class="metric-value">${formatCurrency(pl.netIncome)}</span></div>
                <div class="metric"><span class="metric-label">Total Assets:</span><span class="metric-value">${formatCurrency(bs.assets)}</span></div>
                <div class="metric"><span class="metric-label">Balance Sheet Balanced:</span><span class="metric-value"><span class="status-badge ${bs.balanced ? 'status-approved' : 'status-rejected'}">${bs.balanced ? 'Yes' : 'No'}</span></span></div>
            `;
            
            document.getElementById('statementResults').classList.remove('hidden');
        }

        // Automated Close functions
        function runAutomatedClose() {
            if (!state.reconciliation || state.accruals.length === 0 || !state.statements) {
                alert('Please complete Reconciliation, Accruals, and Statements tabs first');
                return;
            }
            
            document.getElementById('closeProgress').classList.remove('hidden');
            
            const steps = [
                { name: 'Reconciliation', status: 'completed', risk: calculateReconciliationRisk() },
                { name: 'Accrual Postings', status: 'completed', risk: calculateAccrualRisk() },
                { name: 'Financial Statements', status: 'completed', risk: calculateStatementRisk() },
                { name: 'Final Review', status: 'pending', risk: 'low' }
            ];
            
            let progress = 0;
            const totalSteps = steps.length;
            
            const interval = setInterval(() => {
                progress++;
                const percentage = (progress / totalSteps) * 100;
                document.getElementById('closeProgressBar').style.width = percentage + '%';
                document.getElementById('closeProgressBar').textContent = Math.round(percentage) + '%';
                
                if (progress >= totalSteps) {
                    clearInterval(interval);
                    steps[3].status = 'completed';
                    displayCloseSteps(steps);
                    displayRiskScore(steps);
                } else {
                    displayCloseSteps(steps);
                }
            }, 500);
        }

        function calculateReconciliationRisk() {
            const { summary } = state.reconciliation;
            if (summary.reconPercentage >= 95) return 'low';
            if (summary.reconPercentage >= 80) return 'medium';
            return 'high';
        }

        function calculateAccrualRisk() {
            const totalAmount = state.accruals.reduce((sum, a) => sum + safeFloat(a.amount), 0);
            if (totalAmount < 5000) return 'low';
            if (totalAmount < 10000) return 'medium';
            return 'high';
        }

        function calculateStatementRisk() {
            const { bs } = state.statements;
            return bs.balanced ? 'low' : 'high';
        }

        function displayCloseSteps(steps) {
            document.getElementById('closeSteps').innerHTML = `
                <table>
                    <thead><tr><th>Step</th><th>Status</th><th>Risk Level</th></tr></thead>
                    <tbody>${steps.map(step => `
                        <tr>
                            <td>${step.name}</td>
                            <td><span class="status-badge status-${step.status === 'completed' ? 'approved' : 'pending'}">${step.status.toUpperCase()}</span></td>
                            <td><span class="status-badge status-${step.risk}-risk">${step.risk.toUpperCase()}</span></td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            `;
        }

        function displayRiskScore(steps) {
            const riskScores = { low: 1, medium: 2, high: 3 };
            const totalRisk = steps.reduce((sum, step) => sum + riskScores[step.risk], 0);
            const avgRisk = totalRisk / steps.length;
            
            let overallRisk = 'low';
            let score = 95;
            
            if (avgRisk <= 1.3) {
                overallRisk = 'low';
                score = 95;
            } else if (avgRisk <= 2) {
                overallRisk = 'medium';
                score = 75;
            } else {
                overallRisk = 'high';
                score = 45;
            }
            
            document.getElementById('riskScore').innerHTML = `<span class="risk-${overallRisk}">${score}</span>`;
            document.getElementById('riskScore').className = `risk-score risk-${overallRisk}`;
            
            document.getElementById('riskAssessment').innerHTML = `
                <div class="alert alert-${overallRisk === 'low' ? 'success' : overallRisk === 'medium' ? 'warning' : 'danger'}">
                    <strong>Risk Assessment:</strong> ${overallRisk.toUpperCase()} RISK
                    <br><br>
                    ${overallRisk === 'low' ? '‚úÖ All checks passed. Safe to proceed with approval.' : 
                      overallRisk === 'medium' ? '‚ö†Ô∏è Some issues detected. Review required before approval.' : 
                      'üö® High risk detected. Immediate attention required.'}
                </div>
            `;
        }

        // Approval Workflow functions
        function approveItem(item) {
            const statusIdMap = {
                'reconciliation': 'reconApprovalStatus',
                'accruals': 'accrualApprovalStatus',
                'statements': 'statementApprovalStatus'
            };
            const commentsIdMap = {
                'reconciliation': 'reconComments',
                'accruals': 'accrualComments',
                'statements': 'statementComments'
            };
            
            const statusId = statusIdMap[item];
            const commentsId = commentsIdMap[item];
            
            const status = document.getElementById(statusId);
            if (status) {
                status.className = 'status-badge status-approved';
                status.textContent = 'Approved';
            }
            
            const comments = document.getElementById(commentsId).value;
            
            state.approvals[item] = 'approved';
            state.approvalHistory.push({
                item,
                action: 'approved',
                comments,
                timestamp: new Date().toISOString(),
                user: 'Current User'
            });
            
            updateApprovalHistory();
        }

        function rejectItem(item) {
            const statusIdMap = {
                'reconciliation': 'reconApprovalStatus',
                'accruals': 'accrualApprovalStatus',
                'statements': 'statementApprovalStatus'
            };
            const commentsIdMap = {
                'reconciliation': 'reconComments',
                'accruals': 'accrualComments',
                'statements': 'statementComments'
            };
            
            const statusId = statusIdMap[item];
            const commentsId = commentsIdMap[item];
            
            const status = document.getElementById(statusId);
            if (status) {
                status.className = 'status-badge status-rejected';
                status.textContent = 'Rejected';
            }
            
            const comments = document.getElementById(commentsId).value;
            
            state.approvals[item] = 'rejected';
            state.approvalHistory.push({
                item,
                action: 'rejected',
                comments,
                timestamp: new Date().toISOString(),
                user: 'Current User'
            });
            
            updateApprovalHistory();
        }

        function updateApprovalHistory() {
            const history = state.approvalHistory.reverse();
            
            document.getElementById('approvalHistory').innerHTML = history.length > 0 ? `
                <table>
                    <thead><tr><th>Item</th><th>Action</th><th>User</th><th>Timestamp</th><th>Comments</th></tr></thead>
                    <tbody>${history.map(h => `
                        <tr>
                            <td>${h.item}</td>
                            <td><span class="status-badge status-${h.action === 'approved' ? 'approved' : 'rejected'}">${h.action.toUpperCase()}</span></td>
                            <td>${h.user}</td>
                            <td>${new Date(h.timestamp).toLocaleString()}</td>
                            <td>${h.comments || '-'}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>No approval history yet</p>';
        }

        // UK Tax Computations Functions
        
        // Accordion toggle function
        function toggleAccordion(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const header = content.previousElementSibling;
            
            // Toggle active class
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                header.classList.remove('active');
            } else {
                content.classList.add('active');
                header.classList.add('active');
            }
        }
        
        // PAYE Functions
        function loadSamplePAYE() {
            document.getElementById('payeGrossSalary').value = '45000';
            document.getElementById('payeTaxCode').value = '1257L';
            document.getElementById('payePension').value = '5';
            document.getElementById('payeStudentLoan').value = 'plan2';
            document.getElementById('payePeriod').value = 'annual';
            document.getElementById('payeAge').value = '35';
        }
        
        function calculatePAYE() {
            const grossSalary = safeFloat(document.getElementById('payeGrossSalary').value);
            const taxCode = document.getElementById('payeTaxCode').value;
            const pensionPercent = safeFloat(document.getElementById('payePension').value);
            const studentLoanPlan = document.getElementById('payeStudentLoan').value;
            const period = document.getElementById('payePeriod').value;
            const age = parseInt(document.getElementById('payeAge').value);
            
            // Calculate pension contribution
            const pensionContribution = grossSalary * (pensionPercent / 100);
            const taxableIncome = grossSalary - pensionContribution;
            
            // Extract personal allowance from tax code (1257L = ¬£12,570)
            const personalAllowance = parseInt(taxCode) * 10;
            
            // Calculate taxable amount after personal allowance
            const taxableAfterAllowance = Math.max(0, taxableIncome - personalAllowance);
            
            // UK Tax Bands 2024/25
            const basicRateLimit = 37700; // ¬£50,270 - ¬£12,570
            const higherRateLimit = 112570; // ¬£125,140 - ¬£12,570
            
            let incomeTax = 0;
            let basicRateTax = 0;
            let higherRateTax = 0;
            let additionalRateTax = 0;
            
            // Calculate income tax
            if (taxableAfterAllowance > 0) {
                // Basic rate 20%
                if (taxableAfterAllowance <= basicRateLimit) {
                    basicRateTax = taxableAfterAllowance * 0.20;
                    incomeTax = basicRateTax;
                } else if (taxableAfterAllowance <= higherRateLimit) {
                    basicRateTax = basicRateLimit * 0.20;
                    higherRateTax = (taxableAfterAllowance - basicRateLimit) * 0.40;
                    incomeTax = basicRateTax + higherRateTax;
                } else {
                    basicRateTax = basicRateLimit * 0.20;
                    higherRateTax = (higherRateLimit - basicRateLimit) * 0.40;
                    additionalRateTax = (taxableAfterAllowance - higherRateLimit) * 0.45;
                    incomeTax = basicRateTax + higherRateTax + additionalRateTax;
                }
            }
            
            // Calculate National Insurance
            let nationalInsurance = 0;
            const niPrimary = 12570; // Primary threshold
            const niUpper = 50270; // Upper earnings limit
            
            if (grossSalary > niPrimary) {
                if (grossSalary <= niUpper) {
                    nationalInsurance = (grossSalary - niPrimary) * 0.12;
                } else {
                    nationalInsurance = (niUpper - niPrimary) * 0.12 + (grossSalary - niUpper) * 0.02;
                }
            }
            
            // Calculate Student Loan repayment
            let studentLoan = 0;
            if (studentLoanPlan !== 'none') {
                let threshold = 0;
                let rate = 0.09;
                
                switch(studentLoanPlan) {
                    case 'plan1':
                        threshold = 22015;
                        break;
                    case 'plan2':
                        threshold = 27295;
                        break;
                    case 'plan4':
                        threshold = 27660;
                        break;
                }
                
                if (grossSalary > threshold) {
                    studentLoan = (grossSalary - threshold) * rate;
                }
            }
            
            const totalDeductions = incomeTax + nationalInsurance + studentLoan + pensionContribution;
            const netSalary = grossSalary - totalDeductions;
            
            // Adjust for pay period
            let periodMultiplier = 1;
            let periodLabel = 'Annual';
            if (period === 'monthly') {
                periodMultiplier = 1 / 12;
                periodLabel = 'Monthly';
            } else if (period === 'weekly') {
                periodMultiplier = 1 / 52;
                periodLabel = 'Weekly';
            }
            
            // Display results
            document.getElementById('payeResults').classList.remove('hidden');
            document.getElementById('payeBreakdown').innerHTML = `
                <div class="info-message">
                    <strong>Computation Steps:</strong><br>
                    1. Gross Salary: ${formatCurrency(grossSalary)}<br>
                    2. Pension Contribution (${pensionPercent}%): ${formatCurrency(pensionContribution)}<br>
                    3. Taxable Income: ${formatCurrency(taxableIncome)}<br>
                    4. Personal Allowance (Tax Code ${taxCode}): ${formatCurrency(personalAllowance)}<br>
                    5. Income after allowances: ${formatCurrency(taxableAfterAllowance)}<br>
                    ${basicRateTax > 0 ? `6. Basic Rate Tax (20%): ${formatCurrency(basicRateTax)}<br>` : ''}
                    ${higherRateTax > 0 ? `7. Higher Rate Tax (40%): ${formatCurrency(higherRateTax)}<br>` : ''}
                    ${additionalRateTax > 0 ? `8. Additional Rate Tax (45%): ${formatCurrency(additionalRateTax)}<br>` : ''}
                </div>
                <div class="tax-breakdown">
                    <div class="tax-row">
                        <span class="tax-label">${periodLabel} Gross Salary</span>
                        <span class="tax-value">${formatCurrency(grossSalary * periodMultiplier)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Income Tax</span>
                        <span class="tax-value">${formatCurrency(incomeTax * periodMultiplier)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">National Insurance</span>
                        <span class="tax-value">${formatCurrency(nationalInsurance * periodMultiplier)}</span>
                    </div>
                    ${studentLoan > 0 ? `
                    <div class="tax-row">
                        <span class="tax-label">Student Loan (${studentLoanPlan.toUpperCase()})</span>
                        <span class="tax-value">${formatCurrency(studentLoan * periodMultiplier)}</span>
                    </div>
                    ` : ''}
                    <div class="tax-row">
                        <span class="tax-label">Pension Contribution</span>
                        <span class="tax-value">${formatCurrency(pensionContribution * periodMultiplier)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Total Deductions</span>
                        <span class="tax-value">${formatCurrency(totalDeductions * periodMultiplier)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">${periodLabel} Net Salary</span>
                        <span class="tax-value">${formatCurrency(netSalary * periodMultiplier)}</span>
                    </div>
                </div>
            `;
        }
        
        // Self-Assessment Functions
        function loadSampleSelfAssessment() {
            document.getElementById('saEmploymentIncome').value = '25000';
            document.getElementById('saSelfEmploymentIncome').value = '35000';
            document.getElementById('saRentalIncome').value = '12000';
            document.getElementById('saDividendIncome').value = '5000';
            document.getElementById('saSavingsInterest').value = '1500';
            document.getElementById('saExpenses').value = '8000';
            document.getElementById('saPension').value = '4000';
        }
        
        function calculateSelfAssessment() {
            const employmentIncome = safeFloat(document.getElementById('saEmploymentIncome').value);
            const selfEmploymentIncome = safeFloat(document.getElementById('saSelfEmploymentIncome').value);
            const rentalIncome = safeFloat(document.getElementById('saRentalIncome').value);
            const dividendIncome = safeFloat(document.getElementById('saDividendIncome').value);
            const savingsInterest = safeFloat(document.getElementById('saSavingsInterest').value);
            const expenses = safeFloat(document.getElementById('saExpenses').value);
            const pensionContributions = safeFloat(document.getElementById('saPension').value);
            
            // Calculate total income
            const totalIncome = employmentIncome + selfEmploymentIncome + rentalIncome + dividendIncome + savingsInterest;
            
            // Calculate adjusted income (after expenses and pension)
            const netSelfEmployment = selfEmploymentIncome - expenses;
            const adjustedIncome = employmentIncome + netSelfEmployment + rentalIncome - pensionContributions;
            
            // Personal allowance
            const personalAllowance = 12570;
            const taxableIncome = Math.max(0, adjustedIncome - personalAllowance);
            
            // Calculate income tax on non-savings, non-dividend income
            const basicRateLimit = 37700;
            const higherRateLimit = 112570;
            
            let incomeTax = 0;
            let basicRateTax = 0;
            let higherRateTax = 0;
            let additionalRateTax = 0;
            
            const nonDividendIncome = Math.max(0, adjustedIncome - dividendIncome - savingsInterest - personalAllowance);
            
            if (nonDividendIncome > 0) {
                if (nonDividendIncome <= basicRateLimit) {
                    basicRateTax = nonDividendIncome * 0.20;
                    incomeTax = basicRateTax;
                } else if (nonDividendIncome <= higherRateLimit) {
                    basicRateTax = basicRateLimit * 0.20;
                    higherRateTax = (nonDividendIncome - basicRateLimit) * 0.40;
                    incomeTax = basicRateTax + higherRateTax;
                } else {
                    basicRateTax = basicRateLimit * 0.20;
                    higherRateTax = (higherRateLimit - basicRateLimit) * 0.40;
                    additionalRateTax = (nonDividendIncome - higherRateLimit) * 0.45;
                    incomeTax = basicRateTax + higherRateTax + additionalRateTax;
                }
            }
            
            // Calculate dividend tax (with ¬£500 allowance for 2024/25)
            const dividendAllowance = 500;
            const taxableDividends = Math.max(0, dividendIncome - dividendAllowance);
            let dividendTax = 0;
            
            if (taxableDividends > 0) {
                const usedBasicRate = Math.min(nonDividendIncome, basicRateLimit);
                const remainingBasicRate = Math.max(0, basicRateLimit - usedBasicRate);
                
                if (taxableDividends <= remainingBasicRate) {
                    dividendTax = taxableDividends * 0.0875; // 8.75% basic rate
                } else {
                    dividendTax = remainingBasicRate * 0.0875;
                    const higherRateDividends = Math.min(taxableDividends - remainingBasicRate, higherRateLimit - basicRateLimit);
                    dividendTax += higherRateDividends * 0.3375; // 33.75% higher rate
                    
                    if (taxableDividends > remainingBasicRate + higherRateDividends) {
                        dividendTax += (taxableDividends - remainingBasicRate - higherRateDividends) * 0.3935; // 39.35% additional rate
                    }
                }
            }
            
            // Calculate savings tax (with personal savings allowance)
            let savingsAllowance = 1000;
            if (taxableIncome > higherRateLimit) {
                savingsAllowance = 0;
            } else if (taxableIncome > basicRateLimit) {
                savingsAllowance = 500;
            }
            
            const taxableSavings = Math.max(0, savingsInterest - savingsAllowance);
            let savingsTax = 0;
            
            if (taxableSavings > 0) {
                const usedBasicRate = Math.min(nonDividendIncome, basicRateLimit);
                const remainingBasicRate = Math.max(0, basicRateLimit - usedBasicRate);
                
                if (taxableSavings <= remainingBasicRate) {
                    savingsTax = taxableSavings * 0.20;
                } else {
                    savingsTax = remainingBasicRate * 0.20 + (taxableSavings - remainingBasicRate) * 0.40;
                }
            }
            
            // Calculate Class 2 and Class 4 NI for self-employed
            let class2NI = 0;
            let class4NI = 0;
            
            if (netSelfEmployment > 6725) { // Small profits threshold
                class2NI = 3.45 * 52; // ¬£3.45 per week
            }
            
            if (netSelfEmployment > 12570) {
                const class4Lower = 12570;
                const class4Upper = 50270;
                
                if (netSelfEmployment <= class4Upper) {
                    class4NI = (netSelfEmployment - class4Lower) * 0.09;
                } else {
                    class4NI = (class4Upper - class4Lower) * 0.09 + (netSelfEmployment - class4Upper) * 0.02;
                }
            }
            
            const totalTax = incomeTax + dividendTax + savingsTax;
            const totalNI = class2NI + class4NI;
            const totalLiability = totalTax + totalNI;
            
            // Display results
            document.getElementById('saResults').classList.remove('hidden');
            document.getElementById('saBreakdown').innerHTML = `
                <div class="info-message">
                    <strong>Computation Steps:</strong><br>
                    1. Total Gross Income: ${formatCurrency(totalIncome)}<br>
                    2. Less: Business Expenses: ${formatCurrency(expenses)}<br>
                    3. Less: Pension Contributions: ${formatCurrency(pensionContributions)}<br>
                    4. Adjusted Income: ${formatCurrency(adjustedIncome)}<br>
                    5. Less: Personal Allowance: ${formatCurrency(personalAllowance)}<br>
                    6. Taxable Income: ${formatCurrency(taxableIncome)}<br>
                    7. Tax calculated on different income types at applicable rates
                </div>
                <div class="tax-breakdown">
                    <div class="tax-row">
                        <span class="tax-label">Employment Income</span>
                        <span class="tax-value">${formatCurrency(employmentIncome)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Self-Employment Income (Net)</span>
                        <span class="tax-value">${formatCurrency(netSelfEmployment)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Rental Income</span>
                        <span class="tax-value">${formatCurrency(rentalIncome)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Dividend Income</span>
                        <span class="tax-value">${formatCurrency(dividendIncome)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Savings Interest</span>
                        <span class="tax-value">${formatCurrency(savingsInterest)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Income Tax</span>
                        <span class="tax-value">${formatCurrency(incomeTax)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Dividend Tax</span>
                        <span class="tax-value">${formatCurrency(dividendTax)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Savings Tax</span>
                        <span class="tax-value">${formatCurrency(savingsTax)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Class 2 NI</span>
                        <span class="tax-value">${formatCurrency(class2NI)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Class 4 NI</span>
                        <span class="tax-value">${formatCurrency(class4NI)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Total Tax and NI Liability</span>
                        <span class="tax-value">${formatCurrency(totalLiability)}</span>
                    </div>
                </div>
            `;
        }
        
        // VAT Functions
        function updateVATFields() {
            const calcType = document.getElementById('vatCalcType').value;
            const label = document.getElementById('vatAmountLabel');
            
            if (calcType === 'addvat') {
                label.textContent = 'Net Amount (¬£)';
            } else {
                label.textContent = 'Gross Amount (¬£)';
            }
        }
        
        function loadSampleVAT() {
            document.getElementById('vatCalcType').value = 'addvat';
            document.getElementById('vatAmount').value = '1000';
            document.getElementById('vatRate').value = '20';
            document.getElementById('vatSales').value = '50000';
            document.getElementById('vatPurchases').value = '30000';
            document.getElementById('vatReturnRate').value = '20';
            updateVATFields();
        }
        
        function calculateVAT() {
            const calcType = document.getElementById('vatCalcType').value;
            const amount = safeFloat(document.getElementById('vatAmount').value);
            const vatRate = safeFloat(document.getElementById('vatRate').value) / 100;
            
            let netAmount, vatAmount, grossAmount;
            
            if (calcType === 'addvat') {
                netAmount = amount;
                vatAmount = netAmount * vatRate;
                grossAmount = netAmount + vatAmount;
            } else {
                grossAmount = amount;
                netAmount = grossAmount / (1 + vatRate);
                vatAmount = grossAmount - netAmount;
            }
            
            document.getElementById('vatResults').classList.remove('hidden');
            document.getElementById('vatBreakdown').innerHTML = `
                <div class="info-message">
                    <strong>VAT Computation:</strong><br>
                    ${calcType === 'addvat' ? 
                        `1. Net Amount: ${formatCurrency(netAmount)}<br>
                         2. VAT Rate: ${(vatRate * 100)}%<br>
                         3. VAT Amount: ${formatCurrency(netAmount)} √ó ${(vatRate * 100)}% = ${formatCurrency(vatAmount)}<br>
                         4. Gross Amount: ${formatCurrency(netAmount)} + ${formatCurrency(vatAmount)} = ${formatCurrency(grossAmount)}` :
                        `1. Gross Amount: ${formatCurrency(grossAmount)}<br>
                         2. VAT Rate: ${(vatRate * 100)}%<br>
                         3. Net Amount: ${formatCurrency(grossAmount)} √∑ (1 + ${(vatRate * 100)}%) = ${formatCurrency(netAmount)}<br>
                         4. VAT Amount: ${formatCurrency(grossAmount)} - ${formatCurrency(netAmount)} = ${formatCurrency(vatAmount)}`
                    }
                </div>
                <div class="tax-breakdown">
                    <div class="tax-row">
                        <span class="tax-label">Net Amount (Excluding VAT)</span>
                        <span class="tax-value">${formatCurrency(netAmount)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">VAT Amount (${(vatRate * 100)}%)</span>
                        <span class="tax-value">${formatCurrency(vatAmount)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Gross Amount (Including VAT)</span>
                        <span class="tax-value">${formatCurrency(grossAmount)}</span>
                    </div>
                </div>
            `;
        }
        
        function calculateVATReturn() {
            const sales = safeFloat(document.getElementById('vatSales').value);
            const purchases = safeFloat(document.getElementById('vatPurchases').value);
            const vatRate = safeFloat(document.getElementById('vatReturnRate').value) / 100;
            
            const outputVAT = sales * vatRate;
            const inputVAT = purchases * vatRate;
            const vatDue = outputVAT - inputVAT;
            
            document.getElementById('vatResults').classList.remove('hidden');
            document.getElementById('vatBreakdown').innerHTML = `
                <div class="info-message">
                    <strong>VAT Return Computation:</strong><br>
                    1. Sales (excluding VAT): ${formatCurrency(sales)}<br>
                    2. Output VAT (${(vatRate * 100)}%): ${formatCurrency(sales)} √ó ${(vatRate * 100)}% = ${formatCurrency(outputVAT)}<br>
                    3. Purchases (excluding VAT): ${formatCurrency(purchases)}<br>
                    4. Input VAT (${(vatRate * 100)}%): ${formatCurrency(purchases)} √ó ${(vatRate * 100)}% = ${formatCurrency(inputVAT)}<br>
                    5. VAT ${vatDue >= 0 ? 'Due to HMRC' : 'Refund from HMRC'}: ${formatCurrency(outputVAT)} - ${formatCurrency(inputVAT)} = ${formatCurrency(Math.abs(vatDue))}
                </div>
                <div class="tax-breakdown">
                    <div class="tax-row">
                        <span class="tax-label">Total Sales (Net)</span>
                        <span class="tax-value">${formatCurrency(sales)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Output VAT (VAT on Sales)</span>
                        <span class="tax-value">${formatCurrency(outputVAT)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Total Purchases (Net)</span>
                        <span class="tax-value">${formatCurrency(purchases)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Input VAT (VAT on Purchases)</span>
                        <span class="tax-value">${formatCurrency(inputVAT)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">${vatDue >= 0 ? 'VAT Payable to HMRC' : 'VAT Refund from HMRC'}</span>
                        <span class="tax-value" style="color: ${vatDue >= 0 ? '#ef4444' : '#10b981'}">${formatCurrency(Math.abs(vatDue))}</span>
                    </div>
                </div>
            `;
        }
        
        // Corporate Tax Functions
        function loadSampleCorporateTax() {
            document.getElementById('ctTurnover').value = '500000';
            document.getElementById('ctCostOfSales').value = '200000';
            document.getElementById('ctExpenses').value = '150000';
            document.getElementById('ctOtherIncome').value = '10000';
            document.getElementById('ctCapitalAllowances').value = '15000';
            document.getElementById('ctPeriod').value = '12';
            document.getElementById('ctTaxYear').value = '2024';
        }
        
        function calculateCorporateTax() {
            const turnover = safeFloat(document.getElementById('ctTurnover').value);
            const costOfSales = safeFloat(document.getElementById('ctCostOfSales').value);
            const expenses = safeFloat(document.getElementById('ctExpenses').value);
            const otherIncome = safeFloat(document.getElementById('ctOtherIncome').value);
            const capitalAllowances = safeFloat(document.getElementById('ctCapitalAllowances').value);
            const period = parseInt(document.getElementById('ctPeriod').value);
            const taxYear = document.getElementById('ctTaxYear').value;
            
            // Calculate profit
            const grossProfit = turnover - costOfSales;
            const operatingProfit = grossProfit - expenses + otherIncome;
            const taxableProfit = operatingProfit - capitalAllowances;
            
            // UK Corporation Tax rates 2024/25
            const smallProfitsRate = 0.19; // 19% for profits up to ¬£50,000
            const mainRate = 0.25; // 25% for profits over ¬£250,000
            const lowerLimit = 50000;
            const upperLimit = 250000;
            
            let corporationTax = 0;
            let effectiveRate = 0;
            let taxCalculation = '';
            
            if (taxableProfit <= 0) {
                corporationTax = 0;
                effectiveRate = 0;
                taxCalculation = 'No tax due (loss or zero profit)';
            } else if (taxableProfit <= lowerLimit) {
                // Small profits rate
                corporationTax = taxableProfit * smallProfitsRate;
                effectiveRate = smallProfitsRate;
                taxCalculation = `${formatCurrency(taxableProfit)} √ó 19% = ${formatCurrency(corporationTax)}`;
            } else if (taxableProfit >= upperLimit) {
                // Main rate
                corporationTax = taxableProfit * mainRate;
                effectiveRate = mainRate;
                taxCalculation = `${formatCurrency(taxableProfit)} √ó 25% = ${formatCurrency(corporationTax)}`;
            } else {
                // Marginal relief applies
                const marginalReliefFraction = 0.015; // 3/200
                const marginalRelief = (upperLimit - taxableProfit) * marginalReliefFraction;
                corporationTax = (taxableProfit * mainRate) - marginalRelief;
                effectiveRate = corporationTax / taxableProfit;
                taxCalculation = `${formatCurrency(taxableProfit)} √ó 25% - Marginal Relief ${formatCurrency(marginalRelief)} = ${formatCurrency(corporationTax)}`;
            }
            
            // Adjust for accounting period if not 12 months
            if (period !== 12) {
                corporationTax = corporationTax * (period / 12);
            }
            
            const profitAfterTax = taxableProfit - corporationTax;
            
            document.getElementById('ctResults').classList.remove('hidden');
            document.getElementById('ctBreakdown').innerHTML = `
                <div class="info-message">
                    <strong>Corporation Tax Computation:</strong><br>
                    1. Turnover: ${formatCurrency(turnover)}<br>
                    2. Less: Cost of Sales: ${formatCurrency(costOfSales)}<br>
                    3. Gross Profit: ${formatCurrency(grossProfit)}<br>
                    4. Less: Operating Expenses: ${formatCurrency(expenses)}<br>
                    5. Add: Other Income: ${formatCurrency(otherIncome)}<br>
                    6. Operating Profit: ${formatCurrency(operatingProfit)}<br>
                    7. Less: Capital Allowances: ${formatCurrency(capitalAllowances)}<br>
                    8. Taxable Profit: ${formatCurrency(taxableProfit)}<br>
                    9. Tax Calculation: ${taxCalculation}<br>
                    ${period !== 12 ? `10. Adjusted for ${period} months period<br>` : ''}
                </div>
                <div class="tax-breakdown">
                    <div class="tax-row">
                        <span class="tax-label">Turnover</span>
                        <span class="tax-value">${formatCurrency(turnover)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Gross Profit</span>
                        <span class="tax-value">${formatCurrency(grossProfit)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Operating Profit</span>
                        <span class="tax-value">${formatCurrency(operatingProfit)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Taxable Profit</span>
                        <span class="tax-value">${formatCurrency(taxableProfit)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Effective Tax Rate</span>
                        <span class="tax-value">${(effectiveRate * 100).toFixed(2)}%</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Corporation Tax Liability</span>
                        <span class="tax-value">${formatCurrency(corporationTax)}</span>
                    </div>
                    <div class="tax-row">
                        <span class="tax-label">Profit After Tax</span>
                        <span class="tax-value">${formatCurrency(profitAfterTax)}</span>
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // Authentication and Business Management Functions
        // ==========================================
        
        function initializeApp() {
            // Check if user is logged in
            if (taxCalcAPI.isLoggedIn()) {
                const user = taxCalcAPI.getCurrentUser();
                if (user) {
                    state.currentUser = user;
                    showUserInterface();
                    loadUserBusinesses();
                } else {
                    showAuthModal();
                }
            } else {
                showAuthModal();
            }
        }
        
        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('userInfoBar').classList.add('hidden');
        }
        
        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }
        
        function showUserInterface() {
            hideAuthModal();
            document.getElementById('userInfoBar').classList.remove('hidden');
            document.getElementById('userFullName').textContent = state.currentUser.full_name || state.currentUser.username;
            document.getElementById('userEmail').textContent = state.currentUser.email;
        }
        
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const authTabs = document.querySelectorAll('.auth-tab');
            
            authTabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                authTabs[0].classList.add('active');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                authTabs[1].classList.add('active');
            }
        }
        
        function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            const result = taxCalcAPI.login(username, password);
            
            if (result.success) {
                state.currentUser = result.user;
                showUserInterface();
                loadUserBusinesses();
                
                // Clear form
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                errorDiv.classList.add('hidden');
            } else {
                errorDiv.textContent = result.error;
                errorDiv.classList.remove('hidden');
            }
        }
        
        function handleRegister() {
            const fullName = document.getElementById('registerFullName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const errorDiv = document.getElementById('registerError');
            const successDiv = document.getElementById('registerSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            if (!fullName || !email || !username || !password) {
                errorDiv.textContent = 'Please fill in all fields';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            const result = taxCalcAPI.register(username, password, email, fullName);
            
            if (result.success) {
                successDiv.textContent = 'Registration successful! Please login.';
                successDiv.classList.remove('hidden');
                
                // Clear form
                document.getElementById('registerFullName').value = '';
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerPassword').value = '';
                
                // Switch to login tab after 2 seconds
                setTimeout(() => {
                    switchAuthTab('login');
                    successDiv.classList.add('hidden');
                }, 2000);
            } else {
                errorDiv.textContent = result.error;
                errorDiv.classList.remove('hidden');
            }
        }
        
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                taxCalcAPI.logout();
                state.currentUser = null;
                state.currentBusiness = null;
                showAuthModal();
                
                // Clear business selector
                document.getElementById('businessSelect').innerHTML = '<option value="">Select a business...</option>';
            }
        }
        
        function loadUserBusinesses() {
            const result = taxCalcAPI.getUserBusinesses();
            
            if (result.success) {
                const select = document.getElementById('businessSelect');
                select.innerHTML = '<option value="">Select a business...</option>';
                
                result.businesses.forEach(business => {
                    const option = document.createElement('option');
                    option.value = business.business_id;
                    option.textContent = `${business.name} (${business.business_type})`;
                    select.appendChild(option);
                });
                
                // Auto-select first business if available
                if (result.businesses.length > 0) {
                    select.value = result.businesses[0].business_id;
                    handleBusinessChange();
                }
            }
        }
        
        function handleBusinessChange() {
            const businessId = document.getElementById('businessSelect').value;
            
            if (businessId) {
                const result = taxCalcAPI.getBusiness(businessId);
                if (result.success) {
                    state.currentBusiness = result.business;
                }
            } else {
                state.currentBusiness = null;
            }
        }
        
        function showCreateBusinessModal() {
            const name = prompt('Enter business name:');
            if (!name) return;
            
            const type = prompt('Enter business type (e.g., Sole Trader, Limited Company):', 'Sole Trader');
            if (!type) return;
            
            const result = taxCalcAPI.createBusiness(name, type);
            
            if (result.success) {
                alert('Business created successfully!');
                loadUserBusinesses();
            } else {
                alert('Error creating business: ' + result.error);
            }
        }
        
        // ==========================================
        // Bank Transaction Upload Functions
        // ==========================================
        
        let uploadedTransactions = [];
        
        function handleBankCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if business is selected
            if (!state.currentBusiness) {
                alert('Please select a business first');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvContent = e.target.result;
                uploadBankTransactions(csvContent);
            };
            reader.readAsText(file);
        }
        
        function uploadBankTransactions(csvContent) {
            const statusDiv = document.getElementById('transactionUploadStatus');
            
            const result = taxCalcAPI.uploadBankTransactions(
                state.currentBusiness.business_id,
                csvContent
            );
            
            if (result.success) {
                uploadedTransactions = result.transactions;
                
                // Show success message
                statusDiv.className = 'alert alert-success';
                statusDiv.textContent = `Successfully imported ${result.transactions_count} transactions`;
                statusDiv.classList.remove('hidden');
                
                // Display summary
                displayTransactionSummary(result.summary, result.transactions);
                
                // Hide after 5 seconds
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            } else {
                statusDiv.className = 'alert alert-danger';
                statusDiv.textContent = 'Error: ' + result.error;
                statusDiv.classList.remove('hidden');
            }
        }
        
        function displayTransactionSummary(summary, transactions) {
            const summarySection = document.getElementById('transactionSummarySection');
            const summaryCards = document.getElementById('transactionSummaryCards');
            const tableDiv = document.getElementById('importedTransactionsTable');
            
            // Create summary cards
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <div class="summary-label">Total Transactions</div>
                    <div class="summary-value">${summary.total_transactions}</div>
                </div>
                <div class="summary-card" style="border-left-color: #10b981;">
                    <div class="summary-label">Total Income</div>
                    <div class="summary-value" style="color: #10b981;">${formatCurrency(summary.total_income)}</div>
                </div>
                <div class="summary-card" style="border-left-color: #ef4444;">
                    <div class="summary-label">Total Expenses</div>
                    <div class="summary-value" style="color: #ef4444;">${formatCurrency(summary.total_expenses)}</div>
                </div>
                <div class="summary-card" style="border-left-color: #f59e0b;">
                    <div class="summary-label">Net Amount</div>
                    <div class="summary-value" style="color: #f59e0b;">${formatCurrency(summary.net_amount)}</div>
                </div>
            `;
            
            // Create transaction table
            tableDiv.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map(tx => `
                            <tr>
                                <td>${tx.date}</td>
                                <td>${tx.description}</td>
                                <td style="color: ${tx.amount >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">
                                    ${formatCurrency(tx.amount)}
                                </td>
                                <td>
                                    <span class="status-badge status-${tx.amount >= 0 ? 'low-risk' : 'pending'}">
                                        ${tx.category}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            summarySection.classList.remove('hidden');
        }
        
        function applyTransactionsToTaxCalc() {
            if (uploadedTransactions.length === 0) {
                alert('No transactions to apply');
                return;
            }
            
            // Calculate totals by category for tax forms
            const categoryTotals = {};
            uploadedTransactions.forEach(tx => {
                if (!categoryTotals[tx.category]) {
                    categoryTotals[tx.category] = 0;
                }
                categoryTotals[tx.category] += tx.amount;
            });
            
            // Auto-fill Self-Assessment form with transaction data
            const salesTotal = (categoryTotals['Sales'] || 0) + (categoryTotals['Interest Income'] || 0);
            const expensesTotal = Math.abs(Object.entries(categoryTotals)
                .filter(([cat, amount]) => amount < 0 && !cat.includes('Tax'))
                .reduce((sum, [cat, amount]) => sum + amount, 0));
            
            if (salesTotal > 0) {
                document.getElementById('saSelfEmploymentIncome').value = salesTotal;
            }
            if (expensesTotal > 0) {
                document.getElementById('saExpenses').value = expensesTotal;
            }
            
            // Expand Self-Assessment section
            const saContent = document.getElementById('selfassessment-content');
            const saHeader = saContent.previousElementSibling;
            saContent.classList.add('active');
            saHeader.classList.add('active');
            
            alert(`Applied transaction data to tax calculations:\n\nIncome: ${formatCurrency(salesTotal)}\nExpenses: ${formatCurrency(expensesTotal)}\n\nPlease review and adjust as needed.`);
        }
        
        function clearTransactionImport() {
            uploadedTransactions = [];
            document.getElementById('transactionSummarySection').classList.add('hidden');
            document.getElementById('transactionUploadStatus').classList.add('hidden');
            document.getElementById('bankCSVFile').value = '';
        }
        
        // Drag and drop support
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.csv')) {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        uploadBankTransactions(ev.target.result);
                    };
                    reader.readAsText(file);
                }
            });
        }
        
        // Initialize app on page load
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
                                </html>
